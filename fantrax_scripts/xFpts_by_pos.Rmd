---
title: "xFpts"
author: "Christopher Adams"
date: "6/10/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggplot2)
library(ggrepel)
```

## Data setup

```{r data_setup}
#load all player data for fbref.com
weekly_data_csv = "../data/fantrax_data/weekly.all_data_combined.no_double_gws.csv"
yearly_data_csv = "../data/fantrax_data/yearly.all_data_combined.csv"

weekly_data_df <- read_csv(file = weekly_data_csv, col_names = TRUE)
yearly_data_df <- read_csv(file = yearly_data_csv, col_names = TRUE)

# Only weeks where at least 60 minutes are played
min_60_min_df <- weekly_data_df[weekly_data_df$Min > 59,]
# Players that have started at least 5 games
summary_min_60_df <- min_60_min_df %>% 
  group_by(Player, Team, Position) %>%
  summarize(n = n(), min_total = sum(Min), sd = sd(FPts), mean = mean(FPts), total_fpts = sum(FPts), mean_minutes = mean(Min))

#only players with at least 5 starts
players_min_5_starts_summary_df <- summary_min_60_df[summary_min_60_df$n >= 5,]

player_min_5_starts_weekly_df <- min_60_min_df %>%
  filter(Player %in% players_min_5_starts_summary_df$Player)
nrow(player_min_5_starts_weekly_df)


```

## get xFpts

```{r gather_xfpt_df}


# load in just defenders
players_min_starts.defenders = players_min_5_starts_summary_df[players_min_5_starts_summary_df$Position == 'D',]
nrow(players_min_starts.defenders)
def_player_list <- players_min_starts.defenders$Player
length(def_player_list)

defenders_fbref_df <- read_csv('../data/fantrax_data/Def_min5starts.csv')
#clean sheet data
cs_df <- read_csv('../data/fantrax_data/game_results.csv')

#parse round into game week
defenders_fbref_df$game_week <- sapply(strsplit(defenders_fbref_df$Round, " "), function(x) (x[2]))

#merge on player and game week
defenders_min60_merged_df <- merge(min_60_min_df, defenders_fbref_df, by=c('Player', 'game_week'))

#just get the important stuff for clean sheets
all_cs_data_df <- data.frame('Squad' = c(cs_df$Home, cs_df$Away), 'xG_against' = c(cs_df$xG_1, cs_df$xG), 'game_week' = c(cs_df$Wk, cs_df$Wk))

#merge cs and defender data
defenders_min60_merged_cs_df <- merge(defenders_min60_merged_df, all_cs_data_df, by=c('Squad', 'game_week'))

#calculate xFpts from cs given xG against
defenders_min60_merged_cs_df$GAD_against <- ifelse(defenders_min60_merged_cs_df$xG_against - 0.25 < 0, 0, defenders_min60_merged_cs_df$xG_against - 0.25)

defenders_min60_merged_cs_df$normed_xg_against <- ifelse(defenders_min60_merged_cs_df$GAD_against <= 1.25, 1 - defenders_min60_merged_cs_df$GAD_against/1.25, 0)

#just defenders filter
defenders_min60_min600_merged_df <- defenders_min60_merged_cs_df %>%
  filter(Player %in% def_player_list)

#calculate xFpts for defenders
defenders_min60_merged_cs_df$xPts <- defenders_min60_merged_cs_df$FPts - (defenders_min60_merged_cs_df$G * 10 + defenders_min60_merged_cs_df$AT * 8 + defenders_min60_merged_cs_df$CS * 6 + defenders_min60_merged_cs_df$GAD * -2) + (as.numeric(defenders_min60_merged_cs_df$xG)* 10 + as.numeric(defenders_min60_merged_cs_df$xA) * 8 + as.numeric(defenders_min60_merged_cs_df$normed_xg_against)* 6 + as.numeric(defenders_min60_merged_cs_df$GAD_against) * -2)

#remove some extra defender columns
drops <- c("normed_xg_against","GAD_against", 'xG_against')
defenders_min60_merged_cs_df <- defenders_min60_merged_cs_df[ , !(names(defenders_min60_merged_cs_df) %in% drops)]

# midfielders

#load in just midfielders
players_min_starts.midfielders = players_min_5_starts_summary_df[players_min_5_starts_summary_df$Position == 'M',]
nrow(players_min_starts.midfielders)
mid_player_list <- players_min_starts.midfielders$Player

mids_fbref_df <- read_csv('../data/fantrax_data/Mid_min5starts.csv')

#parse round into game week
mids_fbref_df$game_week <- sapply(strsplit(mids_fbref_df$Round, " "), function(x) (x[2]))

#merge on player and game week
mids_min60_merged_df <- merge(min_60_min_df, mids_fbref_df, by=c('Player', 'game_week'))

#just a test to make sure nothing weird happend to the names
i <- mid_player_list %in% unique(mids_min60_merged_df$Player)
mid_player_list[!i]

# filter on the player names
mids_min60_min600_merged_df <- mids_min60_merged_df %>%
  filter(Player %in% mid_player_list)

#calculate xFpts for midfielders
mids_min60_merged_df$xPts <- mids_min60_merged_df$FPts - (mids_min60_merged_df$G * 9 + mids_min60_merged_df$AT * 6)
mids_min60_merged_df$xPts <- mids_min60_merged_df$xPts + (as.numeric(mids_min60_merged_df$xG)* 9 + as.numeric(mids_min60_merged_df$xA) * 6)

# forwards

#load in just forwards
players_min_starts.forwards = players_min_5_starts_summary_df[players_min_5_starts_summary_df$Position == 'F',]
nrow(players_min_starts.forwards)

for_player_list <- players_min_starts.forwards$Player

fwds_fbref_df <- read_csv('../data/fantrax_data/For_min5starts.csv')

#parse round into game week
fwds_fbref_df$game_week <- sapply(strsplit(fwds_fbref_df$Round, " "), function(x) (x[2]))

#merge on player and game week
fwds_min60_merged_df <- merge(min_60_min_df, fwds_fbref_df, by=c('Player', 'game_week'))

#filter on forward player list
fwds_min60_min600_merged_df <- fwds_min60_merged_df %>%
  filter(Player %in% for_player_list)

#calculate xFpts for forwards
fwds_min60_merged_df$xPts <- fwds_min60_merged_df$FPts - (fwds_min60_merged_df$G * 9 + fwds_min60_merged_df$AT * 6)
fwds_min60_merged_df$xPts <- fwds_min60_merged_df$xPts + (as.numeric(fwds_min60_merged_df$xG)* 9 + as.numeric(fwds_min60_merged_df$xA) * 6)

names(fwds_min60_merged_df)

#combine all the position dataframes into one
all_combined_df <- rbind(defenders_min60_merged_cs_df, fwds_min60_merged_df, mids_min60_merged_df)
```

#collect the data for with team postion information
```{r}
#make a summary file
summary_all_combined_df <- all_combined_df %>% 
  group_by(Team, Pos) %>%
  summarize(n = n(), num_diff_players = length(unique(Player)) , min_total = sum(Min.x), sd_emp_pts = sd(FPts), sd_xpts = sd(xPts),   mean_emp_pts = mean(FPts), mean_xPts = mean(xPts), med_emp_pts= median(FPts), med_xPts = median(xPts), total_emp_fpts = sum(FPts),   total_xPts = sum(xPts), mean_minutes = mean(Min.x))

#remove team positions that do not have at least 10 occurances (mainly to remove the double position entries)
min_10_examples <- summary_all_combined_df[summary_all_combined_df$n >= 10,]

min_10_examples$Team_Pos <- paste(min_10_examples$Team, min_10_examples$Pos, sep = "_")

#write to file
write.csv(x=min_10_examples, file="../data/fantrax_data/pos_group.csv")


# collecting the team position data but keep the players
all_combined_Team_Pos <- all_combined_df
all_combined_Team_Pos$Team_Pos <- paste(all_combined_df$Team, all_combined_df$Pos, sep = "_")

dim(all_combined_Team_Pos)
#[1] 5291  130

#filter out any team positions that have not occurred 10 times
all_combined_Team_Pos_min_10 <- all_combined_Team_Pos %>% group_by(Team_Pos) %>% filter(n()>= 10)


dim(all_combined_Team_Pos_min_10)
#[1] 4482  130

length(unique(all_combined_Team_Pos_min_10$Team_Pos))
#[1] 147

#try plotting it by team position
#xFpts plot
ggplot(all_combined_Team_Pos_min_10, aes(x = reorder(Team_Pos, xPts, FUN = median ), y = xPts)) + geom_boxplot()  + theme_minimal() + theme(axis.text.x = element_text(angle = 90)) +ggtitle("xFpts for Team Positions")

#Fpts plot
ggplot(all_combined_Team_Pos_min_10, aes(x = reorder(Team_Pos, FPts, FUN = median ), y = FPts)) + geom_boxplot()  + theme_minimal() + theme(axis.text.x = element_text(angle = 90)) +ggtitle("Fpts for Team Positions")
```


#test if there are positions where it doesn't matter which player is actually playing
```{r}
#require that 2 or more separate players have played the position (in order to 
all_combined_Team_Pos_min_10_players_2 <- all_combined_Team_Pos_min_10 %>% group_by(Team_Pos) %>% filter(length(unique(Player)) > 1)

dim(all_combined_Team_Pos_min_10_players_2)
#[1] 4328  130

length(unique(all_combined_Team_Pos_min_10_players_2$Team_Pos))
#[1] 140

ggplot(all_combined_Team_Pos_min_10_players_2, aes(x = reorder(Team_Pos, xPts, FUN = median ), y = xPts)) + geom_boxplot()  + theme_minimal() + theme(axis.text.x = element_text(angle = 90)) +ggtitle("xFpts for Team Positions")

#Fpts plot
ggplot(all_combined_Team_Pos_min_10_players_2, aes(x = reorder(Team_Pos, FPts, FUN = median ), y = FPts)) + geom_boxplot()  + theme_minimal() + theme(axis.text.x = element_text(angle = 90)) +ggtitle("Fpts for Team Positions")

#test the statistic for just 1 example

team_pos_vec <- unique(all_combined_Team_Pos_min_10_players_2$Team_Pos)

team_pos <- team_pos_vec[1]

team_pos_player <- all_combined_Team_Pos_min_10_players_2[all_combined_Team_Pos_min_10_players_2$Team_Pos == team_pos,]

k_test <- kruskal.test(xPts ~ Player, data = team_pos_player) 

#check if the Kruskal-Wallis test is close to significant
bool_signif <- k_test$p.value < 0.05
```

#loop through the team positions and run Kruskal-Wallis test (non-parametric one way ANOVA) on each
```{r}

team_pos_vec <- unique(all_combined_Team_Pos_min_10_players_2$Team_Pos)

#length of the team_pos_vec
n = length(team_pos_vec)

#initiate a vector to save the boolean of whether the Kruskal-Wallis test was significant for each position (test of whether the player distributions seem to be the same)
sigKWTestList <- vector(mode= "list", length= n)

#for each team position
for(t in 1:length(team_pos_vec)){
  
  print(team_pos_vec[t])
  
  #set team_pos
  team_pos <- team_pos_vec[t]
  
  #filter all_combined_Team_Pos_min_10_players_2 to just the entries of players with this team_pos
  team_pos_player <- all_combined_Team_Pos_min_10_players_2[all_combined_Team_Pos_min_10_players_2$Team_Pos == team_pos,]
  
  k_test <- kruskal.test(xPts ~ Player, data = team_pos_player)
  print(k_test$p.value)

  #check if the Kruskal-Wallis test is close to bonferroni significant
  bool_signif <- k_test$p.value < 0.05
  
  #write the team pos test significance to the list
  sigKWTestList[[t]] <- bool_signif
}

#make the list into a vector
sigKWTestVec <- unlist(sigKWTestList)


#players seem to be distributed differently for these team distributions

team_pos_vec[sigKWTestVec]
# [1] "ARS_RB" "CRY_CM" "MCI_CB" "MUN_CB" "NOR_CB" "WOL_CB" "WOL_WB" "NEW_CM" "NEW_AM" "WHU_CM" "LEI_CM" "CRY_FW" "SOU_FW" "BUR_CM" "BOU_CM"
#[16] "MUN_LW" "MUN_AM" "MCI_CM" "WOL_DM" "CHE_DM" "NOR_AM"


# no statistical difference between players for these positions
team_pos_vec_players_same <- team_pos_vec[!sigKWTestVec]
#  [1] "ARS_CB" "ARS_LB" "AVL_RB" "AVL_CB" "AVL_LB" "AVL_WB" "AVL_CM" "BOU_CB" "BOU_LB" "BOU_RB" "BHA_CB" "BHA_WB" "BHA_LB" "BHA_RB" "BUR_LB"
# [16] "BUR_RB" "BUR_CB" "CHE_RB" "CHE_CB" "CHE_LB" "CRY_RB" "CRY_CB" "CRY_LB" "EVE_CB" "EVE_RB" "EVE_CM" "LEI_CB" "LEI_LB" "LIV_LB" "LIV_CB"
# [31] "MCI_RB" "MCI_LB" "MUN_LB" "NEW_CB" "NEW_WB" "NEW_LB" "NOR_LB" "NOR_RB" "SHU_CB" "SHU_CM" "SHU_WB" "SOU_CB" "TOT_CB" "TOT_RB" "WAT_RB"
# [46] "WAT_LB" "WAT_CB" "WAT_WB" "WHU_LB" "WHU_RB" "WHU_CB" "BHA_FW" "WOL_RW" "ARS_FW" "MUN_FW" "BUR_FW" "LEI_FW" "SHU_FW" "ARS_LW" "CHE_RW"
# [61] "CHE_LW" "BOU_FW" "EVE_FW" "MCI_FW" "MCI_LW" "WAT_FW" "WAT_LW" "BHA_LW" "TOT_FW" "WAT_CM" "WAT_RW" "NEW_FW" "LIV_RW" "LIV_FW" "ARS_CM"
# [76] "ARS_RW" "CHE_FW" "WOL_FW" "WOL_LW" "EVE_RW" "LIV_LW" "WHU_FW" "TOT_LW" "TOT_CM" "BHA_DM" "BHA_CM" "AVL_FW" "CHE_AM" "WAT_DM" "WAT_AM"
# [91] "LIV_CM" "NOR_CM" "NOR_DM" "EVE_DM" "MUN_DM" "AVL_RW" "AVL_LW" "BUR_DM" "MCI_RW" "AVL_DM" "ARS_DM" "ARS_AM" "WHU_DM" "TOT_AM" "LEI_DM"
#[106] "NOR_RW" "NOR_LW" "TOT_DM" "LIV_DM" "WHU_AM" "MUN_CM" "MCI_DM" "NEW_DM" "CRY_DM" "SOU_CM" "SOU_DM" "BOU_DM" "WOL_CM" "CHE_CM"

length(team_pos_vec_players_same)
#[1] 119

#filter so it is only team pos that there is no statistical difference in players
team_pos_players_same_df <- all_combined_Team_Pos_min_10_players_2[ all_combined_Team_Pos_min_10_players_2$Team_Pos %in% team_pos_vec_players_same,]

dim(team_pos_players_same_df)
#[1] 3370  130

#grab defenders
team_pos_players_same_def_df <- team_pos_players_same_df[team_pos_players_same_df$Position == "D",]

dim(team_pos_players_same_def_df)
#[1] 1642  130

#graph the defenders
ggplot(team_pos_players_same_def_df, aes(x = reorder(Team_Pos, xPts, FUN = median ), y = xPts)) + geom_boxplot()  + theme_minimal() + theme(axis.text.x = element_text(angle = 90)) +ggtitle("Defenders xFpts for Team Positions with no stat difference btw players")

#grab midfielders
team_pos_players_same_mid_df <- team_pos_players_same_df[team_pos_players_same_df$Position == "M",]

#graph the midfielders
ggplot(team_pos_players_same_mid_df, aes(x = reorder(Team_Pos, xPts, FUN = median ), y = xPts)) + geom_boxplot()  + theme_minimal() + theme(axis.text.x = element_text(angle = 90)) +ggtitle("Midfielders xFpts for Team Positions with no stat difference btw players")

dim(team_pos_players_same_mid_df)
#[1] 1068  130

#grab forwards
team_pos_players_same_for_df <- team_pos_players_same_df[team_pos_players_same_df$Position == "F",]

dim(team_pos_players_same_for_df)
#[1] 660 130

#graph the forwards
ggplot(team_pos_players_same_for_df, aes(x = reorder(Team_Pos, xPts, FUN = median ), y = xPts)) + geom_boxplot()  + theme_minimal() + theme(axis.text.x = element_text(angle = 90)) +ggtitle("Forwards xFpts for Team Positions with no stat difference btw players")

#all positions together

ggplot(team_pos_players_same_df, aes(x = reorder(Team_Pos, xPts, FUN = median ), y = xPts)) + geom_boxplot()  + theme_minimal() + theme(axis.text.x = element_text(angle = 90)) +ggtitle("All Players xFpts for Team Positions with no stat difference btw players")

```

#Look into the statistically different team positions
```{r}

team_pos_vec[sigKWTestVec]
# [1] "ARS_RB" "CRY_CM" "MCI_CB" "MUN_CB" "NOR_CB" "WOL_CB" "WOL_WB" "NEW_CM" "NEW_AM" "WHU_CM" "LEI_CM" "CRY_FW" "SOU_FW" "BUR_CM" "BOU_CM"
#[16] "MUN_LW" "MUN_AM" "MCI_CM" "WOL_DM" "CHE_DM" "NOR_AM"

#look at ARS RBs
ARS_RB_data <- as.data.frame(all_combined_Team_Pos_min_10_players_2[all_combined_Team_Pos_min_10_players_2$Team_Pos == "ARS_RB",])

ggplot(ARS_RB_data, aes(Player, xPts)) + geom_boxplot(aes(colour = Player), outlier.shape = NA) + geom_jitter(width = 0.2, aes(colour = ARS_RB_data$Player)) + theme_minimal() + theme(axis.text.x = element_text(angle = 45)) +ggtitle("Arsenal RB xFpt for each player")

#CRY_CM
CRY_CM_data <- as.data.frame(all_combined_Team_Pos_min_10_players_2[all_combined_Team_Pos_min_10_players_2$Team_Pos == "CRY_CM",])

ggplot(CRY_CM_data, aes(Player, xPts)) + geom_boxplot(aes(colour = Player), outlier.shape = NA) + geom_jitter(width = 0.2, aes(colour = CRY_CM_data$Player)) + theme_minimal() + theme(axis.text.x = element_text(angle = 45)) +ggtitle("CRY_CM xFpt for each player")
#Wilf Zaha is good, maybe some other stuff


#MCI_CB
MCI_CB_data <- as.data.frame(all_combined_Team_Pos_min_10_players_2[all_combined_Team_Pos_min_10_players_2$Team_Pos == "MCI_CB",])

ggplot(MCI_CB_data, aes(Player, xPts)) + geom_boxplot(aes(colour = Player), outlier.shape = NA) + geom_jitter(width = 0.2, aes(colour = MCI_CB_data$Player)) + theme_minimal() + theme(axis.text.x = element_text(angle = 45)) +ggtitle("MCI_CB xFpt for each player")
#Fernandinho is no good

#MUN_CB
MUN_CB_data <- as.data.frame(all_combined_Team_Pos_min_10_players_2[all_combined_Team_Pos_min_10_players_2$Team_Pos == "MUN_CB",])

ggplot(MUN_CB_data, aes(Player, xPts)) + geom_boxplot(aes(colour = Player), outlier.shape = NA) + geom_jitter(width = 0.2, aes(colour = MUN_CB_data$Player)) + theme_minimal() + theme(axis.text.x = element_text(angle = 45)) +ggtitle("MUN_CB xFpt for each player")
#Victor Lidelof is worse than Slabhead

#NOR_CB
NOR_CB_data <- as.data.frame(all_combined_Team_Pos_min_10_players_2[all_combined_Team_Pos_min_10_players_2$Team_Pos == "NOR_CB",])

ggplot(NOR_CB_data, aes(Player, xPts)) + geom_boxplot(aes(colour = Player), outlier.shape = NA) + geom_jitter(width = 0.2, aes(colour = NOR_CB_data$Player)) + theme_minimal() + theme(axis.text.x = element_text(angle = 45)) +ggtitle("NOR_CB xFpt for each player")
# Tettey and Godfrey are worse than Zimmerman and Hanley

#WOL_CB
WOL_CB_data <- as.data.frame(all_combined_Team_Pos_min_10_players_2[all_combined_Team_Pos_min_10_players_2$Team_Pos == "WOL_CB",])

ggplot(WOL_CB_data, aes(Player, xPts)) + geom_boxplot(aes(colour = Player), outlier.shape = NA) + geom_jitter(width = 0.2, aes(colour = WOL_CB_data$Player)) + theme_minimal() + theme(axis.text.x = element_text(angle = 45)) +ggtitle("WOL_CB xFpt for each player")
#Willy Boly is better

#WOL_WB
WOL_WB_data <- as.data.frame(all_combined_Team_Pos_min_10_players_2[all_combined_Team_Pos_min_10_players_2$Team_Pos == "WOL_WB",])

ggplot(WOL_WB_data, aes(Player, xPts)) + geom_boxplot(aes(colour = Player), outlier.shape = NA) + geom_jitter(width = 0.2, aes(colour = WOL_WB_data$Player)) + theme_minimal() + theme(axis.text.x = element_text(angle = 45)) +ggtitle("WOL_WB xFpt for each player")
#Doherty is good, jonny is okay

# NEW_CM
NEW_CM_data <- as.data.frame(all_combined_Team_Pos_min_10_players_2[all_combined_Team_Pos_min_10_players_2$Team_Pos == "NEW_CM",])

ggplot(NEW_CM_data, aes(Player, xPts)) + geom_boxplot(aes(colour = Player), outlier.shape = NA) + geom_jitter(width = 0.2, aes(colour = NEW_CM_data$Player)) + theme_minimal() + theme(axis.text.x = element_text(angle = 45)) +ggtitle("NEW_CM xFpt for each player")
#Saint-Maximin is good, shelvey, ritchie, and almiron are pretty good

#NEW_AM
NEW_AM_data <- as.data.frame(all_combined_Team_Pos_min_10_players_2[all_combined_Team_Pos_min_10_players_2$Team_Pos == "NEW_AM",])

ggplot(NEW_AM_data, aes(Player, xPts)) + geom_boxplot(aes(colour = Player), outlier.shape = NA) + geom_jitter(width = 0.2, aes(colour = NEW_AM_data$Player)) + theme_minimal() + theme(axis.text.x = element_text(angle = 45)) +ggtitle("NEW_AM xFpt for each player")
#Saint-Maximin is good, atsu might be good, almiron is not good

#WHU_CM
WHU_CM_data <- as.data.frame(all_combined_Team_Pos_min_10_players_2[all_combined_Team_Pos_min_10_players_2$Team_Pos == "WHU_CM",])

ggplot(WHU_CM_data, aes(Player, xPts)) + geom_boxplot(aes(colour = Player), outlier.shape = NA) + geom_jitter(width = 0.2, aes(colour = WHU_CM_data$Player)) + theme_minimal() + theme(axis.text.x = element_text(angle = 45)) +ggtitle("WHU_CM xFpt for each player")
#anderson is good Noble is bad

#LEI_CM
LEI_CM_data <- as.data.frame(all_combined_Team_Pos_min_10_players_2[all_combined_Team_Pos_min_10_players_2$Team_Pos == "LEI_CM",])

ggplot(LEI_CM_data, aes(Player, xPts)) + geom_boxplot(aes(colour = Player), outlier.shape = NA) + geom_jitter(width = 0.2, aes(colour = LEI_CM_data$Player)) + theme_minimal() + theme(axis.text.x = element_text(angle = 45)) +ggtitle("LEI_CM xFpt for each player")
#barnes and Maddison are about the same

#CRY_FW
CRY_FW_data <- as.data.frame(all_combined_Team_Pos_min_10_players_2[all_combined_Team_Pos_min_10_players_2$Team_Pos == "CRY_FW",])

ggplot(CRY_FW_data, aes(Player, xPts)) + geom_boxplot(aes(colour = Player), outlier.shape = NA) + geom_jitter(width = 0.2, aes(colour = CRY_FW_data$Player)) + theme_minimal() + theme(axis.text.x = element_text(angle = 45)) +ggtitle("CRY_FW xFpt for each player")
#benteke better than the other two


#SOU_FW
SOU_FW_data <- as.data.frame(all_combined_Team_Pos_min_10_players_2[all_combined_Team_Pos_min_10_players_2$Team_Pos == "SOU_FW",])

ggplot(SOU_FW_data, aes(Player, xPts)) + geom_boxplot(aes(colour = Player), outlier.shape = NA) + geom_jitter(width = 0.2, aes(colour = SOU_FW_data$Player)) + theme_minimal() + theme(axis.text.x = element_text(angle = 45)) +ggtitle("SOU_FW xFpt for each player")
#Shane long and Danny Ings about equal che Adams no good

#BUR_CM
BUR_CM_data <- as.data.frame(all_combined_Team_Pos_min_10_players_2[all_combined_Team_Pos_min_10_players_2$Team_Pos == "BUR_CM",])

ggplot(BUR_CM_data, aes(Player, xPts)) + geom_boxplot(aes(colour = Player), outlier.shape = NA) + geom_jitter(width = 0.2, aes(colour = BUR_CM_data$Player)) + theme_minimal() + theme(axis.text.x = element_text(angle = 45)) +ggtitle("BUR_CM xFpt for each player")
#McNeil is good

#BOU_CM
BOU_CM_data <- as.data.frame(all_combined_Team_Pos_min_10_players_2[all_combined_Team_Pos_min_10_players_2$Team_Pos == "BOU_CM",])

ggplot(BOU_CM_data, aes(Player, xPts)) + geom_boxplot(aes(colour = Player), outlier.shape = NA) + geom_jitter(width = 0.2, aes(colour = BOU_CM_data$Player)) + theme_minimal() + theme(axis.text.x = element_text(angle = 45)) +ggtitle("BOU_CM xFpt for each player")
#some are good some bad

#MUN_LW
MUN_LW_data <- as.data.frame(all_combined_Team_Pos_min_10_players_2[all_combined_Team_Pos_min_10_players_2$Team_Pos == "MUN_LW",])

ggplot(MUN_LW_data, aes(Player, xPts)) + geom_boxplot(aes(colour = Player), outlier.shape = NA) + geom_jitter(width = 0.2, aes(colour = MUN_LW_data$Player)) + theme_minimal() + theme(axis.text.x = element_text(angle = 45)) +ggtitle("MUN_LW xFpt for each player")
#Rashford is way better than Daniel James

#MUN_AM
MUN_AM_data <- as.data.frame(all_combined_Team_Pos_min_10_players_2[all_combined_Team_Pos_min_10_players_2$Team_Pos == "MUN_AM",])

ggplot(MUN_AM_data, aes(Player, xPts)) + geom_boxplot(aes(colour = Player), outlier.shape = NA) + geom_jitter(width = 0.2, aes(colour = MUN_AM_data$Player)) + theme_minimal() + theme(axis.text.x = element_text(angle = 45)) +ggtitle("MUN_AM xFpt for each player")
#Bruno and Pereira are good

#MCI_CM
MCI_CM_data <- as.data.frame(all_combined_Team_Pos_min_10_players_2[all_combined_Team_Pos_min_10_players_2$Team_Pos == "MCI_CM",])

ggplot(MCI_CM_data, aes(Player, xPts)) + geom_boxplot(aes(colour = Player), outlier.shape = NA) + geom_jitter(width = 0.2, aes(colour = MCI_CM_data$Player)) + theme_minimal() + theme(axis.text.x = element_text(angle = 45)) +ggtitle("MCI_CM xFpt for each player")
#KDB is real good and Bernardo Silva is not so good

#WOL_DM
WOL_DM_data <- as.data.frame(all_combined_Team_Pos_min_10_players_2[all_combined_Team_Pos_min_10_players_2$Team_Pos == "WOL_DM",])

ggplot(WOL_DM_data, aes(Player, xPts)) + geom_boxplot(aes(colour = Player), outlier.shape = NA) + geom_jitter(width = 0.2, aes(colour = WOL_DM_data$Player)) + theme_minimal() + theme(axis.text.x = element_text(angle = 45)) +ggtitle("WOL_DM xFpt for each player")
#Moutinho is good, don't bother with Dendoncker

#CHE_DM
CHE_DM_data <- as.data.frame(all_combined_Team_Pos_min_10_players_2[all_combined_Team_Pos_min_10_players_2$Team_Pos == "CHE_DM",])

ggplot(CHE_DM_data, aes(Player, xPts)) + geom_boxplot(aes(colour = Player), outlier.shape = NA) + geom_jitter(width = 0.2, aes(colour = CHE_DM_data$Player)) + theme_minimal() + theme(axis.text.x = element_text(angle = 45)) +ggtitle("CHE_DM xFpt for each player")
#Kante is good

#NOR_AM

NOR_AM_data <- as.data.frame(all_combined_Team_Pos_min_10_players_2[all_combined_Team_Pos_min_10_players_2$Team_Pos == "NOR_AM",])

ggplot(NOR_AM_data, aes(Player, xPts)) + geom_boxplot(aes(colour = Player), outlier.shape = NA) + geom_jitter(width = 0.2, aes(colour = NOR_AM_data$Player)) + theme_minimal() + theme(axis.text.x = element_text(angle = 45)) +ggtitle("NOR_AM xFpt for each player")
#Duda looks to be good
```

#test if there are players who get much better Fantasy points in one position versus another 
```{r}
#require that each players has played 2 or more positions
players_2_plus_pos <- all_combined_Team_Pos %>% group_by(Player) %>% filter(length(unique(Team_Pos)) > 1)

dim(players_2_plus_pos)
#[1] 3879  130

#vector of the players that played 2 or more positions
player_vec <- unique(players_2_plus_pos$Player)

length(player_vec)
#[1] 237

#length of the player_vec
n = length(player_vec)

#initiate a vector to save the boolean of whether the Kruskal-Wallis test was significant for each player (test of whether the player distributions seem to be the same)
sigKWPlayerTestList <- vector(mode= "list", length= n)

#for each player
for(p in 1:length(player_vec)){
  
  print(player_vec[p])
  
  #set player
  player <- player_vec[p]
  
  #filter to just the entries of this player
  player_games <- players_2_plus_pos[players_2_plus_pos$Player == player,]
  
  #test if there is a differnce in xPts based on position
  k_test <- kruskal.test(xPts ~ Team_Pos, data = player_games)
  print(k_test$p.value)

  #check if the Kruskal-Wallis test is close to significant
  bool_signif <- k_test$p.value < 0.05
  
  #write the team pos test significance to the list
 sigKWPlayerTestList[[p]] <- bool_signif
}

#make the list into a vector
sigKWPlayerTestList <- unlist(sigKWPlayerTestList)


#players who seem to be distributed differently when playing different positions

player_vec[sigKWPlayerTestList]
#[1] "Neil Taylor"        "Max Aarons"         "Christian Kabasele" "Harry Wilson"       "Jack Cork"  


#look at theese 5 players
"Neil Taylor"
player <- as.data.frame(players_2_plus_pos[players_2_plus_pos$Player == "Neil Taylor",])

ggplot(player, aes(Team_Pos, xPts)) + geom_boxplot(aes(colour = Team_Pos), outlier.shape = NA) + geom_jitter(width = 0.2, aes(colour = player$Team_Pos)) + theme_minimal() + theme(axis.text.x = element_text(angle = 45)) +ggtitle("Neil Taylor xFpt for each position played")

"Max Aarons"
player <- as.data.frame(players_2_plus_pos[players_2_plus_pos$Player == "Max Aarons",])

ggplot(player, aes(Team_Pos, xPts)) + geom_boxplot(aes(colour = Team_Pos), outlier.shape = NA) + geom_jitter(width = 0.2, aes(colour = player$Team_Pos)) + theme_minimal() + theme(axis.text.x = element_text(angle = 45)) +ggtitle("Max Aarons xFpt for each position played")

"Christian Kabasele"
player <- as.data.frame(players_2_plus_pos[players_2_plus_pos$Player == "Christian Kabasele",])

ggplot(player, aes(Team_Pos, xPts)) + geom_boxplot(aes(colour = Team_Pos), outlier.shape = NA) + geom_jitter(width = 0.2, aes(colour = player$Team_Pos)) + theme_minimal() + theme(axis.text.x = element_text(angle = 45)) +ggtitle("Christian Kabasele xFpt for each position played")

"Harry Wilson"
player <- as.data.frame(players_2_plus_pos[players_2_plus_pos$Player == "Harry Wilson",])

ggplot(player, aes(Team_Pos, xPts)) + geom_boxplot(aes(colour = Team_Pos), outlier.shape = NA) + geom_jitter(width = 0.2, aes(colour = player$Team_Pos)) + theme_minimal() + theme(axis.text.x = element_text(angle = 45)) +ggtitle("Harry Wilson xFpt for each position played")

"Jack Cork"

player <- as.data.frame(players_2_plus_pos[players_2_plus_pos$Player == "Jack Cork",])

ggplot(player, aes(Team_Pos, xPts)) + geom_boxplot(aes(colour = Team_Pos), outlier.shape = NA) + geom_jitter(width = 0.2, aes(colour = player$Team_Pos)) + theme_minimal() + theme(axis.text.x = element_text(angle = 45)) +ggtitle("Jack Cork xFpt for each position played")

#Spot check Allan Saint-Maximin
player <- as.data.frame(players_2_plus_pos[players_2_plus_pos$Player == "Allan Saint-Maximin",])

ggplot(player, aes(Team_Pos, xPts)) + geom_boxplot(aes(colour = Team_Pos), outlier.shape = NA) + geom_jitter(width = 0.2, aes(colour = player$Team_Pos)) + theme_minimal() + theme(axis.text.x = element_text(angle = 45)) +ggtitle("Allan Saint-Maximin xFpt for each position played")

"James Ward-Prowse"

player <- as.data.frame(players_2_plus_pos[players_2_plus_pos$Player == "James Ward-Prowse",])

ggplot(player, aes(Team_Pos, xPts)) + geom_boxplot(aes(colour = Team_Pos), outlier.shape = NA) + geom_jitter(width = 0.2, aes(colour = player$Team_Pos)) + theme_minimal() + theme(axis.text.x = element_text(angle = 45)) +ggtitle("James Ward-Prowse xFpt for each position played")


"Cesar Azpilicueta"
player <- as.data.frame(players_2_plus_pos[players_2_plus_pos$Player == "Cesar Azpilicueta",])

ggplot(player, aes(Team_Pos, xPts)) + geom_boxplot(aes(colour = Team_Pos), outlier.shape = NA) + geom_jitter(width = 0.2, aes(colour = player$Team_Pos)) + theme_minimal() + theme(axis.text.x = element_text(angle = 45)) +ggtitle("Cesar Azpilicueta xFpt for each position played")

"Emiliano Buendia"
player <- as.data.frame(players_2_plus_pos[players_2_plus_pos$Player == "Emiliano Buendia",])

ggplot(player, aes(Team_Pos, xPts)) + geom_boxplot(aes(colour = Team_Pos), outlier.shape = NA) + geom_jitter(width = 0.2, aes(colour = player$Team_Pos)) + theme_minimal() + theme(axis.text.x = element_text(angle = 45)) +ggtitle("Emiliano Buendia xFpt for each position played")


```

#Looking into Interesting Team Positions
```{r}
#NOR_RW
#interesting because there is no sig diff between Buendia and Cantwell AND really good xFpts
NOR_RW_data <- as.data.frame(all_combined_Team_Pos_min_10_players_2[all_combined_Team_Pos_min_10_players_2$Team_Pos == "NOR_RW",])
ggplot(NOR_RW_data, aes(Player, xPts)) + geom_boxplot(aes(colour = Player), outlier.shape = NA) + geom_jitter(width = 0.2, aes(colour = NOR_RW_data$Player)) + theme_minimal() + theme(axis.text.x = element_text(angle = 45)) +ggtitle("NOR_RW xFpt for each player")

#WAT_AM
#interesting because it is quite high and multiple players
WAT_AM_data <- as.data.frame(all_combined_Team_Pos_min_10_players_2[all_combined_Team_Pos_min_10_players_2$Team_Pos == "WAT_AM",])
ggplot(WAT_AM_data, aes(Player, xPts)) + geom_boxplot(aes(colour = Player), outlier.shape = NA) + geom_jitter(width = 0.2, aes(colour = WAT_AM_data$Player)) + theme_minimal() + theme(axis.text.x = element_text(angle = 45)) +ggtitle("WAT_AM xFpt for each player")
#graph shows not that interesting high variance in everybody

#LIV_FW
#interesting because it is quite high and multiple players
LIV_FW_data <- as.data.frame(all_combined_Team_Pos_min_10_players_2[all_combined_Team_Pos_min_10_players_2$Team_Pos == "LIV_FW",])
ggplot(LIV_FW_data, aes(Player, xPts)) + geom_boxplot(aes(colour = Player), outlier.shape = NA) + geom_jitter(width = 0.2, aes(colour = LIV_FW_data$Player)) + theme_minimal() + theme(axis.text.x = element_text(angle = 45)) +ggtitle("LIV_FW xFpt for each player")
#graph shows not that interesting seems to be a Salah sample size issue

#WHU_FW
#interesting because it looks to quite good AND not quite diff between Antonio and Haller
WHU_FW_data <- as.data.frame(all_combined_Team_Pos_min_10_players_2[all_combined_Team_Pos_min_10_players_2$Team_Pos == "WHU_FW",])
ggplot(WHU_FW_data, aes(Player, xPts)) + geom_boxplot(aes(colour = Player), outlier.shape = NA) + geom_jitter(width = 0.2, aes(colour = WHU_FW_data$Player)) + theme_minimal() + theme(axis.text.x = element_text(angle = 45)) +ggtitle("WHU_FW xFpt for each player")


#BUR_CB
#interesting because quite good
BUR_CB_data <- as.data.frame(all_combined_Team_Pos_min_10_players_2[all_combined_Team_Pos_min_10_players_2$Team_Pos == "BUR_CB",])
ggplot(BUR_CB_data, aes(Player, xPts)) + geom_boxplot(aes(colour = Player), outlier.shape = NA) + geom_jitter(width = 0.2, aes(colour = BUR_CB_data$Player)) + theme_minimal() + theme(axis.text.x = element_text(angle = 45)) +ggtitle("BUR_CB xFpt for each player")
#going to be super correlated, so might not be that interesting

#Interesting to compare MUN and BUR CBs

#SHU_CB
SHU_CB_data <- as.data.frame(all_combined_Team_Pos_min_10_players_2[all_combined_Team_Pos_min_10_players_2$Team_Pos == "SHU_CB",])
ggplot(SHU_CB_data, aes(Player, xPts)) + geom_boxplot(aes(colour = Player), outlier.shape = NA) + geom_jitter(width = 0.2, aes(colour = SHU_CB_data$Player)) + theme_minimal() + theme(axis.text.x = element_text(angle = 45)) +ggtitle("SHU_CB xFpt for each player")

#MCI_RW
MCI_RW_data <- as.data.frame(all_combined_Team_Pos_min_10_players_2[all_combined_Team_Pos_min_10_players_2$Team_Pos == "MCI_RW",])
ggplot(MCI_RW_data, aes(Player, xPts)) + geom_boxplot(aes(colour = Player), outlier.shape = NA) + geom_jitter(width = 0.2, aes(colour = MCI_RW_data$Player)) + theme_minimal() + theme(axis.text.x = element_text(angle = 45)) +ggtitle("MCI_RW xFpt for each player")

#MCI_LW
MCI_LW_data <- as.data.frame(all_combined_Team_Pos_min_10_players_2[all_combined_Team_Pos_min_10_players_2$Team_Pos == "MCI_LW",])
ggplot(MCI_LW_data, aes(Player, xPts)) + geom_boxplot(aes(colour = Player), outlier.shape = NA) + geom_jitter(width = 0.2, aes(colour = MCI_LW_data$Player)) + theme_minimal() + theme(axis.text.x = element_text(angle = 45)) +ggtitle("MCI_LW xFpt for each player")
```

# Center Backs analysis
```{r}
#fix a lot of stat fields being characters
all_combined_Team_Pos_min_10_num <- all_combined_Team_Pos_min_10

all_combined_Team_Pos_min_10_num[,101:127] <- sapply(all_combined_Team_Pos_min_10_num[,101:127], as.numeric)

#filter so it is only center backs
all_combined_df_CBs <- all_combined_Team_Pos_min_10_num[all_combined_Team_Pos_min_10_num$Pos == "CB",]

#plot fantasy points for all CBs
#xFpts plot
ggplot(all_combined_Team_Pos_min_10_num, aes(x = reorder(Player, xPts, FUN = median ), y = xPts)) + geom_boxplot()  + theme_minimal() + theme(axis.text.x = element_text(angle = 90)) +ggtitle("xFpts for CBs")
#not useful

#Man U analysis
MUN_CB <- all_combined_df_CBs[all_combined_df_CBs$Team_Pos == "MUN_CB",]

dim(MUN_CB)
#[1]  56 130

#remove Luke Shaw
MUN_CB <- MUN_CB[MUN_CB$Player != "Luke Shaw",]

dim(MUN_CB)
#[1]  55 130


#loop through the statistics we have and see what is significantly different between the players
stat_vec <- names(MUN_CB)

#length of the stat_vec
n = length(stat_vec)

#initiate a vector to save the boolean of whether the Kruskal-Wallis test was significant for each stat
sigStatKWTestList <- vector(mode= "list", length= n)

#for each team position
for(s in 1:length(stat_vec)){
  
  print(stat_vec[s])
  print(s)
  
  #set stat_name
  stat_name <- stat_vec[s]
  
  #if this stat is not an int or a numeric vector (so a character vector) don't perform the stat test
  if(typeof(MUN_CB[[stat_name]]) == "character" ){
    
    bool_signif = FALSE
  
  #if all entries are the same don't run the test  
  } else if(length(unique(MUN_CB[[stat_name]])) == 1){
  
    bool_signif = FALSE
    
  } else {
  
  #filter all_combined_Team_Pos_min_10_players_2 to just the entries of players with this team_pos
  #team_pos_player <- all_combined_Team_Pos_min_10_players_2[all_combined_Team_Pos_min_10_players_2$Team_Pos == team_pos,]
  
  k_test <- kruskal.test(MUN_CB[[stat_name]] ~ Player, data = MUN_CB)
  print(k_test$p.value)

  #check if the Kruskal-Wallis test is close to bonferroni significant
  bool_signif <- k_test$p.value < 0.05
  
  }
  
  #write the team pos test significance to the list
  sigStatKWTestList[[s]] <- bool_signif
}

#make the list into a vector
sigStatKWTestList<- unlist(sigStatKWTestList)


#players seem to be distributed differently for these team distributions

stat_vec[sigStatKWTestList]
# [1] "Rk"        "FPts"      "FP/G"      "S"         "SOT"       "SA"        "Off"       "SFTP"      "CF_1"      "Int.x"     "DW"       
#[12] "AER"       "LB"        "LBA"       "Sh"        "SoT"       "Int.y"     "xG"        "npxG"      "PrgDist_1" "xPts"  

#make a summary for these fields
summary_MUN_CBs <- MUN_CB %>% 
  group_by(Player) %>%
  summarize(n = n(), meanFpts = mean(FPts), total_Fpts = sum(FPts), meanxFpts = mean(xPts), total_xFpts = sum(xPts),total_SOT = sum(SOT), total_Shots = sum(S), total_xG = sum(xG), total_SA = sum(SA), meanInts = mean(Int.x), meanAER = mean(AER), meanPrgDist = mean(PrgDist_1) )

#summary_MUN_CBs_for_plot <- summary_MUN_CBs %>% gather(Stat_Name,Stat_Value, meanFpts,meanxFpts,total_SOT,total_xG,meanInts,meanAER,meanPrgDist)

summary_MUN_CBs_for_plot <- summary_MUN_CBs %>% gather(Stat_Name,Stat_Value, meanFpts,meanxFpts,total_SOT,total_xG,meanInts,meanAER)

#make a bar plot of these data
ggplot(summary_MUN_CBs_for_plot , aes(fill=Player, y=Stat_Value, x=Stat_Name)) + geom_bar(position="dodge", stat="identity") + theme_minimal() +ggtitle("Maguire and Lindelof Summary")

#ggplot(MCI_LW_data, aes(Player, xPts)) + geom_boxplot(aes(colour = Player), outlier.shape = NA) + geom_jitter(width = 0.2, aes(colour = MCI_LW_data$Player)) + theme_minimal() + theme(axis.text.x = element_text(angle = 45)) +ggtitle("MCI_LW xFpt for each player")


#Wolves analysis
WOL_CB <- all_combined_df_CBs[all_combined_df_CBs$Team_Pos == "WOL_CB",]

dim(WOL_CB)
#[1]  74 130

#remove Luke Shaw
WOL_CB <- WOL_CB[WOL_CB$Player != "Leander Dendoncker",]

dim(WOL_CB)
#[1]  62 130


#loop through the statistics we have and see what is significantly different between the players
stat_vec <- names(WOL_CB)

#length of the stat_vec
n = length(stat_vec)

#initiate a vector to save the boolean of whether the Kruskal-Wallis test was significant for each stat
sigStatKWTestList <- vector(mode= "list", length= n)

#for each team position
for(s in 1:length(stat_vec)){
  
  print(stat_vec[s])
  print(s)
  
  #set stat_name
  stat_name <- stat_vec[s]
  
  #if this stat is not an int or a numeric vector (so a character vector) don't perform the stat test
  if(typeof(WOL_CB[[stat_name]]) == "character" ){
    
    bool_signif = FALSE
  
  #if all entries are the same don't run the test  
  } else if(length(unique(WOL_CB[[stat_name]])) == 1){
  
    bool_signif = FALSE
    
  } else {
  
  #filter all_combined_Team_Pos_min_10_players_2 to just the entries of players with this team_pos
  #team_pos_player <- all_combined_Team_Pos_min_10_players_2[all_combined_Team_Pos_min_10_players_2$Team_Pos == team_pos,]
  
  k_test <- kruskal.test(WOL_CB[[stat_name]] ~ Player, data = WOL_CB)
  print(k_test$p.value)

  #check if the Kruskal-Wallis test is close to bonferroni significant
  bool_signif <- k_test$p.value < 0.05
  
  }
  
  #write the team pos test significance to the list
  sigStatKWTestList[[s]] <- bool_signif
}

#make the list into a vector
sigStatKWTestList<- unlist(sigStatKWTestList)


#players seem to be distributed differently for these team distributions

stat_vec[sigStatKWTestList]
# [1] "Rk"      "FPts"    "FP/G"    "S"       "SOT"     "SA"      "TkW"     "PLC"     "FC"      "FS"      "YC"     
#[12] "PC%"     "C"       "CF"      "CF_1"    "Int.x"   "CoSF"    "DW"      "DL"      "AER"     "AERL"    "PL"     
#[23] "LB"      "LBA"     "Sh"      "SoT"     "CrdY"    "Touches" "Press"   "Tkl"     "Int.y"   "xG"      "npxG"   
#[34] "Cmp%"    "PrgDist" "Succ"    "xPts"   

#make a summary for these fields
summary_WOL_CBs <- WOL_CB %>% 
  group_by(Player) %>%
  summarize(n = n(), meanFpts = mean(FPts), total_Fpts = sum(FPts), meanxFpts = mean(xPts), total_xFpts = sum(xPts), total_SOT = sum(SOT), total_Shots = sum(S), total_SA = sum(SA), meanInts = mean(Int.x), meanAER = mean(AER), totalYC = sum(CrdY), meanTkW = mean(TkW), meanTouches = mean(Touches), meanPress = mean(Press))

summary_WOL_CBs_for_plot <- summary_WOL_CBs %>% gather(Stat_Name,Stat_Value, meanFpts,meanxFpts,total_SOT,meanInts,meanAER, totalYC,meanTkW, meanPress,meanTouches)

#make a bar plot of these data
ggplot(summary_WOL_CBs_for_plot , aes(fill=Player, y=Stat_Value, x=Stat_Name)) + geom_bar(position="dodge", stat="identity") + theme_minimal() +ggtitle("Wolves CB Summary")

#fantrax point categor
#c(“G”,”KP”,”AT”,”SOT”,”TkW”,”DIS”,”YC”,”SYC”,”RC”,”ACNC”,”Int”,”CLR”,”CoS”,”AER”,”OG”,”GAD”,”CS”)


#Burnley CB analysis
BUR_CB <- all_combined_df_CBs[all_combined_df_CBs$Team_Pos == "BUR_CB",]

dim(BUR_CB)
#[1]  58 130


#loop through the statistics we have and see what is significantly different between the players
stat_vec <- names(BUR_CB)

#length of the stat_vec
n = length(stat_vec)

#initiate a vector to save the boolean of whether the Kruskal-Wallis test was significant for each stat
sigStatKWTestList <- vector(mode= "list", length= n)

#for each team position
for(s in 1:length(stat_vec)){
  
  print(stat_vec[s])
  print(s)
  
  #set stat_name
  stat_name <- stat_vec[s]
  
  #if this stat is not an int or a numeric vector (so a character vector) don't perform the stat test
  if(typeof(BUR_CB[[stat_name]]) == "character" ){
    
    bool_signif = FALSE
  
  #if all entries are the same don't run the test  
  } else if(length(unique(BUR_CB[[stat_name]])) == 1){
  
    bool_signif = FALSE
    
  } else {
  
  #filter all_combined_Team_Pos_min_10_players_2 to just the entries of players with this team_pos
  #team_pos_player <- all_combined_Team_Pos_min_10_players_2[all_combined_Team_Pos_min_10_players_2$Team_Pos == team_pos,]
  
  k_test <- kruskal.test(BUR_CB[[stat_name]] ~ Player, data = BUR_CB)
  print(k_test$p.value)

  #check if the Kruskal-Wallis test is close to bonferroni significant
  bool_signif <- k_test$p.value < 0.05
  
  }
  
  #write the team pos test significance to the list
  sigStatKWTestList[[s]] <- bool_signif
}

#make the list into a vector
sigStatKWTestList<- unlist(sigStatKWTestList)


#players seem to be distributed differently for these team distributions

stat_vec[sigStatKWTestList]
#[1] "Rk"    "ErS"   "IntB"  "DW"    "AERL"  "LB"    "Press" "Tkl"

#make a summary for these fields
summary_BUR_CBs <- BUR_CB %>% 
  group_by(Player) %>%
  summarize(n = n(), meanFpts = mean(FPts), total_Fpts = sum(FPts), meanxFpts = mean(xPts), total_xFpts = sum(xPts), meanIntB = mean(IntB), meanAERL = mean(AERL), meanTkl = mean(Tkl), meanLB = mean(LB))

summary_BUR_CBs_for_plot <- summary_BUR_CBs %>% gather(Stat_Name,Stat_Value, meanFpts,meanxFpts,meanIntB,meanAERL,meanTkl,meanLB)

#make a bar plot of these data
ggplot(summary_BUR_CBs_for_plot , aes(fill=Player, y=Stat_Value, x=Stat_Name)) + geom_bar(position="dodge", stat="identity") + theme_minimal() +ggtitle("Burnley CB Summary")

#fantrax point categor
#c(“G”,”KP”,”AT”,”SOT”,”TkW”,”DIS”,”YC”,”SYC”,”RC”,”ACNC”,”Int”,”CLR”,”CoS”,”AER”,”OG”,”GAD”,”CS”)
```

#Make top 20 team positions in the EPL
```{r}
#sort min_10_examples to find the top 20 team positions

#sort on median xFpts
min_10_examples_sorted <- min_10_examples[order(- min_10_examples$med_xPts),]

#take the top 20 team_pos
min_10_examples_sorted_top20 <- head(min_10_examples_sorted, 20)

#prep team colors
library(RColorBrewer)

unique(min_10_examples_sorted$Team)
 #[1] "MCI" "CHE" "EVE" "NOR" "LIV" "WOL" "TOT" "WAT" "LEI" "WHU" "AVL" "BHA" "ARS" "MUN" "SOU" "SHU" "CRY" "BUR" "NEW" "BOU"

team_colors <- c(
          '#c8102E',
          '#6CABDD',
          '#003090',
          '#034694',
          '#DA291C',
          '#FDB913',
          "#132257",
          "#ee2737",
          "#EF0107",
          "#1B458F",
          "#6C1D45",
          "#003399",
          "white",
          "#d71920",
          "#0057B8",
          "#FBEE23",
          "#7A263A",
          "#DA291C",
          "#670e36",
          "#00A650")
teams = c('LIV',
          'MCI',
          'LEI',
          'CHE',
          'MUN',
          'WOL',
          "TOT",
          "SHU",
          "ARS",
          "CRY",
          "BUR",
          "EVE",
          "NEW",
          "SOU",
          "BHA",
          "WAT",
          "WHU",
          "BOU",
          "AVL",
          "NOR")
names(team_colors) <- teams
colScale <- scale_colour_manual(name = "opposition",values = team_colors)
fillScale <- scale_fill_manual(name = "opposition",values = team_colors, guide = FALSE)

#filter for just top 20 team_pos in all_combined_Team_Pos_min_10
#filter so it is only team pos that there is no statistical difference in players

all_combined_Team_Pos_min_10_top_20 <- all_combined_Team_Pos_min_10[all_combined_Team_Pos_min_10$Team_Pos %in% unique(min_10_examples_sorted_top20$Team_Pos) ,]
#

dim(all_combined_Team_Pos_min_10_top_20)
#[1] 425 130

length( unique(min_10_examples_sorted_top20$Team_Pos))
#[1] 20

length( unique(all_combined_Team_Pos_min_10_top_20$Team_Pos))
#[1] 20

#make a team-position field with no underscore
all_combined_Team_Pos_min_10_top_20$Team_space_Pos <- gsub("_", " ", all_combined_Team_Pos_min_10_top_20$Team_Pos)

#plot the top 20 team_pos

ggplot(all_combined_Team_Pos_min_10_top_20, aes(x = reorder(Team_space_Pos, xPts, FUN = median ), y = xPts, fill = Team)) + geom_boxplot()  + theme_minimal() + theme(axis.text.x = element_text(angle = 90)) + ggtitle("xFpts for the top 20 Team-Positions") + xlab("Team-Position") + ylab("xFpts") + colScale + fillScale


#ggplot(all_combined_Team_Pos_min_10, aes(x = reorder(Team_Pos, xPts, FUN = median ), y = xPts)) + geom_boxplot()  + theme_minimal() + theme(axis.text.x = element_text(angle = 90)) +ggtitle("xFpts for Team Positions")


#ggplot(MCI_LW_data, aes(Player, xPts)) + geom_boxplot(aes(colour = Player), outlier.shape = NA) + geom_jitter(width = 0.2, aes(colour = MCI_LW_data$Player)) + theme_minimal() + theme(axis.text.x = element_text(angle = 45)) +ggtitle("MCI_LW xFpt for each player")

#all_combined_Team_Pos_min_10 <- all_combined_Team_Pos_min_10 %>% group_by(Team_Pos) %>% filter(length(unique(Player)) > 1)

```

#Regenerate top 20 team positions in the EPL with updated data

## Data setup

```{r data_setup}
#load all player data for fbref.com
weekly_data_csv = "../data/fantrax_data/weekly.all_data_combined.no_double_gws.csv"
yearly_data_csv = "../data/fantrax_data/yearly.all_data_combined.csv"

weekly_data_df <- read_csv(file = weekly_data_csv, col_names = TRUE)
yearly_data_df <- read_csv(file = yearly_data_csv, col_names = TRUE)

# Only weeks where at least 60 minutes are played
min_60_min_df <- weekly_data_df[weekly_data_df$Min > 59,]
# Players that have started at least 5 games
summary_min_60_df <- min_60_min_df %>% 
  group_by(Player, Team, Position) %>%
  summarize(n = n(), min_total = sum(Min), sd = sd(FPts), mean = mean(FPts), total_fpts = sum(FPts), mean_minutes = mean(Min))

#only players with at least 5 starts
players_min_5_starts_summary_df <- summary_min_60_df[summary_min_60_df$n >= 5,]

player_min_5_starts_weekly_df <- min_60_min_df %>%
  filter(Player %in% players_min_5_starts_summary_df$Player)
nrow(player_min_5_starts_weekly_df)


```

## get xFpts

```{r gather_xfpt_df}


# load in just defenders
players_min_starts.defenders = players_min_5_starts_summary_df[players_min_5_starts_summary_df$Position == 'D',]
nrow(players_min_starts.defenders)
def_player_list <- players_min_starts.defenders$Player
length(def_player_list)
#[1] 138

#read in fbref_summary data
fbref_summ_df <- read_csv('../data/fbref/premier_league/19_20/name_cleaned.summary_table.first_360_matches.csv')

dim(fbref_summ_df)
#[1] 10025    35

#clean sheet data
cs_df <- read_csv('../data/fantrax_data/game_results.csv')

#add game week to fbref_summ_df from cs_df

date_to_week_df <- as.data.frame(cbind(cs_df$Date, cs_df$Wk))

colnames(date_to_week_df) <- c("Date","game_week")

date_to_week_df <- distinct(date_to_week_df)

fbref_summ_df<- merge(fbref_summ_df, date_to_week_df, by="Date")

dim(fbref_summ_df)
#[1] 10025    36
#correct dims

#write to file
write.csv(x=fbref_summ_df, file="../data/fbref/premier_league/19_20/name_cleaned.summary_table.first_360_matches_game_week.csv")

#convert game_week to numeric
fbref_summ_df$game_week <- as.character(fbref_summ_df$game_week)
fbref_summ_df$game_week <- as.numeric(fbref_summ_df$game_week)

#write to file
write.csv(x=fbref_summ_df, file="../data/fbref/premier_league/19_20/name_cleaned.summary_table.first_360_matches_game_week.csv")

#merge on player and game week
min60_merged_df <- merge(min_60_min_df, fbref_summ_df, by=c('Player', 'game_week'))


dim(min60_merged_df)
#[1] 6764  125

table(min60_merged_df$Position)

#   D    F    M 
#2764 1342 2658 

#filter on fantrax defenders
defenders_min60_merged_df <- min60_merged_df[min60_merged_df$Position == "D",]

length(unique(defenders_min60_merged_df$Player))
#[1] 161

sum(def_player_list %in% unique(defenders_min60_merged_df$Player))
#[1] 138
#so they are all there

#negate %in%
`%!in%` = Negate(`%in%`)

#see which players are extra in this group
Players_defenders_min60_merged_df<-unique(defenders_min60_merged_df$Player)

Players_defenders_min60_merged_df[Players_defenders_min60_merged_df %!in% def_player_list]
#[1] "Axel Tuanzebe"       "Charlie Daniels"     "Diogo Dalot"         "Eric Bailly"        
 #[5] "Ezequiel Schelotto"  "Jack Robinson"       "Jack Simpson"        "Jake Vokins"        
 #[9] "Jarrad Branthwaite"  "Jeremy Ngakia"       "Kevin Danso"         "Kevin Long"         
#[13] "Leighton Baines"     "Luke Thomas"         "Maximilian Kilman"   "Neco Williams"      
#[17] "Pablo Mari"          "Phil Jagielka"       "Phil Jones"          "Rob Holding"        
#[21] "Tariq Lamptey"       "Timothy Fosu-Mensah" "Wes Morgan"

#they are players who havent have 5 starts

#remove the under 5 games players
defenders_min60_merged_df <- defenders_min60_merged_df[defenders_min60_merged_df$Player %in% def_player_list,]

dim(defenders_min60_merged_df)
#[1] 2715  125

#just get the important stuff for clean sheets (name "Team.y" for easy merge in a sec)
all_cs_data_df <- data.frame('Team.y' = c(cs_df$Home, cs_df$Away), 'xG_against' = c(cs_df$xG_1, cs_df$xG), 'game_week' = c(cs_df$Wk, cs_df$Wk))

#convert squad to character all_cs_data_df for merge
all_cs_data_df$Team.y <- as.character(all_cs_data_df$Team.y)

#merge cs and defender data
defenders_min60_merged_cs_df <- merge(defenders_min60_merged_df, all_cs_data_df, by=c("Team.y", "game_week"))

dim(defenders_min60_merged_cs_df)
#[1] 2715  126

#calculate xFpts from cs given xG against
defenders_min60_merged_cs_df$GAD_against <- ifelse(defenders_min60_merged_cs_df$xG_against - 0.25 < 0, 0, defenders_min60_merged_cs_df$xG_against - 0.25)

defenders_min60_merged_cs_df$normed_xg_against <- ifelse(defenders_min60_merged_cs_df$GAD_against <= 1.25, 1 - defenders_min60_merged_cs_df$GAD_against/1.25, 0)

#calculate xFpts for defenders
defenders_min60_merged_cs_df$xPts <- defenders_min60_merged_cs_df$FPts - (defenders_min60_merged_cs_df$G * 10 + defenders_min60_merged_cs_df$AT * 8 + defenders_min60_merged_cs_df$CS * 6 + defenders_min60_merged_cs_df$GAD * -2) + (as.numeric(defenders_min60_merged_cs_df$xG)* 10 + as.numeric(defenders_min60_merged_cs_df$xA) * 8 + as.numeric(defenders_min60_merged_cs_df$normed_xg_against)* 6 + as.numeric(defenders_min60_merged_cs_df$GAD_against) * -2)

#remove some extra defender columns
drops <- c("normed_xg_against","GAD_against", 'xG_against')
defenders_min60_merged_cs_df <- defenders_min60_merged_cs_df[ , !(names(defenders_min60_merged_cs_df) %in% drops)]

# midfielders

#load in just midfielders
players_min_starts.midfielders = players_min_5_starts_summary_df[players_min_5_starts_summary_df$Position == 'M',]
nrow(players_min_starts.midfielders)
mid_player_list <- players_min_starts.midfielders$Player

length(mid_player_list)
#[1] 143

#filter on fantrax midfielders
mids_min60_merged_df <- min60_merged_df[min60_merged_df$Position == "M",]

length(unique(mids_min60_merged_df$Player))
#[1] 168

sum(mid_player_list %in% unique(mids_min60_merged_df$Player))
#[1] 143
#so they are all there

#see which players are extra in this group
Players_mids_min60_merged_df<-unique(mids_min60_merged_df$Player)

Players_mids_min60_merged_df[Players_mids_min60_merged_df %!in% mid_player_list]
#[1] "Aaron Lennon"         "Adam Lallana"         "Alexis Mac Allister"  "Andrew Surman"       
#[5] "Anthony Gordon"       "Ben Johnson"          "Ben Osborn"           "Billy Gilmour"       
#[9] "Carlos Sanchez"       "Curtis Jones"         "Daniel Drinkwater"    "Daniel Podence"      
#[13] "Demarai Gray"         "Henri Lansbury"       "Jean-Philippe Gbamin" "Jota"                
#[17] "Keinan Davis"         "Luke Freeman"         "Morgan Gibbs-White"   "Muhamed Besic"       
#[21] "Nampalys Mendy"       "Robbie Brady"         "Ruben Loftus-Cheek"   "Ryan Sessegnon"      
#[25] "Valentino Lazaro"  

summary_min_60_df[summary_min_60_df$Player == "Adam Lallana",]

summary_min_60_df[summary_min_60_df$Player == "Billy Gilmour",]

#they are players who havent have 5 starts

#remove the under 5 games players
mids_min60_merged_df <- mids_min60_merged_df[mids_min60_merged_df$Player %in% mid_player_list,]

dim(mids_min60_merged_df)
#[1] 2600  125


length(unique(mids_min60_merged_df$Player))
#[1] 143

#calculate xFpts for midfielders
mids_min60_merged_df$xPts <- mids_min60_merged_df$FPts - (mids_min60_merged_df$G * 9 + mids_min60_merged_df$AT * 6)
mids_min60_merged_df$xPts <- mids_min60_merged_df$xPts + (as.numeric(mids_min60_merged_df$xG)* 9 + as.numeric(mids_min60_merged_df$xA) * 6)

# forwards

#load in just forwards
players_min_starts.forwards = players_min_5_starts_summary_df[players_min_5_starts_summary_df$Position == 'F',]
nrow(players_min_starts.forwards)

for_player_list <- players_min_starts.forwards$Player

length(for_player_list)
#[1] 71


#filter on fantrax forwards
fwds_min60_merged_df <- min60_merged_df[min60_merged_df$Position == "F",]

length(unique(fwds_min60_merged_df$Player))
#[1] 81

sum(for_player_list %in% unique(fwds_min60_merged_df$Player))
#[1] 71
#so they are all there

#see which players are extra in this group
Players_fwds_min60_merged_df<-unique(fwds_min60_merged_df$Player)

Players_fwds_min60_merged_df[Players_for_min60_merged_df %!in% for_player_list]
 #[1] "Adam Idah"           "Alireza Jahanbakhsh" "Andre Gray"          "Andy Carroll"       
 #[5] "Josip Drmic"         "Michy Batshuayi"     "Reiss Nelson"        "William Smallbone"  
 #[9] "Xherdan Shaqiri"     "Yoshinori Muto"

summary_min_60_df[summary_min_60_df$Player == "William Smallbone",]

summary_min_60_df[summary_min_60_df$Player == "Andre Gray",]

#they are players who havent have 5 starts

#remove the under 5 games players
fwds_min60_merged_df <- for_min60_merged_df[for_min60_merged_df$Player %in% for_player_list,]

dim(fwds_min60_merged_df)
#[1] 1314  125

length(unique(fwds_min60_merged_df$Player))
#[1] 71

#calculate xFpts for forwards
fwds_min60_merged_df$xPts <- fwds_min60_merged_df$FPts - (fwds_min60_merged_df$G * 9 + fwds_min60_merged_df$AT * 6)
fwds_min60_merged_df$xPts <- fwds_min60_merged_df$xPts + (as.numeric(fwds_min60_merged_df$xG)* 9 + as.numeric(fwds_min60_merged_df$xA) * 6)

#remove some extra fields in midfielders and forwards
# drops <- names(mids_min60_merged_df)[names(mids_min60_merged_df) %!in% names(defenders_min60_merged_cs_df)]

#remove some extra defender columns
#drops <- c("normed_xg_against","GAD_against", 'xG_against')
#fwds_min60_merged_df <- fwds_min60_merged_df[ , !(names(fwds_min60_merged_df) %in% drops)]

#drops <- c("normed_xg_against","GAD_against", 'xG_against')
#mids_min60_merged_df <- mids_min60_merged_df[ , !(names(mids_min60_merged_df) %in% drops)]

#combine all the position dataframes into one
all_combined_df <- rbind(defenders_min60_merged_cs_df, fwds_min60_merged_df, mids_min60_merged_df)
```

#collect the data for with team postion information
```{r}
#make a summary file
summary_all_combined_df <- all_combined_df %>% 
  group_by(Team.x, Pos) %>%
  summarize(n = n(), num_diff_players = length(unique(Player)) , min_total = sum(Min.x), sd_emp_pts = sd(FPts), sd_xpts = sd(xPts),   mean_emp_pts = mean(FPts), mean_xPts = mean(xPts), med_emp_pts= median(FPts), med_xPts = median(xPts), total_emp_fpts = sum(FPts),   total_xPts = sum(xPts), mean_minutes = mean(Min.x))

#remove team positions that do not have at least 10 occurances (mainly to remove the double position entries)
min_10_examples <- summary_all_combined_df[summary_all_combined_df$n >= 10,]

min_10_examples$Team_Pos <- paste(min_10_examples$Team.x, min_10_examples$Pos, sep = "_")

#write to file
write.csv(x=min_10_examples, file="../data/fantrax_data/pos_group_20200721.csv")


# collecting the team position data but keep the players
all_combined_Team_Pos <- all_combined_df
all_combined_Team_Pos$Team_Pos <- paste(all_combined_df$Team.x, all_combined_df$Pos, sep = "_")

dim(all_combined_Team_Pos)
#[1] 6629  127

#filter out any team positions that have not occurred 10 times
all_combined_Team_Pos_min_10 <- all_combined_Team_Pos %>% group_by(Team_Pos) %>% filter(n()>= 10)

dim(all_combined_Team_Pos_min_10)
#[1] 5791  127

length(unique(all_combined_Team_Pos_min_10$Team_Pos))
#[1] 161

#try plotting it by team position
#xFpts plot
ggplot(all_combined_Team_Pos_min_10, aes(x = reorder(Team_Pos, xPts, FUN = median ), y = xPts)) + geom_boxplot()  + theme_minimal() + theme(axis.text.x = element_text(angle = 90)) +ggtitle("xFpts for Team Positions")

```

#Make top 20 team positions in the EPL
```{r}
#sort min_10_examples to find the top 20 team positions

#sort on median xFpts
min_10_examples_sorted <- min_10_examples[order(- min_10_examples$med_xPts),]

#take the top 20 team_pos
min_10_examples_sorted_top20 <- head(min_10_examples_sorted, 20)

#prep team colors
library(RColorBrewer)

unique(min_10_examples_sorted$Team.x)
 #[1] "MCI" "CHE" "EVE" "NOR" "LIV" "WOL" "TOT" "WAT" "LEI" "WHU" "AVL" "BHA" "ARS" "MUN" "SOU" "SHU" "CRY" "BUR" "NEW" "BOU"

team_colors <- c(
          '#c8102E',
          '#6CABDD',
          '#003090',
          '#034694',
          '#DA291C',
          '#FDB913',
          "#132257",
          "#ee2737",
          "#EF0107",
          "#1B458F",
          "#6C1D45",
          "#003399",
          "white",
          "#d71920",
          "#0057B8",
          "#FBEE23",
          "#7A263A",
          "#DA291C",
          "#670e36",
          "#00A650")
teams = c('LIV',
          'MCI',
          'LEI',
          'CHE',
          'MUN',
          'WOL',
          "TOT",
          "SHU",
          "ARS",
          "CRY",
          "BUR",
          "EVE",
          "NEW",
          "SOU",
          "BHA",
          "WAT",
          "WHU",
          "BOU",
          "AVL",
          "NOR")
names(team_colors) <- teams
colScale <- scale_colour_manual(name = "opposition",values = team_colors)
fillScale <- scale_fill_manual(name = "opposition",values = team_colors, guide = FALSE)

#filter for just top 20 team_pos in all_combined_Team_Pos_min_10
#filter so it is only team pos that there is no statistical difference in players

all_combined_Team_Pos_min_10_top_20 <- all_combined_Team_Pos_min_10[all_combined_Team_Pos_min_10$Team_Pos %in% unique(min_10_examples_sorted_top20$Team_Pos) ,]
#

dim(all_combined_Team_Pos_min_10_top_20)
#[1] 551 127

length( unique(min_10_examples_sorted_top20$Team_Pos))
#[1] 20

length( unique(all_combined_Team_Pos_min_10_top_20$Team_Pos))
#[1] 20

#make a team-position field with no underscore
all_combined_Team_Pos_min_10_top_20$Team_space_Pos <- gsub("_", " ", all_combined_Team_Pos_min_10_top_20$Team_Pos)

#plot the top 20 team_pos


ggplot(all_combined_Team_Pos_min_10_top_20, aes(x = reorder(Team_space_Pos, xPts, FUN = median ), y = xPts, fill = Team.x)) + geom_boxplot()  + theme_minimal() + theme(axis.text.x = element_text(angle = 90)) + ggtitle("xFpts for the top 20 Team-Positions") + xlab("Team-Position") + ylab("xFpts") + colScale + fillScale

#ggplot(all_combined_Team_Pos_min_10, aes(x = reorder(Team_Pos, xPts, FUN = median ), y = xPts)) + geom_boxplot()  + theme_minimal() + theme(axis.text.x = element_text(angle = 90)) +ggtitle("xFpts for Team Positions")


#ggplot(MCI_LW_data, aes(Player, xPts)) + geom_boxplot(aes(colour = Player), outlier.shape = NA) + geom_jitter(width = 0.2, aes(colour = MCI_LW_data$Player)) + theme_minimal() + theme(axis.text.x = element_text(angle = 45)) +ggtitle("MCI_LW xFpt for each player")

#summarize number of players per team position
all_combined_Team_Pos_min_10_top_20_summ <- all_combined_Team_Pos_min_10_top_20 %>% group_by(Team_Pos) %>% summarize(n = n(), num_diff_players = length(unique(Player)),medxPts = median(xPts))

#sort on median xFpts
all_combined_Team_Pos_min_10_top_20_summ_sorted <- all_combined_Team_Pos_min_10_top_20_summ[order(- all_combined_Team_Pos_min_10_top_20_summ$medxPts),]

write.csv(all_combined_Team_Pos_min_10_top_20_summ_sorted, file="../data/fbref/premier_league/19_20/all_combined_Team_Pos_min_10_top_20_summ.csv")

```

#Regenerate top 20 team positions in the EPL with updated data NO number of starts filter

## Data setup

```{r data_setup}
#load all player data for fbref.com
weekly_data_csv = "../data/fantrax_data/weekly.all_data_combined.no_double_gws.csv"
yearly_data_csv = "../data/fantrax_data/yearly.all_data_combined.csv"

weekly_data_df <- read_csv(file = weekly_data_csv, col_names = TRUE)
yearly_data_df <- read_csv(file = yearly_data_csv, col_names = TRUE)

# Only weeks where at least 60 minutes are played
min_60_min_df <- weekly_data_df[weekly_data_df$Min > 59,]
# Players that have started at least 5 games
summary_min_60_df <- min_60_min_df %>% 
  group_by(Player, Team, Position) %>%
  summarize(n = n(), min_total = sum(Min), sd = sd(FPts), mean = mean(FPts), total_fpts = sum(FPts), mean_minutes = mean(Min))

#only players with at least 5 starts
players_min_5_starts_summary_df <- summary_min_60_df[summary_min_60_df$n >= 5,]

player_min_5_starts_weekly_df <- min_60_min_df %>%
  filter(Player %in% players_min_5_starts_summary_df$Player)
nrow(player_min_5_starts_weekly_df)

```

## get xFpts

```{r gather_xfpt_df}


# load in just defenders
#players_min_starts.defenders = players_min_5_starts_summary_df[players_min_5_starts_summary_df$Position == 'D',]
#nrow(players_min_starts.defenders)
#def_player_list <- players_min_starts.defenders$Player
#length(def_player_list)


#read in fbref_summary data
fbref_summ_df <- read_csv('../data/fbref/premier_league/19_20/name_cleaned.summary_table.first_360_matches.csv')

dim(fbref_summ_df)
#[1] 10025    35

#clean sheet data
cs_df <- read_csv('../data/fantrax_data/game_results.csv')

#add game week to fbref_summ_df from cs_df

date_to_week_df <- as.data.frame(cbind(cs_df$Date, cs_df$Wk))

colnames(date_to_week_df) <- c("Date","game_week")

date_to_week_df <- distinct(date_to_week_df)

fbref_summ_df<- merge(fbref_summ_df, date_to_week_df, by="Date")

dim(fbref_summ_df)
#[1] 10025    36
#correct dims

#write to file
#write.csv(x=fbref_summ_df, file="../data/fbref/premier_league/19_20/name_cleaned.summary_table.first_360_matches_game_week.csv")

#convert game_week to numeric
fbref_summ_df$game_week <- as.character(fbref_summ_df$game_week)
fbref_summ_df$game_week <- as.numeric(fbref_summ_df$game_week)

#write to file
write.csv(x=fbref_summ_df, file="../data/fbref/premier_league/19_20/name_cleaned.summary_table.first_360_matches_game_week.csv")

#merge on player and game week
min60_merged_df <- merge(min_60_min_df, fbref_summ_df, by=c('Player', 'game_week'))


dim(min60_merged_df)
#[1] 6764  125

table(min60_merged_df$Position)

#   D    F    M 
#2764 1342 2658 

#filter on fantrax defenders
defenders_min60_merged_df <- min60_merged_df[min60_merged_df$Position == "D",]

length(unique(defenders_min60_merged_df$Player))
#[1] 161

sum(def_player_list %in% unique(defenders_min60_merged_df$Player))
#[1] 138
#so they are all there

#see which players are extra in this group
Players_defenders_min60_merged_df<-unique(defenders_min60_merged_df$Player)

Players_defenders_min60_merged_df[Players_defenders_min60_merged_df %!in% def_player_list]
#[1] "Axel Tuanzebe"       "Charlie Daniels"     "Diogo Dalot"         "Eric Bailly"        
 #[5] "Ezequiel Schelotto"  "Jack Robinson"       "Jack Simpson"        "Jake Vokins"        
 #[9] "Jarrad Branthwaite"  "Jeremy Ngakia"       "Kevin Danso"         "Kevin Long"         
#[13] "Leighton Baines"     "Luke Thomas"         "Maximilian Kilman"   "Neco Williams"      
#[17] "Pablo Mari"          "Phil Jagielka"       "Phil Jones"          "Rob Holding"        
#[21] "Tariq Lamptey"       "Timothy Fosu-Mensah" "Wes Morgan"

#they are players who havent have 5 starts

#remove the under 5 games players
#defenders_min60_merged_df <- defenders_min60_merged_df[defenders_min60_merged_df$Player %in% def_player_list,]

dim(defenders_min60_merged_df)
#[1] 2764  125

#just get the important stuff for clean sheets (name "Team.y" for easy merge in a sec)
all_cs_data_df <- data.frame('Team.y' = c(cs_df$Home, cs_df$Away), 'xG_against' = c(cs_df$xG_1, cs_df$xG), 'game_week' = c(cs_df$Wk, cs_df$Wk))

#convert squad to character all_cs_data_df for merge
all_cs_data_df$Team.y <- as.character(all_cs_data_df$Team.y)

#merge cs and defender data
defenders_min60_merged_cs_df <- merge(defenders_min60_merged_df, all_cs_data_df, by=c("Team.y", "game_week"))

dim(defenders_min60_merged_cs_df)
#[1] 2764  126

#calculate xFpts from cs given xG against
defenders_min60_merged_cs_df$GAD_against <- ifelse(defenders_min60_merged_cs_df$xG_against - 0.25 < 0, 0, defenders_min60_merged_cs_df$xG_against - 0.25)

defenders_min60_merged_cs_df$normed_xg_against <- ifelse(defenders_min60_merged_cs_df$GAD_against <= 1.25, 1 - defenders_min60_merged_cs_df$GAD_against/1.25, 0)

#calculate xFpts for defenders
defenders_min60_merged_cs_df$xPts <- defenders_min60_merged_cs_df$FPts - (defenders_min60_merged_cs_df$G * 10 + defenders_min60_merged_cs_df$AT * 8 + defenders_min60_merged_cs_df$CS * 6 + defenders_min60_merged_cs_df$GAD * -2) + (as.numeric(defenders_min60_merged_cs_df$xG)* 10 + as.numeric(defenders_min60_merged_cs_df$xA) * 8 + as.numeric(defenders_min60_merged_cs_df$normed_xg_against)* 6 + as.numeric(defenders_min60_merged_cs_df$GAD_against) * -2)

#remove some extra defender columns
drops <- c("normed_xg_against","GAD_against", 'xG_against')
defenders_min60_merged_cs_df <- defenders_min60_merged_cs_df[ , !(names(defenders_min60_merged_cs_df) %in% drops)]

# midfielders

#load in just midfielders
#players_min_starts.midfielders = players_min_5_starts_summary_df[players_min_5_starts_summary_df$Position == 'M',]
#nrow(players_min_starts.midfielders)
#mid_player_list <- players_min_starts.midfielders$Player

#length(mid_player_list)
#[1] 143

#filter on fantrax midfielders
mids_min60_merged_df <- min60_merged_df[min60_merged_df$Position == "M",]

length(unique(mids_min60_merged_df$Player))
#[1] 168

#sum(mid_player_list %in% unique(mids_min60_merged_df$Player))
#[1] 143
#so they are all there

#see which players are extra in this group
Players_mids_min60_merged_df<-unique(mids_min60_merged_df$Player)

Players_mids_min60_merged_df[Players_mids_min60_merged_df %!in% mid_player_list]
#[1] "Aaron Lennon"         "Adam Lallana"         "Alexis Mac Allister"  "Andrew Surman"       
#[5] "Anthony Gordon"       "Ben Johnson"          "Ben Osborn"           "Billy Gilmour"       
#[9] "Carlos Sanchez"       "Curtis Jones"         "Daniel Drinkwater"    "Daniel Podence"      
#[13] "Demarai Gray"         "Henri Lansbury"       "Jean-Philippe Gbamin" "Jota"                
#[17] "Keinan Davis"         "Luke Freeman"         "Morgan Gibbs-White"   "Muhamed Besic"       
#[21] "Nampalys Mendy"       "Robbie Brady"         "Ruben Loftus-Cheek"   "Ryan Sessegnon"      
#[25] "Valentino Lazaro"



dim(mids_min60_merged_df)
#[1] 2658  125


length(unique(mids_min60_merged_df$Player))
#[1] 168

#calculate xFpts for midfielders
mids_min60_merged_df$xPts <- mids_min60_merged_df$FPts - (mids_min60_merged_df$G * 9 + mids_min60_merged_df$AT * 6)
mids_min60_merged_df$xPts <- mids_min60_merged_df$xPts + (as.numeric(mids_min60_merged_df$xG)* 9 + as.numeric(mids_min60_merged_df$xA) * 6)

# forwards

#load in just forwards
#players_min_starts.forwards = players_min_5_starts_summary_df[players_min_5_starts_summary_df$Position == 'F',]
#nrow(players_min_starts.forwards)

#for_player_list <- players_min_starts.forwards$Player

#length(for_player_list)
#[1] 71


#filter on fantrax forwards
fwds_min60_merged_df <- min60_merged_df[min60_merged_df$Position == "F",]

length(unique(fwds_min60_merged_df$Player))
#[1] 81

#sum(for_player_list %in% unique(fwds_min60_merged_df$Player))
#[1] 71
#so they are all there

#see which players are extra in this group
Players_fwds_min60_merged_df<-unique(fwds_min60_merged_df$Player)

Players_fwds_min60_merged_df[Players_for_min60_merged_df %!in% for_player_list]
 #[1] "Adam Idah"           "Alireza Jahanbakhsh" "Andre Gray"          "Andy Carroll"       
 #[5] "Josip Drmic"         "Michy Batshuayi"     "Reiss Nelson"        "William Smallbone"  
 #[9] "Xherdan Shaqiri"     "Yoshinori Muto"

dim(fwds_min60_merged_df)
#[1] 1342  125

length(unique(fwds_min60_merged_df$Player))
#[1] 81

#calculate xFpts for forwards
fwds_min60_merged_df$xPts <- fwds_min60_merged_df$FPts - (fwds_min60_merged_df$G * 9 + fwds_min60_merged_df$AT * 6)
fwds_min60_merged_df$xPts <- fwds_min60_merged_df$xPts + (as.numeric(fwds_min60_merged_df$xG)* 9 + as.numeric(fwds_min60_merged_df$xA) * 6)

#combine all the position dataframes into one
all_combined_df <- rbind(defenders_min60_merged_cs_df, fwds_min60_merged_df, mids_min60_merged_df)
```


#collect the data for with team postion information
```{r}
#make a summary file
summary_all_combined_df <- all_combined_df %>% 
  group_by(Team.x, Pos) %>%
  summarize(n = n(), num_diff_players = length(unique(Player)) , min_total = sum(Min.x), sd_emp_pts = sd(FPts), sd_xpts = sd(xPts),   mean_emp_pts = mean(FPts), mean_xPts = mean(xPts), med_emp_pts= median(FPts), med_xPts = median(xPts), total_emp_fpts = sum(FPts),   total_xPts = sum(xPts), mean_minutes = mean(Min.x))

#remove team positions that do not have at least 10 occurances (mainly to remove the double position entries)
min_10_examples <- summary_all_combined_df[summary_all_combined_df$n >= 10,]

min_10_examples$Team_Pos <- paste(min_10_examples$Team.x, min_10_examples$Pos, sep = "_")

#write to file
write.csv(x=min_10_examples, file="../data/fantrax_data/pos_group_20200722_no_starts_min.csv")


# collecting the team position data but keep the players
all_combined_Team_Pos <- all_combined_df
all_combined_Team_Pos$Team_Pos <- paste(all_combined_df$Team.x, all_combined_df$Pos, sep = "_")

dim(all_combined_Team_Pos)
#[1] 6764  127

#filter out any team positions that have not occurred 10 times
all_combined_Team_Pos_min_10 <- all_combined_Team_Pos %>% group_by(Team_Pos) %>% filter(n()>= 10)

dim(all_combined_Team_Pos_min_10)
#[1] 5907  127

length(unique(all_combined_Team_Pos_min_10$Team_Pos))
#[1] 161

#try plotting it by team position
#xFpts plot
ggplot(all_combined_Team_Pos_min_10, aes(x = reorder(Team_Pos, xPts, FUN = median ), y = xPts)) + geom_boxplot()  + theme_minimal() + theme(axis.text.x = element_text(angle = 90)) +ggtitle("xFpts for Team Positions")

```

#Remake top 20 team positions in the EPL
```{r}
#sort min_10_examples to find the top 20 team positions

#sort on median xFpts
min_10_examples_sorted <- min_10_examples[order(- min_10_examples$med_xPts),]

#take the top 20 team_pos
min_10_examples_sorted_top20 <- head(min_10_examples_sorted, 20)

#prep team colors
library(RColorBrewer)

unique(min_10_examples_sorted$Team.x)
 #[1] "MCI" "CHE" "EVE" "NOR" "LIV" "WOL" "TOT" "WAT" "LEI" "WHU" "AVL" "BHA" "ARS" "MUN" "SOU" "SHU" "CRY" "BUR" "NEW" "BOU"

team_colors <- c(
          '#c8102E',
          '#6CABDD',
          '#003090',
          '#034694',
          '#DA291C',
          '#FDB913',
          "#132257",
          "#ee2737",
          "#EF0107",
          "#1B458F",
          "#6C1D45",
          "#003399",
          "white",
          "#d71920",
          "#0057B8",
          "#FBEE23",
          "#7A263A",
          "#DA291C",
          "#670e36",
          "#00A650")
teams = c('LIV',
          'MCI',
          'LEI',
          'CHE',
          'MUN',
          'WOL',
          "TOT",
          "SHU",
          "ARS",
          "CRY",
          "BUR",
          "EVE",
          "NEW",
          "SOU",
          "BHA",
          "WAT",
          "WHU",
          "BOU",
          "AVL",
          "NOR")
names(team_colors) <- teams
colScale <- scale_colour_manual(name = "opposition",values = team_colors)
fillScale <- scale_fill_manual(name = "opposition",values = team_colors, guide = FALSE)

#filter for just top 20 team_pos in all_combined_Team_Pos_min_10
#filter so it is only team pos that there is no statistical difference in players

all_combined_Team_Pos_min_10_top_20 <- all_combined_Team_Pos_min_10[all_combined_Team_Pos_min_10$Team_Pos %in% unique(min_10_examples_sorted_top20$Team_Pos) ,]
#

dim(all_combined_Team_Pos_min_10_top_20)
#[1] 560 127

length( unique(min_10_examples_sorted_top20$Team_Pos))
#[1] 20

length( unique(all_combined_Team_Pos_min_10_top_20$Team_Pos))
#[1] 20

#make a team-position field with no underscore
all_combined_Team_Pos_min_10_top_20$Team_space_Pos <- gsub("_", " ", all_combined_Team_Pos_min_10_top_20$Team_Pos)

#plot the top 20 team_pos


ggplot(all_combined_Team_Pos_min_10_top_20, aes(x = reorder(Team_space_Pos, xPts, FUN = median ), y = xPts, fill = Team.x)) + geom_boxplot()  + theme_minimal() + theme(axis.text.x = element_text(angle = 90)) + ggtitle("xFpts for the top 20 Team-Positions") + xlab("Team-Position") + ylab("xFpts") + colScale + fillScale + theme(plot.title = element_text(hjust = 0.5))

#ggplot(all_combined_Team_Pos_min_10, aes(x = reorder(Team_Pos, xPts, FUN = median ), y = xPts)) + geom_boxplot()  + theme_minimal() + theme(axis.text.x = element_text(angle = 90)) +ggtitle("xFpts for Team Positions")


#ggplot(MCI_LW_data, aes(Player, xPts)) + geom_boxplot(aes(colour = Player), outlier.shape = NA) + geom_jitter(width = 0.2, aes(colour = MCI_LW_data$Player)) + theme_minimal() + theme(axis.text.x = element_text(angle = 45)) +ggtitle("MCI_LW xFpt for each player")

#summarize number of players per team position
all_combined_Team_Pos_min_10_top_20_summ <- all_combined_Team_Pos_min_10_top_20 %>% group_by(Team_Pos) %>% summarize(n = n(), num_diff_players = length(unique(Player)),medxPts = median(xPts))

#sort on median xFpts
all_combined_Team_Pos_min_10_top_20_summ_sorted <- all_combined_Team_Pos_min_10_top_20_summ[order(- all_combined_Team_Pos_min_10_top_20_summ$medxPts),]

write.csv(all_combined_Team_Pos_min_10_top_20_summ_sorted, file="../data/fbref/premier_league/19_20/all_combined_Team_Pos_min_10_top_20_summ_no_min_start.csv")

```

# Rerun BUR_CB, MUN_CB, and WOL_CB analysis CB analysis

## Resetup the data

```{r data_setup}
#load all player data for fbref.com
weekly_data_csv = "../data/fantrax_data/weekly.all_data_combined.no_double_gws.csv"
yearly_data_csv = "../data/fantrax_data/yearly.all_data_combined.csv"

weekly_data_df <- read_csv(file = weekly_data_csv, col_names = TRUE)
yearly_data_df <- read_csv(file = yearly_data_csv, col_names = TRUE)

# Only weeks where at least 60 minutes are played
min_60_min_df <- weekly_data_df[weekly_data_df$Min > 59,]
# Players that have started at least 5 games
summary_min_60_df <- min_60_min_df %>% 
  group_by(Player, Team, Position) %>%
  summarize(n = n(), min_total = sum(Min), sd = sd(FPts), mean = mean(FPts), total_fpts = sum(FPts), mean_minutes = mean(Min))

#only players with at least 5 starts
players_min_5_starts_summary_df <- summary_min_60_df[summary_min_60_df$n >= 5,]

player_min_5_starts_weekly_df <- min_60_min_df %>%
  filter(Player %in% players_min_5_starts_summary_df$Player)
nrow(player_min_5_starts_weekly_df)

```

## get xFpts

```{r gather_xfpt_df}


#read in fbref_summary data
fbref_summ_df <- read_csv('../data/fbref/premier_league/19_20/name_cleaned.summary_table.first_360_matches.csv')

dim(fbref_summ_df)
#[1] 10025    35

#clean sheet data
cs_df <- read_csv('../data/fantrax_data/game_results.csv')

#add game week to fbref_summ_df from cs_df

date_to_week_df <- as.data.frame(cbind(cs_df$Date, cs_df$Wk))

colnames(date_to_week_df) <- c("Date","game_week")

date_to_week_df <- distinct(date_to_week_df)

fbref_summ_df<- merge(fbref_summ_df, date_to_week_df, by="Date")

dim(fbref_summ_df)
#[1] 10025    36
#correct dims

#convert game_week to numeric
fbref_summ_df$game_week <- as.character(fbref_summ_df$game_week)
fbref_summ_df$game_week <- as.numeric(fbref_summ_df$game_week)

#merge on player and game week
min60_merged_df <- merge(min_60_min_df, fbref_summ_df, by=c('Player', 'game_week'))


dim(min60_merged_df)
#[1] 6764  125

table(min60_merged_df$Position)

#   D    F    M 
#2764 1342 2658 

players_min_starts.defenders = players_min_5_starts_summary_df[players_min_5_starts_summary_df$Position == 'D',]
#nrow(players_min_starts.forwards)

def_player_list <- players_min_starts.defenders$Player

#filter on fantrax defenders
defenders_min60_merged_df <- min60_merged_df[min60_merged_df$Position == "D",]

length(unique(defenders_min60_merged_df$Player))
#[1] 161

#see which players are extra in this group
Players_defenders_min60_merged_df<-unique(defenders_min60_merged_df$Player)

Players_defenders_min60_merged_df[Players_defenders_min60_merged_df %!in% def_player_list]
#[1] "Axel Tuanzebe"       "Charlie Daniels"     "Diogo Dalot"         "Eric Bailly"        
 #[5] "Ezequiel Schelotto"  "Jack Robinson"       "Jack Simpson"        "Jake Vokins"        
 #[9] "Jarrad Branthwaite"  "Jeremy Ngakia"       "Kevin Danso"         "Kevin Long"         
#[13] "Leighton Baines"     "Luke Thomas"         "Maximilian Kilman"   "Neco Williams"      
#[17] "Pablo Mari"          "Phil Jagielka"       "Phil Jones"          "Rob Holding"        
#[21] "Tariq Lamptey"       "Timothy Fosu-Mensah" "Wes Morgan"

#they are players who havent have 5 starts

#remove the under 5 games players
defenders_min60_merged_df <- defenders_min60_merged_df[defenders_min60_merged_df$Player %in% def_player_list,]

dim(defenders_min60_merged_df)
#[1] 2715  125

#just get the important stuff for clean sheets (name "Team.y" for easy merge in a sec)
all_cs_data_df <- data.frame('Team.y' = c(cs_df$Home, cs_df$Away), 'xG_against' = c(cs_df$xG_1, cs_df$xG), 'game_week' = c(cs_df$Wk, cs_df$Wk))

#convert squad to character all_cs_data_df for merge
all_cs_data_df$Team.y <- as.character(all_cs_data_df$Team.y)

#merge cs and defender data
defenders_min60_merged_cs_df <- merge(defenders_min60_merged_df, all_cs_data_df, by=c("Team.y", "game_week"))

dim(defenders_min60_merged_cs_df)
#[1] 2764  126

#calculate xFpts from cs given xG against
defenders_min60_merged_cs_df$GAD_against <- ifelse(defenders_min60_merged_cs_df$xG_against - 0.25 < 0, 0, defenders_min60_merged_cs_df$xG_against - 0.25)

defenders_min60_merged_cs_df$normed_xg_against <- ifelse(defenders_min60_merged_cs_df$GAD_against <= 1.25, 1 - defenders_min60_merged_cs_df$GAD_against/1.25, 0)

#calculate xFpts for defenders
defenders_min60_merged_cs_df$xPts <- defenders_min60_merged_cs_df$FPts - (defenders_min60_merged_cs_df$G * 10 + defenders_min60_merged_cs_df$AT * 8 + defenders_min60_merged_cs_df$CS * 6 + defenders_min60_merged_cs_df$GAD * -2) + (as.numeric(defenders_min60_merged_cs_df$xG)* 10 + as.numeric(defenders_min60_merged_cs_df$xA) * 8 + as.numeric(defenders_min60_merged_cs_df$normed_xg_against)* 6 + as.numeric(defenders_min60_merged_cs_df$GAD_against) * -2)

#remove some extra defender columns
drops <- c("normed_xg_against","GAD_against", 'xG_against')
defenders_min60_merged_cs_df <- defenders_min60_merged_cs_df[ , !(names(defenders_min60_merged_cs_df) %in% drops)]

# midfielders
players_min_starts.midfielders = players_min_5_starts_summary_df[players_min_5_starts_summary_df$Position == 'M',]
#nrow(players_min_starts.forwards)

mid_player_list <- players_min_starts.midfielders$Player

#filter on fantrax midfielders
mids_min60_merged_df <- min60_merged_df[min60_merged_df$Position == "M",]

length(unique(mids_min60_merged_df$Player))
#[1] 168

sum(mid_player_list %in% unique(mids_min60_merged_df$Player))
#[1] 143
#so they are all there

#see which players are extra in this group
Players_mids_min60_merged_df<-unique(mids_min60_merged_df$Player)

Players_mids_min60_merged_df[Players_mids_min60_merged_df %!in% mid_player_list]
#[1] "Aaron Lennon"         "Adam Lallana"         "Alexis Mac Allister"  "Andrew Surman"       
#[5] "Anthony Gordon"       "Ben Johnson"          "Ben Osborn"           "Billy Gilmour"       
#[9] "Carlos Sanchez"       "Curtis Jones"         "Daniel Drinkwater"    "Daniel Podence"      
#[13] "Demarai Gray"         "Henri Lansbury"       "Jean-Philippe Gbamin" "Jota"                
#[17] "Keinan Davis"         "Luke Freeman"         "Morgan Gibbs-White"   "Muhamed Besic"       
#[21] "Nampalys Mendy"       "Robbie Brady"         "Ruben Loftus-Cheek"   "Ryan Sessegnon"      
#[25] "Valentino Lazaro"

#remove the under 5 games players
mids_min60_merged_df <- mids_min60_merged_df[mids_min60_merged_df$Player %in% mid_player_list,]

dim(mids_min60_merged_df)
#[1] 2600  125


length(unique(mids_min60_merged_df$Player))
#[1] 143

#calculate xFpts for midfielders
mids_min60_merged_df$xPts <- mids_min60_merged_df$FPts - (mids_min60_merged_df$G * 9 + mids_min60_merged_df$AT * 6)
mids_min60_merged_df$xPts <- mids_min60_merged_df$xPts + (as.numeric(mids_min60_merged_df$xG)* 9 + as.numeric(mids_min60_merged_df$xA) * 6)

# forwards

#load in just forwards
players_min_starts.forwards = players_min_5_starts_summary_df[players_min_5_starts_summary_df$Position == 'F',]
#nrow(players_min_starts.forwards)

for_player_list <- players_min_starts.forwards$Player

length(for_player_list)
#[1] 71


#filter on fantrax forwards
fwds_min60_merged_df <- min60_merged_df[min60_merged_df$Position == "F",]

length(unique(fwds_min60_merged_df$Player))
#[1] 81

#see which players are extra in this group
Players_fwds_min60_merged_df<-unique(fwds_min60_merged_df$Player)

Players_fwds_min60_merged_df[Players_for_min60_merged_df %!in% for_player_list]
 #[1] "Adam Idah"           "Alireza Jahanbakhsh" "Andre Gray"          "Andy Carroll"       
 #[5] "Josip Drmic"         "Michy Batshuayi"     "Reiss Nelson"        "William Smallbone"  
 #[9] "Xherdan Shaqiri"     "Yoshinori Muto"

#remove the under 5 games players
fwds_min60_merged_df <- fwds_min60_merged_df[fwds_min60_merged_df$Player %in% for_player_list,]

dim(fwds_min60_merged_df)
#[1] 1314  125

length(unique(fwds_min60_merged_df$Player))
#[1] 71

#calculate xFpts for forwards
fwds_min60_merged_df$xPts <- fwds_min60_merged_df$FPts - (fwds_min60_merged_df$G * 9 + fwds_min60_merged_df$AT * 6)
fwds_min60_merged_df$xPts <- fwds_min60_merged_df$xPts + (as.numeric(fwds_min60_merged_df$xG)* 9 + as.numeric(fwds_min60_merged_df$xA) * 6)

#combine all the position dataframes into one
all_combined_df <- rbind(defenders_min60_merged_cs_df, fwds_min60_merged_df, mids_min60_merged_df)
```


#collect the data for with team postion information
```{r}
#make a summary file
summary_all_combined_df <- all_combined_df %>% 
  group_by(Team.x, Pos) %>%
  summarize(n = n(), num_diff_players = length(unique(Player)) , min_total = sum(Min.x), sd_emp_pts = sd(FPts), sd_xpts = sd(xPts),   mean_emp_pts = mean(FPts), mean_xPts = mean(xPts), med_emp_pts= median(FPts), med_xPts = median(xPts), total_emp_fpts = sum(FPts),   total_xPts = sum(xPts), mean_minutes = mean(Min.x))

#remove team positions that do not have at least 10 occurances (mainly to remove the double position entries)
min_10_examples <- summary_all_combined_df[summary_all_combined_df$n >= 10,]

min_10_examples$Team_Pos <- paste(min_10_examples$Team.x, min_10_examples$Pos, sep = "_")

#write to file
#write.csv(x=min_10_examples, file="../data/fantrax_data/pos_group_20200722_no_starts_min.csv")


# collecting the team position data but keep the players
all_combined_Team_Pos <- all_combined_df
all_combined_Team_Pos$Team_Pos <- paste(all_combined_df$Team.x, all_combined_df$Pos, sep = "_")

dim(all_combined_Team_Pos)
#[1] 6629  127

#filter out any team positions that have not occurred 10 times
all_combined_Team_Pos_min_10 <- all_combined_Team_Pos %>% group_by(Team_Pos) %>% filter(n()>= 10)

dim(all_combined_Team_Pos_min_10)
#[1] 5791  127

length(unique(all_combined_Team_Pos_min_10$Team_Pos))
#[1] 161

#try plotting it by team position
#xFpts plot
ggplot(all_combined_Team_Pos_min_10, aes(x = reorder(Team_Pos, xPts, FUN = median ), y = xPts)) + geom_boxplot()  + theme_minimal() + theme(axis.text.x = element_text(angle = 90)) +ggtitle("xFpts for Team Positions")

```

```{r}

#read in pos_group_20200721.csv
min_10_examples<- read.csv(file="../data/fantrax_data/pos_group_20200721.csv")


# collecting the team position data but keep the players
all_combined_Team_Pos <- all_combined_df
all_combined_Team_Pos$Team_Pos <- paste(all_combined_df$Team.x, all_combined_df$Pos, sep = "_")

#take a quick look
#MUN_CB
MUN_CB_data <- as.data.frame(all_combined_Team_Pos[all_combined_Team_Pos$Team_Pos == "MUN_CB",])

ggplot(MUN_CB_data, aes(Player, xPts)) + geom_boxplot(aes(colour = Player), outlier.shape = NA) + geom_jitter(width = 0.2, aes(colour = MUN_CB_data$Player)) + theme_minimal() + theme(axis.text.x = element_text(angle = 45)) +ggtitle("MUN_CB xFpt for each player")

#WOL_CB
WOL_CB_data <- as.data.frame(all_combined_Team_Pos[all_combined_Team_Pos$Team_Pos == "WOL_CB",])

ggplot(WOL_CB_data, aes(Player, xPts)) + geom_boxplot(aes(colour = Player), outlier.shape = NA) + geom_jitter(width = 0.2, aes(colour = WOL_CB_data$Player)) + theme_minimal() + theme(axis.text.x = element_text(angle = 45)) +ggtitle("WOL_CB xFpt for each player")
#Willy Boly is better

#BUR_CB
BUR_CB_data <- as.data.frame(all_combined_Team_Pos[all_combined_Team_Pos$Team_Pos == "BUR_CB",])

ggplot(BUR_CB_data, aes(Player, xPts)) + geom_boxplot(aes(colour = Player), outlier.shape = NA) + geom_jitter(width = 0.2, aes(colour = BUR_CB_data$Player)) + theme_minimal() + theme(axis.text.x = element_text(angle = 45)) +ggtitle("BUR_CB xFpt for each player")


#fixed in the rerun, so not needed
#fix a lot of stat fields being characters
#all_combined_Team_Pos_min_10_num <- all_combined_Team_Pos_min_10

#all_combined_Team_Pos_min_10_num[,101:127] <- sapply(all_combined_Team_Pos_min_10_num[,101:127], as.numeric)

#filter so it is only center backs
all_combined_df_CBs <- all_combined_Team_Pos[all_combined_Team_Pos$Pos == "CB",]

#xFpts plot for all CBs
ggplot(all_combined_Team_Pos_min_10_num, aes(x = reorder(Player, xPts, FUN = median ), y = xPts)) + geom_boxplot()  + theme_minimal() + theme(axis.text.x = element_text(angle = 90)) +ggtitle("xFpts for CBs")
#not useful

#Man U analysis
MUN_CB <- all_combined_df_CBs[all_combined_df_CBs$Team_Pos == "MUN_CB",]

dim(MUN_CB)
#[1]  69 127

#remove Luke Shaw
MUN_CB <- MUN_CB[MUN_CB$Player != "Luke Shaw",]

dim(MUN_CB)
#[1]  68 130


#loop through the statistics we have and see what is significantly different between the players
stat_vec <- names(MUN_CB)

#length of the stat_vec
n = length(stat_vec)

#initiate a vector to save the boolean of whether the Kruskal-Wallis test was significant for each stat
sigStatKWTestList <- vector(mode= "list", length= n)

#for each team position
for(s in 1:length(stat_vec)){
  
  print(stat_vec[s])
  print(s)
  
  #set stat_name
  stat_name <- stat_vec[s]
  
  #if this stat is not an int or a numeric vector (so a character vector) don't perform the stat test
  if(typeof(MUN_CB[[stat_name]]) == "character" ){
    
    bool_signif = FALSE
  
  #if all entries are the same don't run the test  
  } else if(length(unique(MUN_CB[[stat_name]])) == 1){
  
    bool_signif = FALSE
    
  } else {
  
  #filter all_combined_Team_Pos_min_10_players_2 to just the entries of players with this team_pos
  #team_pos_player <- all_combined_Team_Pos_min_10_players_2[all_combined_Team_Pos_min_10_players_2$Team_Pos == team_pos,]
  
  k_test <- kruskal.test(MUN_CB[[stat_name]] ~ Player, data = MUN_CB)
  print(k_test$p.value)

  #check if the Kruskal-Wallis test is close to bonferroni significant
  bool_signif <- k_test$p.value < 0.05
  
  }
  
  #write the team pos test significance to the list
  sigStatKWTestList[[s]] <- bool_signif
}

#make the list into a vector
sigStatKWTestList<- unlist(sigStatKWTestList)


#players seem to be distributed differently for these team distributions

stat_vec[sigStatKWTestList]
#[1] "Rk"        "FPts"      "FP/G"      "KP"        "S"         "SOT"       "SA"        "FS"       
 #[9] "Off"       "SFTP"      "CF_1"      "Int.x"     "DW"        "DL"        "AER"       "LB"       
#[17] "LBA"       "#"         "Sh"        "SoT"       "Int.y"     "xG"        "npxG"      "PrgDist.1"
#[25] "xPts" 

#make a summary for these fields
summary_MUN_CBs <- MUN_CB %>% 
  group_by(Player) %>%
  summarize(n = n(), meanFpts = mean(FPts), meanxFpts = mean(xPts), total_xFpts = sum(xPts),meanSOT = mean(SOT), meanShots = mean(S), meanxG = mean(xG), meanInts = mean(Int.x), meanAER = mean(AER))

#summary_MUN_CBs_for_plot <- summary_MUN_CBs %>% gather(Stat_Name,Stat_Value, meanFpts,meanxFpts,total_SOT,total_xG,meanInts,meanAER,meanPrgDist)

summary_MUN_CBs_for_plot <- summary_MUN_CBs %>% gather(Stat_Name,Stat_Value, meanFpts,meanxFpts,meanSOT,meanxG,meanInts,meanAER)

#make a bar plot of these data
ggplot(summary_MUN_CBs_for_plot , aes(fill=Player, y=Stat_Value, x=Stat_Name)) + geom_bar(position="dodge", stat="identity") + theme_minimal() +ggtitle("Maguire and Lindelof Summary")

#Wolves analysis
WOL_CB <- all_combined_df_CBs[all_combined_df_CBs$Team_Pos == "WOL_CB",]

dim(WOL_CB)
#[1]  94 130

#remove Leander Dendoncker
WOL_CB <- WOL_CB[WOL_CB$Player != "Leander Dendoncker",]

dim(WOL_CB)
#[1]  82 130


#loop through the statistics we have and see what is significantly different between the players
stat_vec <- names(WOL_CB)

#length of the stat_vec
n = length(stat_vec)

#initiate a vector to save the boolean of whether the Kruskal-Wallis test was significant for each stat
sigStatKWTestList <- vector(mode= "list", length= n)

#for each team position
for(s in 1:length(stat_vec)){
  
  print(stat_vec[s])
  print(s)
  
  #set stat_name
  stat_name <- stat_vec[s]
  
  #if this stat is not an int or a numeric vector (so a character vector) don't perform the stat test
  if(typeof(WOL_CB[[stat_name]]) == "character" ){
    
    bool_signif = FALSE
  
  #if all entries are the same don't run the test  
  } else if(length(unique(WOL_CB[[stat_name]])) == 1){
  
    bool_signif = FALSE
    
  } else {
  
  #filter all_combined_Team_Pos_min_10_players_2 to just the entries of players with this team_pos
  #team_pos_player <- all_combined_Team_Pos_min_10_players_2[all_combined_Team_Pos_min_10_players_2$Team_Pos == team_pos,]
  
  k_test <- kruskal.test(WOL_CB[[stat_name]] ~ Player, data = WOL_CB)
  print(k_test$p.value)

  #check if the Kruskal-Wallis test is close to bonferroni significant
  bool_signif <- k_test$p.value < 0.05
  
  }
  
  #write the team pos test significance to the list
  sigStatKWTestList[[s]] <- bool_signif
}

#make the list into a vector
sigStatKWTestList<- unlist(sigStatKWTestList)


#players seem to be distributed differently for these team distributions

stat_vec[sigStatKWTestList]
# [1] "Rk"      "FPts"    "FP/G"    "S"       "SOT"     "SA"      "TkW"     "DIS"     "PLC"    
#[10] "FC"      "FS"      "YC"      "PC%"     "C"       "CF"      "CF_1"    "Int.x"   "CLRA"   
#[19] "CLR"     "CoSF"    "DW"      "DL"      "AER"     "AERL"    "BCM"     "PL"      "LB"     
#[28] "LBA"     "#"       "Sh"      "SoT"     "CrdY"    "Press"   "Tkl"     "Int.y"   "Blocks" 
#[37] "xG"      "npxG"    "PrgDist" "Att.1"   "xPts"   


#make a summary for these fields
summary_WOL_CBs <- WOL_CB %>% 
  group_by(Player) %>%
  summarize(n = n(), meanFpts = mean(FPts), meanxFpts = mean(xPts), total_xFpts = sum(xPts),meanSOT = mean(SOT), meanShots = mean(S), meanxG = mean(xG), meanInts = mean(Int.x), meanAER = mean(AER), meanTkW = mean(TkW), meanYC= mean(YC), meanCLR =mean(CLR))

summary_WOL_CBs_for_plot <- summary_WOL_CBs %>% gather(Stat_Name,Stat_Value, meanFpts,meanxFpts,meanSOT,meanInts,meanAER, meanYC,meanTkW)

#make a bar plot of these data
ggplot(summary_WOL_CBs_for_plot , aes(fill=Player, y=Stat_Value, x=Stat_Name)) + geom_bar(position="dodge", stat="identity") + theme_minimal() +ggtitle("Wolves CB Summary")

#fantrax point categor
#c(“G”,”KP”,”AT”,”SOT”,”TkW”,”DIS”,”YC”,”SYC”,”RC”,”ACNC”,”Int”,”CLR”,”CoS”,”AER”,”OG”,”GAD”,”CS”)


#Burnley CB analysis
BUR_CB <- all_combined_df_CBs[all_combined_df_CBs$Team_Pos == "BUR_CB",]

dim(BUR_CB)
#[1]  68 130


#loop through the statistics we have and see what is significantly different between the players
stat_vec <- names(BUR_CB)

#length of the stat_vec
n = length(stat_vec)

#initiate a vector to save the boolean of whether the Kruskal-Wallis test was significant for each stat
sigStatKWTestList <- vector(mode= "list", length= n)

#for each team position
for(s in 1:length(stat_vec)){
  
  print(stat_vec[s])
  print(s)
  
  #set stat_name
  stat_name <- stat_vec[s]
  
  #if this stat is not an int or a numeric vector (so a character vector) don't perform the stat test
  if(typeof(BUR_CB[[stat_name]]) == "character" ){
    
    bool_signif = FALSE
  
  #if all entries are the same don't run the test  
  } else if(length(unique(BUR_CB[[stat_name]])) == 1){
  
    bool_signif = FALSE
    
  } else {
  
  #filter all_combined_Team_Pos_min_10_players_2 to just the entries of players with this team_pos
  #team_pos_player <- all_combined_Team_Pos_min_10_players_2[all_combined_Team_Pos_min_10_players_2$Team_Pos == team_pos,]
  
  k_test <- kruskal.test(BUR_CB[[stat_name]] ~ Player, data = BUR_CB)
  print(k_test$p.value)

  #check if the Kruskal-Wallis test is close to bonferroni significant
  bool_signif <- k_test$p.value < 0.05
  
  }
  
  #write the team pos test significance to the list
  sigStatKWTestList[[s]] <- bool_signif
}

#make the list into a vector
sigStatKWTestList<- unlist(sigStatKWTestList)


#players seem to be distributed differently for these team distributions

stat_vec[sigStatKWTestList]
#[1] "Rk"      "TkW"     "DW"      "LB"      "#"       "Press"   "Tkl"     "PrgDist"

#make a summary for these fields
summary_BUR_CBs <- BUR_CB %>% 
  group_by(Player) %>%
  summarize(n = n(), meanFpts = mean(FPts), meanFpts = mean(FPts), meanxFpts = mean(xPts), total_xFpts = sum(xPts), meanTkW = mean(TkW))

summary_BUR_CBs_for_plot <- summary_BUR_CBs %>% gather(Stat_Name,Stat_Value, meanFpts,meanxFpts,meanTkW)

#make a bar plot of these data
ggplot(summary_BUR_CBs_for_plot , aes(fill=Player, y=Stat_Value, x=Stat_Name)) + geom_bar(position="dodge", stat="identity") + theme_minimal() +ggtitle("Burnley CB Summary")

#fantrax point categor
#c(“G”,”KP”,”AT”,”SOT”,”TkW”,”DIS”,”YC”,”SYC”,”RC”,”ACNC”,”Int”,”CLR”,”CoS”,”AER”,”OG”,”GAD”,”CS”)
```


# Look at points from offense vs defense for CBs
#need the xCS data so regenerate that 
```{r}
#read in fbref_summary data
fbref_summ_df <- read_csv('../data/fbref/premier_league/19_20/name_cleaned.summary_table.first_360_matches.csv')

dim(fbref_summ_df)
#[1] 10025    35

#clean sheet data
cs_df <- read_csv('../data/fantrax_data/game_results.csv')

#add game week to fbref_summ_df from cs_df

date_to_week_df <- as.data.frame(cbind(cs_df$Date, cs_df$Wk))

colnames(date_to_week_df) <- c("Date","game_week")

date_to_week_df <- distinct(date_to_week_df)

fbref_summ_df<- merge(fbref_summ_df, date_to_week_df, by="Date")

dim(fbref_summ_df)
#[1] 10025    36
#correct dims

#convert game_week to numeric
fbref_summ_df$game_week <- as.character(fbref_summ_df$game_week)
fbref_summ_df$game_week <- as.numeric(fbref_summ_df$game_week)

#merge on player and game week
min60_merged_df <- merge(min_60_min_df, fbref_summ_df, by=c('Player', 'game_week'))


dim(min60_merged_df)
#[1] 6764  125

table(min60_merged_df$Position)

#   D    F    M 
#2764 1342 2658 

players_min_starts.defenders = players_min_5_starts_summary_df[players_min_5_starts_summary_df$Position == 'D',]
#nrow(players_min_starts.forwards)

def_player_list <- players_min_starts.defenders$Player

#filter on fantrax defenders
defenders_min60_merged_df <- min60_merged_df[min60_merged_df$Position == "D",]

length(unique(defenders_min60_merged_df$Player))
#[1] 161

#see which players are extra in this group
Players_defenders_min60_merged_df<-unique(defenders_min60_merged_df$Player)

Players_defenders_min60_merged_df[Players_defenders_min60_merged_df %!in% def_player_list]
#[1] "Axel Tuanzebe"       "Charlie Daniels"     "Diogo Dalot"         "Eric Bailly"        
 #[5] "Ezequiel Schelotto"  "Jack Robinson"       "Jack Simpson"        "Jake Vokins"        
 #[9] "Jarrad Branthwaite"  "Jeremy Ngakia"       "Kevin Danso"         "Kevin Long"         
#[13] "Leighton Baines"     "Luke Thomas"         "Maximilian Kilman"   "Neco Williams"      
#[17] "Pablo Mari"          "Phil Jagielka"       "Phil Jones"          "Rob Holding"        
#[21] "Tariq Lamptey"       "Timothy Fosu-Mensah" "Wes Morgan"

#they are players who havent have 5 starts

#remove the under 5 games players
defenders_min60_merged_df <- defenders_min60_merged_df[defenders_min60_merged_df$Player %in% def_player_list,]

dim(defenders_min60_merged_df)
#[1] 2715  125

#just get the important stuff for clean sheets (name "Team.y" for easy merge in a sec)
all_cs_data_df <- data.frame('Team.y' = c(cs_df$Home, cs_df$Away), 'xG_against' = c(cs_df$xG_1, cs_df$xG), 'game_week' = c(cs_df$Wk, cs_df$Wk))

#convert squad to character all_cs_data_df for merge
all_cs_data_df$Team.y <- as.character(all_cs_data_df$Team.y)

#merge cs and defender data
defenders_min60_merged_cs_df <- merge(defenders_min60_merged_df, all_cs_data_df, by=c("Team.y", "game_week"))

dim(defenders_min60_merged_cs_df)
#[1] 2764  126

#calculate xFpts from cs given xG against

#GAD_against = 0 if xG_against < 0.25 and = xG_against - 0.25 otherwise
defenders_min60_merged_cs_df$GAD_against <- ifelse(defenders_min60_merged_cs_df$xG_against - 0.25 < 0, 0, defenders_min60_merged_cs_df$xG_against - 0.25)

defenders_min60_merged_cs_df$xCS <- ifelse(defenders_min60_merged_cs_df$GAD_against <= 1.25, 1 - defenders_min60_merged_cs_df$GAD_against/1.25, 0)

#calculate xFpts for defenders
defenders_min60_merged_cs_df$xPts <- defenders_min60_merged_cs_df$FPts - (defenders_min60_merged_cs_df$G * 10 + defenders_min60_merged_cs_df$AT * 8 + defenders_min60_merged_cs_df$CS * 6 + defenders_min60_merged_cs_df$GAD * -2) + (as.numeric(defenders_min60_merged_cs_df$xG)* 10 + as.numeric(defenders_min60_merged_cs_df$xA) * 8 + as.numeric(defenders_min60_merged_cs_df$xCS)* 6 + as.numeric(defenders_min60_merged_cs_df$GAD_against) * -2)

#calculate piecewise point categories
#clearances
defenders_min60_merged_cs_df$CLRpts <- defenders_min60_merged_cs_df$CLR * 0.25

#goals
defenders_min60_merged_cs_df$xGpts <-  defenders_min60_merged_cs_df$xG * 10

#assists
defenders_min60_merged_cs_df$xApts <-  defenders_min60_merged_cs_df$xA * 8

#Key Passes
defenders_min60_merged_cs_df$KPpts <- defenders_min60_merged_cs_df$KP * 2

#Shots on target
defenders_min60_merged_cs_df$SOTpts <- defenders_min60_merged_cs_df$SOT * 2

#tackles won = 1 so not needed

#dispossessed
defenders_min60_merged_cs_df$DISpts <- defenders_min60_merged_cs_df$DIS * -0.5

#yellow cards
defenders_min60_merged_cs_df$YCpts <- defenders_min60_merged_cs_df$YC * -3

#second yellow
defenders_min60_merged_cs_df$YCpts <- defenders_min60_merged_cs_df$SYC * -4

#red
defenders_min60_merged_cs_df$RCpts <- defenders_min60_merged_cs_df$RC * -7

#Acc. Cross, Ints, CoS, AER all 1 so not needed

#Own Goals
defenders_min60_merged_cs_df$OGpts <- defenders_min60_merged_cs_df$OG * -9

#Goals against
defenders_min60_merged_cs_df$xGADpts <- defenders_min60_merged_cs_df$GAD_against * -2

#Clean Sheets
defenders_min60_merged_cs_df$xCSpts <- defenders_min60_merged_cs_df$xCS * 6


#write all denfenders df to file
write.csv(x=defenders_min60_merged_cs_df, file="../data/fantrax_data/defenders_pts_breakdown_20200726.csv")

#filter so it is only center backs
pts_breakdown_df_CBs <- defenders_min60_merged_cs_df[defenders_min60_merged_cs_df$Pos == "CB",]

dim(pts_breakdown_df_CBs)
#[1] 1395  140

#calculate defensive points
pts_breakdown_df_CBs$defPts = pts_breakdown_df_CBs$CLRpts + pts_breakdown_df_CBs$TkW + pts_breakdown_df_CBs$Int.x + pts_breakdown_df_CBs$OGpts + pts_breakdown_df_CBs$xGADpts + pts_breakdown_df_CBs$xCSpts


#calculate offensive points
pts_breakdown_df_CBs$offPts = pts_breakdown_df_CBs$xGpts + pts_breakdown_df_CBs$xApts + pts_breakdown_df_CBs$KPpts + pts_breakdown_df_CBs$SOTpts + pts_breakdown_df_CBs$DISpts + pts_breakdown_df_CBs$ACNC + pts_breakdown_df_CBs$CoS

#write CB df to file
write.csv(x=pts_breakdown_df_CBs, file="../data/fantrax_data/CBs_pts_breakdown_20200726.csv")

#graph all datap points just to see

ggplot(pts_breakdown_df_CBs, aes(y = offPts, x = defPts)) + geom_point(aes(colour = xPts)) + scale_color_gradient(low="blue", high="red", ) + theme_minimal() +ggtitle("All CB Starts defPts vs offPts")

#might help to look at only players that are likely to be owned
pts_breakdown_df_CBs$Pct_Owned <- gsub("%", "", pts_breakdown_df_CBs$`% Owned`)

pts_breakdown_df_CBs$Pct_Owned <- as.numeric(pts_breakdown_df_CBs$Pct_Owned)

#make a summary for these fields
summary_CBs <- pts_breakdown_df_CBs %>% 
  group_by(Player) %>%
  summarize(n = n(), meanFpts = mean(FPts), meanxFpts = mean(xPts), meanOffPts= mean(offPts), meanDefPts= mean(defPts), meanxG = mean(xG), meanxCS = mean(xCS), meanxA = mean(xA) )

#plot summary data
ggplot(summary_CBs, aes(y = meanOffPts, x = meanDefPts, label = Player)) + geom_point(aes(colour = meanxFpts)) + scale_color_gradient(low="blue", high="red", ) + theme_minimal() + geom_text_repel()

#correlation
cor(summary_CBs$meanOffPts, summary_CBs$meanxFpts)
#[1] 0.6398535
cor(summary_CBs$meanDefPts, summary_CBs$meanxFpts)
#[1] 0.7581317

#might help to look at only players that are likely to be owned
pts_breakdown_df_CBs$Pct_Owned <- gsub("%", "", pts_breakdown_df_CBs$`% Owned`)

pts_breakdown_df_CBs$Pct_Owned <- as.numeric(pts_breakdown_df_CBs$Pct_Owned)

pts_breakdown_df_CBs_GT20 <- pts_breakdown_df_CBs[pts_breakdown_df_CBs$Pct_Owned > 50,]

summary_CBs_50 <- pts_breakdown_df_CBs_GT20 %>% 
  group_by(Player) %>%
  summarize(n = n(), meanFpts = mean(FPts), meanxFpts = mean(xPts), meanOffPts= mean(offPts), meanDefPts= mean(defPts), meanxG = mean(xG), meanxCS = mean(xCS), meanxA = mean(xA), meanAER = mean(AER) )

summary_CBs_50 <- as.data.frame(summary_CBs_50)



#plot summary data
ggplot(summary_CBs_50, aes(y = meanOffPts, x = meanDefPts, label = Player)) + geom_point(aes(colour = meanxFpts)) + scale_color_gradient(low="blue", high="red", ) + theme_minimal() + geom_text_repel()

dim(summary_CBs_50)
#[1] 57  9

summary_CBs_50_n5 <- summary_CBs_50[summary_CBs_50$n >= 5,]

dim(summary_CBs_50_n5)
#[1] 29  9

ggplot(summary_CBs_50_n5, aes(y = meanOffPts, x = meanDefPts, label = Player)) + geom_point(aes(colour = meanxFpts)) + scale_color_gradient(low="blue", high="red", ) + theme_minimal() + geom_text_repel()

#last line is NA so gotta remove
summary_CBs_50_n5 <- summary_CBs_50_n5[complete.cases(summary_CBs_50_n5),]

#correlation
cor(summary_CBs_50_n5$meanOffPts, summary_CBs_50_n5$meanxFpts)
#[1] 0.618092
cor(summary_CBs_50$meanDefPts, summary_CBs_50$meanxFpts)
#[1] 0.7456804

#ggplot(summary_BUR_CBs_for_plot , aes(fill=Player, y=Stat_Value, x=Stat_Name)) + geom_bar(position="dodge", stat="identity") + theme_minimal() +ggtitle("Burnley CB Summary")
```

#Aerial analyses
```{r}

#write read in denfenders df to file
defenders_min60_merged_cs_df <- read.csv( file="../data/fantrax_data/defenders_pts_breakdown_20200726.csv")

#filter so it is only center backs
pts_breakdown_df_CBs <- defenders_min60_merged_cs_df[defenders_min60_merged_cs_df$Pos == "CB",]

dim(pts_breakdown_df_CBs)
#[1] 1395  140

#calculated AER_pct (percent won)
pts_breakdown_df_CBs$AER_prop <- pts_breakdown_df_CBs$AER / (pts_breakdown_df_CBs$AER + pts_breakdown_df_CBs$AERL)
#could lead to 0/0 so need to remove NaNs
pts_breakdown_df_CBs$AER_prop[is.nan(pts_breakdown_df_CBs$AER_prop)]<- 0

#calculate defensive points
pts_breakdown_df_CBs$defPts = pts_breakdown_df_CBs$CLRpts + pts_breakdown_df_CBs$TkW + pts_breakdown_df_CBs$Int.x + pts_breakdown_df_CBs$OGpts + pts_breakdown_df_CBs$xGADpts + pts_breakdown_df_CBs$xCSpts


#calculate offensive points
pts_breakdown_df_CBs$offPts = pts_breakdown_df_CBs$xGpts + pts_breakdown_df_CBs$xApts + pts_breakdown_df_CBs$KPpts + pts_breakdown_df_CBs$SOTpts + pts_breakdown_df_CBs$DISpts + pts_breakdown_df_CBs$ACNC + pts_breakdown_df_CBs$CoS


summary_all_CBs <- pts_breakdown_df_CBs %>% 
  group_by(Player) %>%
  summarize(n = n(), meanFpts = mean(FPts), meanxFpts = mean(xPts), meanOffPts= mean(offPts), meanDefPts= mean(defPts), meanxG = mean(xG), meanxCS = mean(xCS), meanxA = mean(xA), meanAER = mean(AER), meanAERProp = mean(AER_prop) )

#require that they played at least 5 games as a CB

summary_CBs_n5 <- summary_all_CBs[summary_all_CBs$n >= 5,]

#plot it to take a look
ggplot(summary_CBs_n5, aes(y = meanOffPts, x = meanDefPts, label = Player)) + geom_point(aes(colour = meanxFpts)) + scale_color_gradient(low="blue", high="red", ) + theme_minimal() + geom_text_repel()


#correlation
cor(summary_CBs_n5$meanOffPts, summary_CBs_n5$meanxFpts)
#[1] 0.5228639
cor(summary_CBs_n5$meanDefPts, summary_CBs_n5$meanxFpts)
#[1] 0.7228486
cor(summary_CBs_n5$meanAER, summary_CBs_n5$meanxFpts)
#[1] 0.6473951
cor(summary_CBs_n5$meanAER, summary_CBs_n5$meanOffPts)
#[1] 0.2222049
cor(summary_CBs_n5$meanAER, summary_CBs_n5$meanDefPts)
#[1] 0.09010674
cor(summary_CBs_n5$meanAERProp, summary_CBs_n5$meanOffPts)
#[1] 0.1764171
cor(summary_CBs_n5$meanAERProp, summary_CBs_n5$meanDefPts)
#[1] 0.1430124
cor(summary_CBs_n5$meanAERProp, summary_CBs_n5$meanxFpts)
#[1] 0.5535953
cor(summary_CBs_n5$meanAERProp, summary_CBs_n5$meanxG)
#[1] 0.1147131
cor(summary_CBs_n5$meanAERProp, summary_CBs_n5$meanxCS)
#[1] 0.04472386





#clear that AER is more correlated with offense
plot(summary_CBs_n5$meanAER, summary_CBs_n5$meanOffPts)
plot(summary_CBs_n5$meanAER, summary_CBs_n5$meanDefPts)

#plot it to take a look
ggplot(summary_CBs_n5, aes(y = meanOffPts, x = meanAER, label = Player)) + geom_point(aes(colour = meanxFpts)) + scale_color_gradient(low="blue", high="red", ) + theme_minimal() + geom_text_repel()

ggplot(summary_CBs_n5, aes(y = meanOffPts, x = meanAERProp, label = Player)) + geom_point(aes(colour = meanxFpts)) + scale_color_gradient(low="blue", high="red", ) + theme_minimal() + geom_text_repel()

ggplot(summary_CBs_n5, aes(y = meanOffPts, x = meanAERProp, label = Player)) + geom_point(aes(colour = meanxFpts)) + scale_color_gradient(low="blue", high="red", ) + theme_minimal() + geom_text_repel()

#add in possession data
fbref_pos_df <- read_csv('../data/fbref/premier_league/19_20/name_cleaned.possession_table.first_360_matches.csv')

dim(fbref_pos_df)
#[1] 10025    29

cs_df <- read_csv('../data/fantrax_data/game_results.csv')

#add game week to fbref_pos_df from cs_df

date_to_week_df <- as.data.frame(cbind(cs_df$Date, cs_df$Wk))

colnames(date_to_week_df) <- c("Date","game_week")

date_to_week_df <- distinct(date_to_week_df)

fbref_pos_df <- merge(fbref_pos_df, date_to_week_df, by="Date")


dim(fbref_pos_df)
#[1] 10025    30
#correct dims

#write to file
write.csv(x=fbref_pos_df, file="../data/fbref/premier_league/19_20/name_cleaned.possession_table.first_360_matches_game_week.csv")

pts_breakdown_df_CBs_posStats <- merge(pts_breakdown_df_CBs, fbref_pos_df, by=c('Player', 'game_week'))

 dim(pts_breakdown_df_CBs_posStats)
#[1] 1395  172
 
 # summary_all_fwds_poss <- fwds_min60_merged_df_posStats %>% 
 # group_by(Player) %>%
#  summarize(n = n(), meanFpts = mean(FPts), meanxFpts = mean(xPts), sdxFpts = sd(xPts), meanxG = mean(xG), meanxA = mean(xA), meanAER = mean(AER), meanAERProp = mean(AER_prop), meanSoT = mean(SoT), meanSh = mean(Sh), meanAtt3rd = mean(Att.3rd), meanAttPen = mean(Att.Pen), meanDefPen = mean(Def.Pen))
 
 
 summary_all_CBs_poss <- pts_breakdown_df_CBs_posStats %>% 
  group_by(Player) %>%
  summarize(n = n(), meanFpts = mean(FPts), meanxFpts = mean(xPts), sdxFpts = sd(xPts), meanxG = mean(xG), meanxA = mean(xA), meanAER = mean(AER), meanAERProp = mean(AER_prop), meanSoT = mean(SoT), meanSh = mean(Sh), meanAtt3rd = mean(`Att 3rd`), meanAttPen = mean(`Att Pen`), meanDefPen = mean(`Def Pen`))

#require that they played at least 5 games as a CB

summary_all_CBs_poss_n5 <- summary_all_CBs_poss[summary_all_CBs_poss$n >= 5,]

#plot it to take a look
# AttPen v AER
ggbub <- ggplot(summary_all_CBs_poss_n5, aes(y =  meanAER, x = meanAttPen)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = mean(summary_all_CBs_poss_n5$meanxFpts)) + theme_minimal() + geom_text_repel(data = subset(summary_all_CBs_poss_n5,meanAER > 4.5 | meanAttPen > 1.5 ), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black")

ggsave(filename="../xFpts_figures/CB_AttPen_AER_sd.png", plot=ggbub)

#SoT v AER
ggbub <- ggplot(summary_all_CBs_poss_n5, aes(y =  meanAER, x = meanSoT)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = mean(summary_all_CBs_poss_n5$meanxFpts)) + theme_minimal() + geom_text_repel(data = subset(summary_all_CBs_poss_n5,meanAER > 4.5 | meanSoT > 0.3 ), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black")

ggsave(filename="../xFpts_figures/CB_SoT_AER_sd.png", plot=ggbub)

#xG v AER
ggbub <- ggplot(summary_all_CBs_poss_n5, aes(y =  meanAER, x = meanxG)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = mean(summary_all_CBs_poss_n5$meanxFpts)) + theme_minimal() + geom_text_repel(data = subset(summary_all_CBs_poss_n5,meanAER > 4.5 | meanxG > 0.075  | meanxFpts > 10), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black")

ggsave(filename="../xFpts_figures/CB_xG_AER_sd.png", plot=ggbub)

#xFpts v AER
ggbub <- ggplot(summary_all_CBs_poss_n5, aes(y =  meanAER, x = meanxFpts)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = mean(summary_all_CBs_poss_n5$meanxFpts)) + theme_minimal() + geom_text_repel(data = subset(summary_all_CBs_poss_n5,meanAER > 4.5 |  meanxFpts > 9.5), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black")

ggsave(filename="../xFpts_figures/CB_xFpts_AER_sd.png", plot=ggbub)

#Sh v AER
ggbub <- ggplot(summary_all_CBs_poss_n5, aes(y =  meanAER, x = meanSh)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = mean(summary_all_CBs_poss_n5$meanxFpts)) + theme_minimal() + geom_text_repel(data = subset(summary_all_CBs_poss_n5,meanAER > 4.5 |  meanxFpts > 9.5 | meanSh > 0.99), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black")

ggsave(filename="../xFpts_figures/CB_Sh_AER_sd.png", plot=ggbub)

#xA v AER
ggbub <- ggplot(summary_all_CBs_poss_n5, aes(y =  meanAER, x = meanxA)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = mean(summary_all_CBs_poss_n5$meanxFpts)) + theme_minimal() + geom_text_repel(data = subset(summary_all_CBs_poss_n5,meanAER > 4.5 |  meanxFpts > 9.5), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black")

ggsave(filename="../xFpts_figures/CB_xA_AER_sd.png", plot=ggbub)


#ggplot(summary_all_CBs_poss_n5, aes(y =  meanAER, x = meanAtt3rd, label = Player)) + geom_point(aes(colour = meanxFpts)) + scale_color_gradient(low="blue", high="red", ) + theme_minimal() + geom_text_repel()

cor.test(summary_all_CBs_poss_n5$meanAER, summary_all_CBs_poss_n5$meanAtt3rd)

	'Pearsons product-moment correlation

data:  summary_all_CBs_poss_n5$meanAER and summary_all_CBs_poss_n5$meanAtt3rd
t = 2.0284, df = 68, p-value = 0.04644
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 0.004119127 0.448654630
sample estimates:
     cor 
0.238862 '

#ggplot(summary_all_CBs_poss_n5, aes(y =  meanAER, x = meanAttPen, label = Player)) + geom_point(aes(colour = meanxFpts)) + scale_color_gradient(low="blue", high="red", ) + theme_minimal() + geom_text_repel()

ggplot(summary_all_CBs_poss_n5, aes(y =  meanAER, x = meanAttPen)) + geom_point(aes(colour = meanxFpts)) + scale_color_gradient(low="blue", high="red", ) + theme_minimal() + geom_text_repel(data = subset(summary_all_CBs_poss_n5, (meanAER - mean(meanAER))/length(Player) > 0.005 & (meanAttPen - mean(meanAttPen))/length(Player) > 0.003 ), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black")


cor.test(summary_all_CBs_poss_n5$meanAER, summary_all_CBs_poss_n5$meanAttPen)

	'Pearsons product-moment correlation

data:  summary_all_CBs_poss_n5$meanAER and summary_all_CBs_poss_n5$meanAttPen
t = 6.6366, df = 68, p-value = 6.363e-09
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 0.4597325 0.7512714
sample estimates:
      cor 
0.6269772 '

#AER Prop and touches in AttPen
ggplot(summary_all_CBs_poss_n5, aes(y =  meanAERProp, x = meanAttPen)) + geom_point(aes(colour = meanxFpts)) + scale_color_gradient(low="blue", high="red", ) + theme_minimal() + geom_text_repel(data = subset(summary_all_CBs_poss_n5, (meanAER - mean(meanAER))/length(Player) > 0.005 & (meanAttPen - mean(meanAttPen))/length(Player) > 0.003 ), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black")


#Aerials to xG
ggplot(summary_all_CBs_poss_n5, aes(y =  meanxG, x = meanAER)) + geom_point(aes(colour = meanxFpts)) + scale_color_gradient(low="blue", high="red", ) + theme_minimal() + geom_text_repel(data = subset(summary_all_CBs_poss_n5, (meanAER - mean(meanAER))/length(Player) > 0.005 & (meanAttPen - mean(meanAttPen))/length(Player) > 0.003 ), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black")
cor.test(summary_all_CBs_poss_n5$meanAER, summary_all_CBs_poss_n5$meanxG)

	'Pearsons product-moment correlation

data:  summary_all_CBs_poss_n5$meanAER and summary_all_CBs_poss_n5$meanxG
t = 2.1551, df = 68, p-value = 0.03469
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 0.01901113 0.46047098
sample estimates:
      cor 
0.2528556 '


ggplot(summary_all_CBs_poss_n5, aes(y =  meanAER, x = meanDefPen, label = Player)) + geom_point(aes(colour = meanxFpts)) + scale_color_gradient(low="blue", high="red", ) + theme_minimal() + geom_text_repel()

#correlation
cor(summary_CBs_n5$meanOffPts, summary_CBs_n5$meanxFpts)


```


# Look at AER for other positions

#Outside backs
```{r}
#read in fbref_summary data

defenders_min60_merged_cs_df <- read.csv(file="../data/fantrax_data/defenders_pts_breakdown_20200726.csv")

#filter so it is only outside backs

OB_Pos <- c("LB","RB","WB")

pts_breakdown_df_OBs <- defenders_min60_merged_cs_df[defenders_min60_merged_cs_df$Pos %in% OB_Pos,]

dim(pts_breakdown_df_OBs)
#[1] 1101  141

#calculated AER_pct (percent won)
pts_breakdown_df_OBs$AER_prop <- pts_breakdown_df_OBs$AER / (pts_breakdown_df_OBs$AER + pts_breakdown_df_OBs$AERL)
#could lead to 0/0 so need to remove NaNs
pts_breakdown_df_OBs$AER_prop[is.nan(pts_breakdown_df_OBs$AER_prop)]<- 0

#calculate defensive points
pts_breakdown_df_OBs$defPts = pts_breakdown_df_OBs$CLRpts + pts_breakdown_df_OBs$TkW + pts_breakdown_df_OBs$Int.x + pts_breakdown_df_OBs$OGpts + pts_breakdown_df_OBs$xGADpts + pts_breakdown_df_OBs$xCSpts


#calculate offensive points
pts_breakdown_df_OBs$offPts = pts_breakdown_df_OBs$xGpts + pts_breakdown_df_OBs$xApts + pts_breakdown_df_OBs$KPpts + pts_breakdown_df_OBs$SOTpts + pts_breakdown_df_OBs$DISpts + pts_breakdown_df_OBs$ACNC + pts_breakdown_df_OBs$CoS

#write 0B df to file
write.csv(x=pts_breakdown_df_OBs, file="../data/fantrax_data/OBs_pts_breakdown_20200729.csv")
          
          
#add possession data
fbref_pos_df <- read.csv(file="../data/fbref/premier_league/19_20/name_cleaned.possession_table.first_360_matches_game_week.csv")

pts_breakdown_df_OBs_posStats <- merge(pts_breakdown_df_OBs, fbref_pos_df, by=c('Player', 'game_week'))

dim(pts_breakdown_df_OBs_posStats)
#[1] 1101  173
 
 
 summary_all_OBs_poss <- pts_breakdown_df_OBs_posStats %>% 
  group_by(Player) %>%
  summarize(n = n(), meanFpts = mean(FPts), meanxFpts = mean(xPts), sdxFpts = sd(xPts) , meanOffPts= mean(offPts), meanDefPts= mean(defPts), meanxG = mean(xG), meanxCS = mean(xCS), meanxA = mean(xA), meanAER = mean(AER), meanAERProp = mean(AER_prop), meanSh = mean(Sh), meanSoT = mean(SoT), meanAtt3rd = mean(Att.3rd), meanAttPen = mean(Att.Pen), meanDefPen = mean(Def.Pen))

#require that they played at least 5 games as a OB

summary_all_OBs_poss_n5 <- summary_all_OBs_poss[summary_all_OBs_poss$n >= 5,]

dim(summary_all_OBs_poss_n5)
#[1] 69 16



# AttPen v AER
ggbub <- ggplot(summary_all_OBs_poss_n5, aes(y =  meanAER, x = meanAttPen)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = mean(summary_all_OBs_poss_n5$meanxFpts)) + theme_minimal() + geom_text_repel(data = subset(summary_all_OBs_poss_n5,meanAER > 2.5 | meanAttPen > 2.5 ), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black")

ggsave(filename="../xFpts_figures/OB_AttPen_AER_sd.png", plot=ggbub)

# xG v AER
ggbub <- ggplot(summary_all_OBs_poss_n5, aes(y =  meanAER, x = meanxG)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = mean(summary_all_OBs_poss_n5$meanxFpts)) + theme_minimal() + geom_text_repel(data = subset(summary_all_OBs_poss_n5,meanAER > 2.5 | meanxG > 0.075 ), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black")

ggsave(filename="../xFpts_figures/OB_xG_AER_sd.png", plot=ggbub)

# Sh v AER
ggbub <- ggplot(summary_all_OBs_poss_n5, aes(y =  meanAER, x = meanSh)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = mean(summary_all_OBs_poss_n5$meanxFpts)) + theme_minimal() + geom_text_repel(data = subset(summary_all_OBs_poss_n5,meanAER > 2.5 | meanxG > 0.075 ), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black")

ggsave(filename="../xFpts_figures/OB_Sh_AER_sd.png", plot=ggbub)

# xFpts v AER
ggbub <- ggplot(summary_all_OBs_poss_n5, aes(y =  meanAER, x = meanxFpts)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = mean(summary_all_OBs_poss_n5$meanxFpts)) + theme_minimal() + geom_text_repel(data = subset(summary_all_OBs_poss_n5,meanAER > 2.5 | meanxFpts > 12 ), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black")

ggsave(filename="../xFpts_figures/OB_xG_AER_sd.png", plot=ggbub)

# SoT v AER
ggbub <- ggplot(summary_all_OBs_poss_n5, aes(y =  meanAER, x = meanSoT)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = mean(summary_all_OBs_poss_n5$meanxFpts)) + theme_minimal() + geom_text_repel(data = subset(summary_all_OBs_poss_n5,meanAER > 3 | meanSoT > 0.4 | meanxFpts > 12 ), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black")

ggsave(filename="../xFpts_figures/OB_SoT_AER_sd.png", plot=ggbub)

ggplot(summary_all_OBs_poss, aes(y = meanSoT, x = meanAER, label = Player)) + geom_point(aes(colour = meanxFpts)) + scale_color_gradient(low="blue", high="red", ) + theme_minimal() + geom_text_repel()


ggplot(summary_all_OBs_poss, aes(y =  meanAER, x = meanAtt3rd, label = Player)) + geom_point(aes(colour = meanxFpts)) + scale_color_gradient(low="blue", high="red", ) + theme_minimal() + geom_text_repel()

cor.test(summary_all_OBs_poss_n5$meanAER, summary_all_OBs_poss_n5$meanAtt3rd)

	'Pearsons product-moment correlation

data:  summary_all_OBs_poss_n5$meanAER and summary_all_OBs_poss_n5$meanAtt3rd
t = -0.028278, df = 67, p-value = 0.9775
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 -0.2399392  0.2334168
sample estimates:
         cor 
-0.003454734 '

ggplot(summary_all_OBs_poss, aes(y =  meanAER, x = meanAttPen, label = Player)) + geom_point(aes(colour = meanxFpts)) + scale_color_gradient(low="blue", high="red", ) + theme_minimal() + geom_text_repel()


cor.test(summary_all_OBs_poss$meanAER, summary_all_OBs_poss$meanAttPen)

	'Pearsons product-moment correlation

data:  summary_all_OBs_poss$meanAER and summary_all_OBs_poss$meanAttPen
t = 0.82421, df = 76, p-value = 0.4124
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 -0.1311536  0.3101585
sample estimates:
      cor 
0.0941242 '

ggplot(summary_all_OBs_poss, aes(y =  meanAER, x = meanDefPen, label = Player)) + geom_point(aes(colour = meanxFpts)) + scale_color_gradient(low="blue", high="red", ) + theme_minimal() + geom_text_repel()

#correlation
cor(summary_all_OBs_poss$meanOffPts, summary_all_OBs_poss$meanxFpts)

```

# Look at AER for midfielders
```{r}

#load all player data for fbref.com
weekly_data_csv = "../data/fantrax_data/weekly.all_data_combined.no_double_gws.csv"
yearly_data_csv = "../data/fantrax_data/yearly.all_data_combined.csv"

weekly_data_df <- read_csv(file = weekly_data_csv, col_names = TRUE)
yearly_data_df <- read_csv(file = yearly_data_csv, col_names = TRUE)

# Only weeks where at least 60 minutes are played
min_60_min_df <- weekly_data_df[weekly_data_df$Min > 59,]
# Players that have started at least 5 games
summary_min_60_df <- min_60_min_df %>% 
  group_by(Player, Team, Position) %>%
  summarize(n = n(), min_total = sum(Min), sd = sd(FPts), mean = mean(FPts), total_fpts = sum(FPts), mean_minutes = mean(Min))

#only players with at least 5 starts
players_min_5_starts_summary_df <- summary_min_60_df[summary_min_60_df$n >= 5,]

player_min_5_starts_weekly_df <- min_60_min_df %>%
  filter(Player %in% players_min_5_starts_summary_df$Player)
nrow(player_min_5_starts_weekly_df)

#read in fbref_summary data
fbref_summ_df <- read_csv('../data/fbref/premier_league/19_20/name_cleaned.summary_table.first_360_matches.csv')

dim(fbref_summ_df)
#[1] 10025    35

#clean sheet data
cs_df <- read_csv('../data/fantrax_data/game_results.csv')

#add game week to fbref_summ_df from cs_df

date_to_week_df <- as.data.frame(cbind(cs_df$Date, cs_df$Wk))

colnames(date_to_week_df) <- c("Date","game_week")

date_to_week_df <- distinct(date_to_week_df)

fbref_summ_df<- merge(fbref_summ_df, date_to_week_df, by="Date")

dim(fbref_summ_df)
#[1] 10025    36
#correct dims

#convert game_week to numeric
fbref_summ_df$game_week <- as.character(fbref_summ_df$game_week)
fbref_summ_df$game_week <- as.numeric(fbref_summ_df$game_week)

#merge on player and game week
min60_merged_df <- merge(min_60_min_df, fbref_summ_df, by=c('Player', 'game_week'))


dim(min60_merged_df)
#[1] 6764  125

table(min60_merged_df$Position)

#   D    F    M 
#2764 1342 2658 

# midfielders
players_min_starts.midfielders = players_min_5_starts_summary_df[players_min_5_starts_summary_df$Position == 'M',]

mid_player_list <- players_min_starts.midfielders$Player

#filter on fantrax midfielders
mids_min60_merged_df <- min60_merged_df[min60_merged_df$Position == "M",]

length(unique(mids_min60_merged_df$Player))
#[1] 168

#remove the under 5 games players
mids_min60_merged_df <- mids_min60_merged_df[mids_min60_merged_df$Player %in% mid_player_list,]

dim(mids_min60_merged_df)
#[1] 2600  125


length(unique(mids_min60_merged_df$Player))
#[1] 143

#calculate xFpts for midfielders
mids_min60_merged_df$xPts <- mids_min60_merged_df$FPts - (mids_min60_merged_df$G * 9 + mids_min60_merged_df$AT * 6)
mids_min60_merged_df$xPts <- mids_min60_merged_df$xPts + (as.numeric(mids_min60_merged_df$xG)* 9 + as.numeric(mids_min60_merged_df$xA) * 6)

#add possession data
fbref_pos_df <- read.csv(file="../data/fbref/premier_league/19_20/name_cleaned.possession_table.first_360_matches_game_week.csv")

mids_min60_merged_df_posStats <- merge(mids_min60_merged_df, fbref_pos_df, by=c('Player', 'game_week'))

dim(mids_min60_merged_df_posStats )
#[1] 2600  155
 
#calculated AER_pct (percent won)
mids_min60_merged_df_posStats$AER_prop <- mids_min60_merged_df_posStats$AER / (mids_min60_merged_df_posStats$AER + mids_min60_merged_df_posStats$AERL)
#could lead to 0/0 so need to remove NaNs
mids_min60_merged_df_posStats$AER_prop[is.nan(mids_min60_merged_df_posStats$AER_prop)]<- 0

#filter on actual midfield positions
Mid_Pos <- c("AM","CM","DM","RW","LW")

mids_min60_merged_df_posStats <- mids_min60_merged_df_posStats[mids_min60_merged_df_posStats$Pos.x %in% Mid_Pos,]

 summary_all_mids_poss <- mids_min60_merged_df_posStats %>% 
  group_by(Player) %>%
  summarize(n = n(), meanFpts = mean(FPts), meanxFpts = mean(xPts), sdxFpts = sd(xPts), meanxG = mean(xG), meanxA = mean(xA), meanAER = mean(AER), meanAERProp = mean(AER_prop), meanSh = mean(Sh), meanSoT = mean(SoT), meanAtt3rd = mean(Att.3rd), meanAttPen = mean(Att.Pen), meanDefPen = mean(Def.Pen))
 


#require that they played at least 5 games as a OB

summary_all_mids_poss_n5 <- summary_all_mids_poss[summary_all_mids_poss$n >= 5,]

dim(summary_all_mids_poss_n5)
#[1] 129  12


# AttPen v AER
ggbub <- ggplot(summary_all_mids_poss_n5, aes(y =  meanAER, x = meanAttPen)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = mean(summary_all_mids_poss_n5$meanxFpts)) + theme_minimal() + geom_text_repel(data = subset(summary_all_mids_poss_n5,meanAER > 2.5 | meanAttPen > 5 | meanFpts > 16 ), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black")

ggsave(filename="../xFpts_figures/MID_AttPen_AER_sd.png", plot=ggbub)

#Sh v AER
ggbub <- ggplot(summary_all_mids_poss_n5, aes(y =  meanAER, x = meanSh)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = mean(summary_all_mids_poss_n5$meanxFpts)) + theme_minimal() + geom_text_repel(data = subset(summary_all_mids_poss_n5,meanAER > 2.5 | meanSh > 2.5 | meanFpts > 16 ), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black")

ggsave(filename="../xFpts_figures/MID_Sh_AER_sd.png", plot=ggbub)

#SoT v AER
ggbub <- ggplot(summary_all_mids_poss_n5, aes(y =  meanAER, x = meanSoT)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = mean(summary_all_mids_poss_n5$meanxFpts)) + theme_minimal() + geom_text_repel(data = subset(summary_all_mids_poss_n5,meanAER > 2.5 | meanSoT > 1 | meanFpts > 16 ), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black")

ggsave(filename="../xFpts_figures/MID_SoT_AER_sd.png", plot=ggbub)

#xG v AER
ggbub <- ggplot(summary_all_mids_poss_n5, aes(y =  meanAER, x = meanxG)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = mean(summary_all_mids_poss_n5$meanxFpts)) + theme_minimal() + geom_text_repel(data = subset(summary_all_mids_poss_n5,meanAER > 2.5 | meanxG > 0.3 | meanFpts > 16 ), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black")

ggsave(filename="../xFpts_figures/MID_xG_AER_sd.png", plot=ggbub)

#xA v AER
ggbub <- ggplot(summary_all_mids_poss_n5, aes(y =  meanAER, x = meanxA)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = mean(summary_all_mids_poss_n5$meanxFpts)) + theme_minimal() + geom_text_repel(data = subset(summary_all_mids_poss_n5,meanAER > 2.5 | meanxA > 0.25 | meanFpts > 16 ), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black")

ggsave(filename="../xFpts_figures/MID_xA_AER_sd.png", plot=ggbub)

ggplot(summary_all_mids_poss_n5 , aes(y = meanSoT, x = meanAER, label = Player)) + geom_point(aes(colour = meanxFpts)) + scale_color_gradient(low="blue", high="red", ) + theme_minimal() + geom_text_repel()


ggplot(summary_all_mids_poss_n5 , aes(y =  meanAER, x = meanAtt3rd, label = Player)) + geom_point(aes(colour = meanxFpts)) + scale_color_gradient(low="blue", high="red", ) + theme_minimal() + geom_text_repel()

cor.test(summary_all_mids_poss_n5$meanAER, summary_all_mids_poss_n5$meanAtt3rd)

	'Pearsons product-moment correlation

data:  summary_all_mids_poss_n5$meanAER and summary_all_mids_poss_n5$meanAtt3rd
t = -5.254, df = 127, p-value = 6.094e-07
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 -0.5548777 -0.2693721
sample estimates:
       cor 
-0.4225515 '

ggplot(summary_all_mids_poss_n5, aes(y =  meanAER, x = meanAttPen)) + geom_point(aes(colour = meanxFpts)) + scale_color_gradient(low="blue", high="red", ) + theme_minimal()


cor.test(summary_all_mids_poss_n5$meanAER, summary_all_mids_poss_n5$meanAttPen)

	'Pearsons product-moment correlation

data:  summary_all_mids_poss_n5$meanAER and summary_all_mids_poss_n5$meanAttPen
t = -2.4998, df = 127, p-value = 0.0137
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 -0.37535951 -0.04540091
sample estimates:
       cor 
-0.2165558 '

ggplot(summary_all_mids_poss_n5, aes(y =  meanAER, x = meanDefPen, label = Player)) + geom_point(aes(colour = meanxFpts)) + scale_color_gradient(low="blue", high="red", ) + theme_minimal() + geom_text_repel()

```

#AER for forwards
```{r}
#note needs midfield directly above code above
# forwards

#load in just forwards
players_min_starts.forwards = players_min_5_starts_summary_df[players_min_5_starts_summary_df$Position == 'F',]
#nrow(players_min_starts.forwards)

for_player_list <- players_min_starts.forwards$Player

length(for_player_list)
#[1] 71


#filter on fantrax forwards
fwds_min60_merged_df <- min60_merged_df[min60_merged_df$Position == "F",]

length(unique(fwds_min60_merged_df$Player))
#[1] 81



#remove the under 5 games players
fwds_min60_merged_df <- fwds_min60_merged_df[fwds_min60_merged_df$Player %in% for_player_list,]

dim(fwds_min60_merged_df)
#[1] 1314  125

length(unique(fwds_min60_merged_df$Player))
#[1] 71

#calculate xFpts for forwards
fwds_min60_merged_df$xPts <- fwds_min60_merged_df$FPts - (fwds_min60_merged_df$G * 9 + fwds_min60_merged_df$AT * 6)
fwds_min60_merged_df$xPts <- fwds_min60_merged_df$xPts + (as.numeric(fwds_min60_merged_df$xG)* 9 + as.numeric(fwds_min60_merged_df$xA) * 6)

#add possession data
fbref_pos_df <- read.csv(file="../data/fbref/premier_league/19_20/name_cleaned.possession_table.first_360_matches_game_week.csv")

fwds_min60_merged_df_posStats <- merge(fwds_min60_merged_df, fbref_pos_df, by=c('Player', 'game_week'))

dim(fwds_min60_merged_df_posStats )
#[1] 1314  155






#calculated AER_pct (percent won)
fwds_min60_merged_df_posStats$AER_prop <- fwds_min60_merged_df_posStats$AER / (fwds_min60_merged_df_posStats$AER + fwds_min60_merged_df_posStats$AERL)
#could lead to 0/0 so need to remove NaNs
fwds_min60_merged_df_posStats$AER_prop[is.nan(fwds_min60_merged_df_posStats$AER_prop)]<- 0

#filter on actual midfield positions
For_Pos <- c("FW","RW","LW")

fwds_min60_merged_df_posStats <- fwds_min60_merged_df_posStats[fwds_min60_merged_df_posStats$Pos.x %in% For_Pos,]

 summary_all_fwds_poss <- fwds_min60_merged_df_posStats %>% 
  group_by(Player) %>%
  summarize(n = n(), meanFpts = mean(FPts), meanxFpts = mean(xPts), sdxFpts = sd(xPts), meanxG = mean(xG), meanxA = mean(xA), meanAER = mean(AER), meanAERProp = mean(AER_prop), meanSoT = mean(SoT), meanSh = mean(Sh), meanAtt3rd = mean(Att.3rd), meanAttPen = mean(Att.Pen), meanDefPen = mean(Def.Pen))
 


#require that they played at least 5 games as a Forwards

 summary_all_fwds_poss_n5 <-  summary_all_fwds_poss[summary_all_fwds_poss$n >= 5,]

dim(summary_all_fwds_poss_n5)
#[1] 61 14

#plot it to take a look
ggplot(summary_all_fwds_poss_n5 , aes(y = meanSoT, x = meanAER, label = Player)) + geom_point(aes(colour = meanxFpts)) + scale_color_gradient(low="blue", high="red", ) + theme_minimal() + geom_text_repel()


ggplot( summary_all_fwds_poss_n5 , aes(y =  meanAER, x = meanAtt3rd, label = Player)) + geom_point(aes(colour = meanxFpts)) + scale_color_gradient(low="blue", high="red", ) + theme_minimal() + geom_text_repel()

cor.test( summary_all_fwds_poss_n5$meanAER,  summary_all_fwds_poss_n5$meanAtt3rd)

	'Pearsons product-moment correlation

data:  summary_all_fwds_poss_n5$meanAER and summary_all_fwds_poss_n5$meanAtt3rd
t = -2.8858, df = 59, p-value = 0.005446
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 -0.5544138 -0.1095779
sample estimates:
      cor 
-0.351694 '

ggplot( summary_all_fwds_poss_n5, aes(y =  meanAER, x = meanAttPen, label = Player)) + geom_point(aes(colour = meanxFpts)) + scale_color_gradient(low="blue", high="red", ) + theme_minimal()+ geom_text_repel()


cor.test( summary_all_fwds_poss_n5$meanAER,  summary_all_fwds_poss_n5$meanAttPen)

#ggplot(summary_all_fwds_poss_n5, aes(y =  meanAER, x = meanAttPen)) + geom_point(aes(colour = meanxFpts)) + scale_color_gradient(low="blue", high="red", ) + theme_minimal() + geom_text_repel(data = subset(summary_all_fwds_poss_n5,meanAER > 5 | meanAttPen > 7 ), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black")

#ggplot(summary_all_fwds_poss_n5, aes(y =  meanAER, x = meanSoT)) + geom_point(aes(colour = meanxFpts)) + scale_color_gradient(low="blue", high="red", ) + theme_minimal() + geom_text_repel(data = subset(summary_all_fwds_poss_n5,meanAER > 5 | meanSoT > 1.25 ), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black")


# xG v AER
ggbub <- ggplot(summary_all_fwds_poss_n5, aes(y =  meanAER, x = meanxG)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = 10 ) + theme_minimal() + geom_text_repel(data = subset(summary_all_fwds_poss_n5,meanAER > 5 | meanxG > 0.6 ), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black")

ggsave(filename="../xFpts_figures/FWD_xG_AER_sd.png", plot=ggbub)

# SoT v AER
ggbub <- ggplot(summary_all_fwds_poss_n5, aes(y =  meanAER, x = meanSoT)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = 10 ) + theme_minimal() + geom_text_repel(data = subset(summary_all_fwds_poss_n5,meanAER > 5 | meanSoT > 1.39 ), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black")

ggsave(filename="../xFpts_figures/FWD_SoT_AER_sd.png", plot=ggbub)

# Sh v AER
ggbub <- ggplot(summary_all_fwds_poss_n5, aes(y =  meanAER, x = meanSh)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = 10 ) + theme_minimal() + geom_text_repel(data = subset(summary_all_fwds_poss_n5,meanAER > 5 | meanSh > 3.25 ), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black")

ggsave(filename="../xFpts_figures/FWD_Sh_AER_sd.png", plot=ggbub)

# AttPen v AER
ggbub <- ggplot(summary_all_fwds_poss_n5, aes(y =  meanAER, x = meanAttPen)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = 10 ) + theme_minimal() + geom_text_repel(data = subset(summary_all_fwds_poss_n5,meanAER > 5 | meanAttPen > 6.5 ), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black")

ggsave(filename="../xFpts_figures/FWD_AttPen_AER_sd.png", plot=ggbub)

# xFpts v AER
ggbub <- ggplot(summary_all_fwds_poss_n5, aes(y =  meanAER, x = meanxFpts)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = 10 ) + theme_minimal() + geom_text_repel(data = subset(summary_all_fwds_poss_n5,meanAER > 5 | meanxFpts > 13 ), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black")

ggsave(filename="../xFpts_figures/FWD_xFpts_AER_sd.png", plot=ggbub)

	'Pearsons product-moment correlation

data:  summary_all_fwds_poss_n5$meanAER and summary_all_fwds_poss_n5$meanAttPen
t = -2.2464, df = 59, p-value = 0.02843
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 -0.49736696 -0.03107979
sample estimates:
       cor 
-0.2807036 '

ggplot( summary_all_fwds_poss_n5, aes(y =  meanAER, x = meanDefPen, label = Player)) + geom_point(aes(colour = meanxFpts)) + scale_color_gradient(low="blue", high="red", ) + theme_minimal() + geom_text_repel()

```

#AER proportion plots for all positions
```{r}

# xG v AERProp
ggplot(summary_all_fwds_poss_n5, aes(y =  meanAERProp, x = meanxG)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = 10 ) + theme_minimal() + geom_text_repel(data = subset(summary_all_fwds_poss_n5,meanAERProp > .5 | meanxG > 0.6 ), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black")

# SoT v AERProp
ggplot(summary_all_fwds_poss_n5, aes(y =  meanAERProp, x = meanSoT)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = 10 ) + theme_minimal() + geom_text_repel(data = subset(summary_all_fwds_poss_n5,meanAERProp > .49 | meanSoT > 1.39 ), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black")

# Sh v AERProp
ggplot(summary_all_fwds_poss_n5, aes(y =  meanAERProp, x = meanSh)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = 10 ) + theme_minimal() + geom_text_repel(data = subset(summary_all_fwds_poss_n5,meanAERProp > 0.5 | meanSh > 3.25 ), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black")


# AttPen v AERProp
ggplot(summary_all_fwds_poss_n5, aes(y =  meanAERProp, x = meanAttPen)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = 10 ) + theme_minimal() + geom_text_repel(data = subset(summary_all_fwds_poss_n5,meanAERProp > 0.49 | meanAttPen > 6.5 ), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black")

# xFpts v AERProp
ggplot(summary_all_fwds_poss_n5, aes(y =  meanAERProp, x = meanxFpts)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = 10 ) + theme_minimal() + geom_text_repel(data = subset(summary_all_fwds_poss_n5,meanAERProp > 0.5 | meanxFpts > 13 ), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black")

```

## Rerun AER analyses with whole season data
```{r}
#read in fantrax all 19-20 season data

min_starts_requirement <- 5
min_minutes_requirement <- 60

#load all player data for fbref.com
weekly_data_csv = "../data/fantrax_data/weekly.all_data_combined.no_double_gws.csv"
yearly_data_csv = "../data/fantrax_data/yearly.all_data_combined.csv"

weekly_data_df <- read_csv(file = weekly_data_csv, col_names = TRUE)
yearly_data_df <- read_csv(file = yearly_data_csv, col_names = TRUE)

# Only weeks where at least 60 minutes are played
min_minute_df <- weekly_data_df[weekly_data_df$Min >= min_minutes_requirement,]
# Players that have started at least 5 games
summary_min_minutes_df <- min_minute_df %>% 
  group_by(Player, Team, Position) %>%
  summarize(n = n(), min_total = sum(Min), sd = sd(FPts), mean = mean(FPts), total_fpts = sum(FPts), mean_minutes = mean(Min))

#only players with at least 5 starts
players_min_starts_summary_df <- summary_min_minutes_df[summary_min_minutes_df$n >= min_starts_requirement,]

player_min_starts_weekly_df <- min_minute_df %>%
  filter(Player %in% players_min_starts_summary_df$Player)
nrow(player_min_starts_weekly_df)


#### DEFENDERS xFPTS ####

# load in just defenders
players_min_starts.defenders = players_min_starts_summary_df[players_min_starts_summary_df$Position == 'D',]
nrow(players_min_starts.defenders)
def_player_list <- players_min_starts.defenders$Player
length(def_player_list)

#read in fbref_summary data
fbref_summ_df <- read_csv('../data/fbref/premier_league/19_20/name_cleaned.summary_table.first_360_matches_game_week.csv')

dim(fbref_summ_df)

#clean sheet data
cs_df <- read_csv('../data/fantrax_data/game_results.csv')

#merge on player and game week
min_minutes_weekly_merged_df <- merge(min_minute_df, fbref_summ_df, by=c('Player', 'game_week'))


#filter on fantrax defenders
defenders_min_minutes_merged_df <- min_minutes_weekly_merged_df[min_minutes_weekly_merged_df$Position == "D",]

sum(def_player_list %in% unique(defenders_min_minutes_merged_df$Player))
#[1] 138
#so they are all there

#negate %in%
`%!in%` = Negate(`%in%`)

#see which players are extra in this group
Players_defenders_min_minutes_merged_df<-unique(defenders_min_minutes_merged_df$Player)

Players_defenders_min_minutes_merged_df[Players_defenders_min_minutes_merged_df %!in% def_player_list]

#they are players who havent have 5 starts

#remove the under 5 games players
defenders_min_minutes_merged_df <- defenders_min_minutes_merged_df[defenders_min_minutes_merged_df$Player %in% def_player_list,]

dim(defenders_min_minutes_merged_df)
#[1] 2715  125

#just get the important stuff for clean sheets (name "Team.y" for easy merge in a sec)
all_cs_data_df <- data.frame('Team.y' = c(cs_df$Home, cs_df$Away), 'xG_against' = c(cs_df$xG_1, cs_df$xG), 'game_week' = c(cs_df$Wk, cs_df$Wk))

#convert squad to character all_cs_data_df for merge
all_cs_data_df$Team.y <- as.character(all_cs_data_df$Team.y)

#merge cs and defender data
defenders_min_minutes_merged_cs_df <- merge(defenders_min_minutes_merged_df, all_cs_data_df, by=c("Team.y", "game_week"))

dim(defenders_min_minutes_merged_cs_df)
#[1] 2715  126

#calculate xFpts from cs given xG against
defenders_min_minutes_merged_cs_df$GAD_against <- ifelse(defenders_min_minutes_merged_cs_df$xG_against - 0.25 < 0, 0, defenders_min_minutes_merged_cs_df$xG_against - 0.25)

defenders_min_minutes_merged_cs_df$xCS <- ifelse(defenders_min_minutes_merged_cs_df$GAD_against <= 1.25, 1 - defenders_min_minutes_merged_cs_df$GAD_against/1.25, 0)

#calculate xFpts for defenders
defenders_min_minutes_merged_cs_df$xPts <- defenders_min_minutes_merged_cs_df$FPts - (defenders_min_minutes_merged_cs_df$G * 10 + defenders_min_minutes_merged_cs_df$AT * 8 + defenders_min_minutes_merged_cs_df$CS * 6 + defenders_min_minutes_merged_cs_df$GAD * -2) + (as.numeric(defenders_min_minutes_merged_cs_df$xG)* 10 + as.numeric(defenders_min_minutes_merged_cs_df$xA) * 8 + as.numeric(defenders_min_minutes_merged_cs_df$xCS)* 6 + as.numeric(defenders_min_minutes_merged_cs_df$GAD_against) * -2)

#remove some extra defender columns
drops <- c("normed_xg_against","GAD_against", 'xG_against')
defenders_min_minutes_merged_cs_df <- defenders_min_minutes_merged_cs_df[ , !(names(defenders_min_minutes_merged_cs_df) %in% drops)]

#### MIDFIELDERS xFPTS ####

#load in just midfielders
players_min_starts.midfielders = players_min_starts_summary_df[players_min_starts_summary_df$Position == 'M',]
nrow(players_min_starts.midfielders)
mid_player_list <- players_min_starts.midfielders$Player

length(mid_player_list)

#filter on fantrax midfielders
mids_min_minutes_merged_df <- min_minutes_weekly_merged_df[min_minutes_weekly_merged_df$Position == "M",]

length(unique(mids_min_minutes_merged_df$Player))


sum(mid_player_list %in% unique(mids_min_minutes_merged_df$Player))

#remove the under 5 games players
mids_min_minutes_merged_df <- mids_min_minutes_merged_df[mids_min_minutes_merged_df$Player %in% mid_player_list,]

dim(mids_min_minutes_merged_df)
#[1] 2600  125


length(unique(mids_min_minutes_merged_df$Player))
#[1] 143

#calculate xFpts for midfielders
mids_min_minutes_merged_df$xPts <- mids_min_minutes_merged_df$FPts - (mids_min_minutes_merged_df$G * 9 + mids_min_minutes_merged_df$AT * 6)
mids_min_minutes_merged_df$xPts <- mids_min_minutes_merged_df$xPts + (as.numeric(mids_min_minutes_merged_df$xG)* 9 + as.numeric(mids_min_minutes_merged_df$xA) * 6)

#### FORWARDS xFPTS ####

#load in just forwards
players_min_starts.forwards = players_min_starts_summary_df[players_min_starts_summary_df$Position == 'F',]
nrow(players_min_starts.forwards)

for_player_list <- players_min_starts.forwards$Player

length(for_player_list)
#[1] 71


#filter on fantrax forwards
fwds_min_minutes_merged_df <- min_minutes_weekly_merged_df[min_minutes_weekly_merged_df$Position == "F",]

length(unique(fwds_min_minutes_merged_df$Player))
#[1] 81

sum(for_player_list %in% unique(fwds_min_minutes_merged_df$Player))

#remove the under min games players
fwds_min_minutes_merged_df <- fwds_min_minutes_merged_df[fwds_min_minutes_merged_df$Player %in% for_player_list,]

dim(fwds_min_minutes_merged_df)

length(unique(fwds_min_minutes_merged_df$Player))

#calculate xFpts for forwards
fwds_min_minutes_merged_df$xPts <- fwds_min_minutes_merged_df$FPts - (fwds_min_minutes_merged_df$G * 9 + fwds_min_minutes_merged_df$AT * 6)
fwds_min_minutes_merged_df$xPts <- fwds_min_minutes_merged_df$xPts + (as.numeric(fwds_min_minutes_merged_df$xG)* 9 + as.numeric(fwds_min_minutes_merged_df$xA) * 6)

# these are the fantrax dfs to use
#defenders_min_minutes_merged_cs_df, fwds_min_minutes_merged_df, mids_min_minutes_merged_df

```

#Merge Fantrax data with the fbref data
```{r}
#load data from the summary table
fbref_summ_df <- read.csv(file="../data/fbref/premier_league/19_20/name_cleaned.summary_table.game_week.csv")
#load data from the possession data
fbref_pos_df <- read.csv(file="../data/fbref/premier_league/19_20/name_cleaned.possession_table.game_week.csv")

#add it to the defenders
dim(defenders_min_minutes_merged_cs_df)
#[1] 2723  127

defenders_min_minutes_merged_cs_fbref_df <- merge(defenders_min_minutes_merged_cs_df, fbref_summ_df, by=c('Player', 'game_week'))

dim(defenders_min_minutes_merged_cs_fbref_df)
#[1] 2723  162

defenders_min_minutes_merged_cs_fbref_df <- merge(defenders_min_minutes_merged_cs_fbref_df, fbref_pos_df, by=c('Player', 'game_week'))

dim(defenders_min_minutes_merged_cs_fbref_df)
#[1] 2723  191

#make the Team_Pos field
defenders_min_minutes_merged_cs_fbref_df$Team_Pos <- paste(defenders_min_minutes_merged_cs_fbref_df$Team.x, defenders_min_minutes_merged_cs_fbref_df$Pos, sep = "_")

#remove duplicate columns (team, min, and opponent)
defenders_min_minutes_merged_cs_fbref_df <- defenders_min_minutes_merged_cs_fbref_df[, !duplicated(colnames(defenders_min_minutes_merged_cs_fbref_df))]

#add it to the midfielders
dim(mids_min_minutes_merged_df)
#[1] 2604  126

mids_min_minutes_merged_cs_fbref_df <- merge(mids_min_minutes_merged_df, fbref_summ_df, by=c('Player', 'game_week'))

dim(mids_min_minutes_merged_cs_fbref_df)
#[1] 2604  161

mids_min_minutes_merged_cs_fbref_df <- merge(mids_min_minutes_merged_cs_fbref_df, fbref_pos_df, by=c('Player', 'game_week'))

dim(mids_min_minutes_merged_cs_fbref_df)
#[1] 2604  190

#make the Team_Pos field
mids_min_minutes_merged_cs_fbref_df$Team_Pos <- paste(mids_min_minutes_merged_cs_fbref_df$Team.x, mids_min_minutes_merged_cs_fbref_df$Pos, sep = "_")

#remove duplicate columns (team, min, and opponent)
mids_min_minutes_merged_cs_fbref_df <- mids_min_minutes_merged_cs_fbref_df[, !duplicated(colnames(mids_min_minutes_merged_cs_fbref_df))]

#add it to the forwards
dim(fwds_min_minutes_merged_df)
#[1] 1318  126

fwds_min_minutes_merged_cs_fbref_df <- merge(fwds_min_minutes_merged_df, fbref_summ_df, by=c('Player', 'game_week'))

dim(fwds_min_minutes_merged_cs_fbref_df)
#[1] 1318  161

fwds_min_minutes_merged_cs_fbref_df <- merge(fwds_min_minutes_merged_cs_fbref_df, fbref_pos_df, by=c('Player', 'game_week'))

dim(fwds_min_minutes_merged_cs_fbref_df)
#[1] 1318  190

#make the Team_Pos field
fwds_min_minutes_merged_cs_fbref_df$Team_Pos <- paste(fwds_min_minutes_merged_cs_fbref_df$Team.x, fwds_min_minutes_merged_cs_fbref_df$Pos, sep = "_")

#remove duplicate columns (team, min, and opponent)
fwds_min_minutes_merged_cs_fbref_df <- fwds_min_minutes_merged_cs_fbref_df[, !duplicated(colnames(fwds_min_minutes_merged_cs_fbref_df))]

```

```{r}
#Macguire and Lindeloff

#MUN_CB
MUN_CB_data <- as.data.frame(defenders_min_minutes_merged_cs_fbref_df[defenders_min_minutes_merged_cs_fbref_df$Team_Pos == "MUN_CB",])

dim(MUN_CB_data)
#[1]  69 186

#get rid of Luke Shaw
MUN_CB_data <- MUN_CB_data[MUN_CB_data$Player != "Luke Shaw",]

ggbox <- ggplot(MUN_CB_data, aes(Player, xPts)) + geom_boxplot(aes(colour = Player), outlier.shape = NA) + geom_jitter(width = 0.2, aes(colour = MUN_CB_data$Player)) + theme_minimal() + theme(axis.text.x = element_text(angle = 45)) +ggtitle("xFpt for Manchester United CBs") + ylab("xFpts") + theme(plot.title = element_text(hjust = 0.5), text = element_text(size = 15)) 

ggsave(filename="../xFpts_figures/MUN_CBs_boxplot_08022020.png", plot=ggbox)


#look at the stats that are different between the two players

#loop through the statistics we have and see what is significantly different between the players
stat_vec <- names(MUN_CB_data)

#length of the stat_vec
n = length(stat_vec)

#initiate a vector to save the boolean of whether the Kruskal-Wallis test was significant for each stat
sigStatKWTestList <- vector(mode= "list", length= n)

#for each team position
for(s in 1:length(stat_vec)){
  
  print(stat_vec[s])
  print(s)
  
  #set stat_name
  stat_name <- stat_vec[s]
  
  #if this stat is not an int or a numeric vector (so a character vector) don't perform the stat test
  if(typeof(MUN_CB_data[[stat_name]]) == "character" ){
    
    bool_signif = FALSE
  
  #if all entries are the same don't run the test  
  } else if(length(unique(MUN_CB_data[[stat_name]])) == 1){
  
    bool_signif = FALSE
    
  } else {
  
  
  k_test <- kruskal.test(MUN_CB_data[[stat_name]] ~ Player, data = MUN_CB_data)
  print(k_test$p.value)

  #check if the Kruskal-Wallis test is close to bonferroni significant
  bool_signif <- k_test$p.value < 0.05
  
  }
  
  #write the team pos test significance to the list
  sigStatKWTestList[[s]] <- bool_signif
}

#make the list into a vector
sigStatKWTestList<- unlist(sigStatKWTestList)


#players seem to be distributed differently for these team distributions

stat_vec[sigStatKWTestList]
stat_vec[sigStatKWTestList]
# [1] "Rk"          "FPts"        "FP/G"        "KP"          "S"           "SOT"        
 #[7] "SA"          "FS"          "Off"         "SFTP"        "CF_1"        "Int.x"      
#[13] "DW"          "DL"          "AER"         "LB"          "LBA"         "#"          
#[19] "Sh.x"        "SoT.x"       "Int.y"       "xG.x"        "npxG.x"      "PrgDist.1.x"
#[25] "xPts"        "X..x"        "Nation.y"    "Sh.y"        "SoT.y"       "Int"        
#[31] "xG.y"        "npxG.y"      "PrgDist.1.y" "X..y"        "Nation"      "Def.Pen"    
#[37] "Att.3rd"     "Att.Pen"     "Succ."       "TotDist"     "PrgDist"     "Rec."

#make a summary for these fields
summary_MUN_CBs <- MUN_CB_data %>% 
  group_by(Player) %>%
  summarize(n = n(), meanFpts = mean(FPts), total_Fpts = sum(FPts), meanxFpts = mean(xPts), total_xFpts = sum(xPts),"Mean SOT" = mean(SOT), total_Shots = sum(S), "Mean xG" = mean(xG.x), "Mean INT" = mean(Int.x), "Mean AER" = mean(AER))

#summary_MUN_CBs_for_plot <- summary_MUN_CBs %>% gather(Stat_Name,Stat_Value, meanFpts,meanxFpts,meanSOT,meanxG,meanInts,meanAER)

summary_MUN_CBs_for_plot <- summary_MUN_CBs %>% gather(Stat_Name,Stat_Value,"Mean SOT","Mean xG","Mean INT","Mean AER")

#make a bar plot of these data
ggbar <- ggplot(summary_MUN_CBs_for_plot , aes(fill=Player, y=Stat_Value, x=Stat_Name)) + geom_bar(position="dodge", stat="identity") + theme_minimal() +ggtitle("Maguire and Lindelof Top Differences") + theme(plot.title = element_text(hjust = 0.5), text = element_text(size = 15)) + xlab("Statistics") + ylab("Value")

ggsave(filename="../xFpts_figures/MUN_CBs_barplot_08022020.png", plot=ggbar)

```


#Full season CB AER plots
```{r}

CB_data <- defenders_min_minutes_merged_cs_fbref_df[defenders_min_minutes_merged_cs_fbref_df$Pos.x == "CB",]

dim(CB_data)
#[1] 1403  186

#calculated AER_prop (prop won)
CB_data$AER_prop <- CB_data$AER / (CB_data$AER + CB_data$AERL)
#could lead to 0/0 so need to remove NaNs
CB_data$AER_prop[is.nan(CB_data$AER_prop)]<- 0

summary_CBs <- CB_data %>% 
  group_by(Player) %>%
  summarize(n = n(), meanFpts = mean(FPts), meanxFpts = mean(xPts), sdxFpts = sd(xPts), meanxG = mean(xG.x), meanxA = mean(xA.x), meanAER = mean(AER), meanAERProp = mean(AER_prop), meanSoT = mean(SoT.x), meanSh = mean(Sh.x), meanAtt3rd = mean(Att.3rd), meanAttPen = mean(Att.Pen), meanDefPen = mean(Def.Pen))

#require that they played at least 5 games as a CB

summary_CBs_n5 <- summary_CBs[summary_CBs$n >= 5,]

#plot it to take a look
# AttPen v AER
ggbub <- ggplot(summary_CBs_n5, aes(y =  meanAER, x = meanAttPen)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = mean(summary_CBs_n5$meanxFpts)) + theme_minimal() + geom_text_repel(data = subset(summary_CBs_n5,meanAER > 4.5 | meanAttPen > 1.5  | meanxFpts > 10), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black") +ggtitle("CB mean touches in the attacking penalty box vs mean aerials won") + theme(plot.title = element_text(hjust = 0.5), text = element_text(size = 12)) + labs(x="Mean touches in the attacking penalty box", y= "Mean aerials won", col = "Mean xFpts", size="SD xFpts")

ggsave(filename="../xFpts_figures/CB_AttPen_AER_sd_08022020.png", plot=ggbub)

# DefPen v AER
ggbub <- ggplot(summary_CBs_n5, aes(y =  meanAER, x = meanDefPen)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = mean(summary_CBs_n5$meanxFpts)) + theme_minimal() + geom_text_repel(data = subset(summary_CBs_n5,meanAER > 4.5 | meanDefPen > 12  | meanxFpts > 10), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black") +ggtitle("CB mean touches in the defensive penalty box vs mean aerials won") + theme(plot.title = element_text(hjust = 0.5), text = element_text(size = 12)) + labs(x="Mean touches in the defensive penalty box", y= "Mean aerials won", col = "Mean xFpts", size="SD xFpts")

ggsave(filename="../xFpts_figures/CB_DefPen_AER_sd_08022020.png", plot=ggbub)


# Sh v AER
ggbub <- ggplot(summary_CBs_n5, aes(y =  meanAER, x = meanSh)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = mean(summary_CBs_n5$meanxFpts)) + theme_minimal() + geom_text_repel(data = subset(summary_CBs_n5,meanAER > 4.5 | meanSh > 0.75  | meanxFpts > 10), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black") +ggtitle("CB mean shots vs mean aerials won") + theme(plot.title = element_text(hjust = 0.5), text = element_text(size = 12)) + labs(x="Mean shots", y= "Mean aerials won", col = "Mean xFpts", size="SD xFpts")

ggsave(filename="../xFpts_figures/CB_Sh_AER_sd_08022020.png", plot=ggbub)


# SoT v AER
ggbub <- ggplot(summary_CBs_n5, aes(y =  meanAER, x = meanSoT)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = mean(summary_CBs_n5$meanxFpts)) + theme_minimal() + geom_text_repel(data = subset(summary_CBs_n5,meanAER > 4.5 | meanSoT > 0.25  | meanxFpts > 10), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black") +ggtitle("CB mean shots on target vs mean aerials won") + theme(plot.title = element_text(hjust = 0.5), text = element_text(size = 12)) + labs(x="Mean shots on target", y= "Mean aerials won", col = "Mean xFpts", size="SD xFpts")

ggsave(filename="../xFpts_figures/CB_SoT_AER_sd_08022020.png", plot=ggbub)

# xG v AER
ggbub <- ggplot(summary_CBs_n5, aes(y =  meanAER, x = meanxG)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = mean(summary_CBs_n5$meanxFpts)) + theme_minimal() + geom_text_repel(data = subset(summary_CBs_n5,meanAER > 4.5 | meanxG > 0.1  | meanxFpts > 10), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black") +ggtitle("CB mean xG vs mean aerials won") + theme(plot.title = element_text(hjust = 0.5), text = element_text(size = 12)) + labs(x="Mean xG", y= "Mean aerials won", col = "Mean xFpts", size="SD xFpts")

ggsave(filename="../xFpts_figures/CB_xG_AER_sd_08022020.png", plot=ggbub)


# xA v AER
ggbub <- ggplot(summary_CBs_n5, aes(y =  meanAER, x = meanxA)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = mean(summary_CBs_n5$meanxFpts)) + theme_minimal() + geom_text_repel(data = subset(summary_CBs_n5,meanAER > 4.5 | meanxA > 0.06  | meanxFpts > 10), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black") +ggtitle("CB mean xA vs mean aerials won") + theme(plot.title = element_text(hjust = 0.5), text = element_text(size = 12)) + labs(x="Mean xA", y= "Mean aerials won", col = "Mean xFpts", size="SD xFpts")

ggsave(filename="../xFpts_figures/CB_xA_AER_sd_08022020.png", plot=ggbub)

# xFpts v AER
ggbub <- ggplot(summary_CBs_n5, aes(y =  meanAER, x = meanxFpts)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = mean(summary_CBs_n5$meanxFpts)) + theme_minimal() + geom_text_repel(data = subset(summary_CBs_n5,meanAER > 4.5  | meanxFpts > 10), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black") +ggtitle("CB mean xFpts vs mean aerials won") + theme(plot.title = element_text(hjust = 0.5), text = element_text(size = 12)) + labs(x="Mean xFpts", y= "Mean aerials won", col = "Mean xFpts", size="SD xFpts")

ggsave(filename="../xFpts_figures/CB_xFpts_AER_sd_08022020.png", plot=ggbub)

# AERProp v AER
ggbub <- ggplot(summary_CBs_n5, aes(y =  meanAER, x = meanAERProp)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = mean(summary_CBs_n5$meanxFpts)) + theme_minimal() + geom_text_repel(data = subset(summary_CBs_n5,meanAER > 4.5 | meanxFpts > 10), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black") +ggtitle("CB mean proportion of aerials won vs mean aerials won") + theme(plot.title = element_text(hjust = 0.5), text = element_text(size = 12)) + labs(x="Mean proportion of aerials won", y= "Mean aerials won", col = "Mean xFpts", size="SD xFpts")

ggsave(filename="../xFpts_figures/CB_AERProp_AER_sd_08022020.png", plot=ggbub)

```

#Full season OB AER plots
```{r}
OB_Pos <- c("WB","LB","RB")

OB_data <- defenders_min_minutes_merged_cs_fbref_df[defenders_min_minutes_merged_cs_fbref_df$Pos.x %in% OB_Pos,]

dim(OB_data)
#[1] 1101  186

#calculated AER_prop (prop won)
OB_data$AER_prop <- OB_data$AER / (OB_data$AER + OB_data$AERL)
#could lead to 0/0 so need to remove NaNs
OB_data$AER_prop[is.nan(OB_data$AER_prop)]<- 0

summary_OBs <- OB_data %>% 
  group_by(Player) %>%
  summarize(n = n(), meanFpts = mean(FPts), meanxFpts = mean(xPts), sdxFpts = sd(xPts), meanxG = mean(xG.x), meanxA = mean(xA.x), meanAER = mean(AER), meanAERProp = mean(AER_prop), meanSoT = mean(SoT.x), meanSh = mean(Sh.x), meanAtt3rd = mean(Att.3rd), meanAttPen = mean(Att.Pen), meanDefPen = mean(Def.Pen))

#require that they played at least 5 games as a OB

summary_OBs_n5 <- summary_OBs[summary_OBs$n >= 5,]

#plot it to take a look
# AttPen v AER
ggbub <- ggplot(summary_OBs_n5, aes(y =  meanAER, x = meanAttPen)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = mean(summary_OBs_n5$meanxFpts)) + theme_minimal() + geom_text_repel(data = subset(summary_OBs_n5,meanAER > 3 | meanAttPen > 2.5  | meanxFpts > 12), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black") +ggtitle("OB mean touches in the attacking penalty box vs mean aerials won") + theme(plot.title = element_text(hjust = 0.5), text = element_text(size = 12)) + labs(x="Mean touches in the attacking penalty box", y= "Mean aerials won", col = "Mean xFpts", size="SD xFpts")

ggsave(filename="../xFpts_figures/OB_AttPen_AER_sd_08022020.png", plot=ggbub)


# Sh v AER
ggbub <- ggplot(summary_OBs_n5, aes(y =  meanAER, x = meanSh)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = mean(summary_OBs_n5$meanxFpts)) + theme_minimal() + geom_text_repel(data = subset(summary_OBs_n5,meanAER > 3 | meanSh > 1  | meanxFpts > 12), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black") +ggtitle("OB mean shots vs mean aerials won") + theme(plot.title = element_text(hjust = 0.5), text = element_text(size = 12)) + labs(x="Mean shots", y= "Mean aerials won", col = "Mean xFpts", size="SD xFpts")

ggsave(filename="../xFpts_figures/OB_Sh_AER_sd_08022020.png", plot=ggbub)


# SoT v AER
ggbub <- ggplot(summary_OBs_n5, aes(y =  meanAER, x = meanSoT)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = mean(summary_OBs_n5$meanxFpts)) + theme_minimal() + geom_text_repel(data = subset(summary_OBs_n5,meanAER > 3 | meanSoT > 0.3  | meanxFpts > 12), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black") +ggtitle("OB mean shots on target vs mean aerials won") + theme(plot.title = element_text(hjust = 0.5), text = element_text(size = 12)) + labs(x="Mean shots on target", y= "Mean aerials won", col = "Mean xFpts", size="SD xFpts")

ggsave(filename="../xFpts_figures/OB_SoT_AER_sd_08022020.png", plot=ggbub)

# xG v AER
ggbub <- ggplot(summary_OBs_n5, aes(y =  meanAER, x = meanxG)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = mean(summary_OBs_n5$meanxFpts)) + theme_minimal() + geom_text_repel(data = subset(summary_OBs_n5,meanAER > 3 | meanxG > 0.075  | meanxFpts > 12), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black") +ggtitle("OB mean xG vs mean aerials won") + theme(plot.title = element_text(hjust = 0.5), text = element_text(size = 12)) + labs(x="Mean xG", y= "Mean aerials won", col = "Mean xFpts", size="SD xFpts")

ggsave(filename="../xFpts_figures/OB_xG_AER_sd_08022020.png", plot=ggbub)


# xA v AER
ggbub <- ggplot(summary_OBs_n5, aes(y =  meanAER, x = meanxA)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = mean(summary_OBs_n5$meanxFpts)) + theme_minimal() + geom_text_repel(data = subset(summary_OBs_n5,meanAER > 3 | meanxA > 0.15  | meanxFpts > 12), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black") +ggtitle("OB mean xA vs mean aerials won") + theme(plot.title = element_text(hjust = 0.5), text = element_text(size = 12)) + labs(x="Mean xA", y= "Mean aerials won", col = "Mean xFpts", size="SD xFpts")

ggsave(filename="../xFpts_figures/OB_xA_AER_sd_08022020.png", plot=ggbub)

# xFpts v AER
ggbub <- ggplot(summary_OBs_n5, aes(y =  meanAER, x = meanxFpts)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = mean(summary_OBs_n5$meanxFpts)) + theme_minimal() + geom_text_repel(data = subset(summary_OBs_n5,meanAER > 3  | meanxFpts > 12), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black") +ggtitle("OB mean xFpts vs mean aerials won") + theme(plot.title = element_text(hjust = 0.5), text = element_text(size = 12)) + labs(x="Mean xFpts", y= "Mean aerials won", col = "Mean xFpts", size="SD xFpts")

ggsave(filename="../xFpts_figures/OB_xFpts_AER_sd_08022020.png", plot=ggbub)

# AERProp v AER
ggbub <- ggplot(summary_OBs_n5, aes(y =  meanAER, x = meanAERProp)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = mean(summary_OBs_n5$meanxFpts)) + theme_minimal() + geom_text_repel(data = subset(summary_OBs_n5,meanAER > 3 | meanAERProp > 0.7 | meanxFpts > 12), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black") +ggtitle("OB mean proportion of aerials won vs mean aerials won") + theme(plot.title = element_text(hjust = 0.5), text = element_text(size = 12)) + labs(x="Mean proportion of aerials won", y= "Mean aerials won", col = "Mean xFpts", size="SD xFpts")

ggsave(filename="../xFpts_figures/OB_AERProp_AER_sd_08022020.png", plot=ggbub)

```


#Full season MIDS AER plots
```{r}
MID_Pos <- c("CM","LW","RW","DM","AM")

MID_data <- mids_min_minutes_merged_cs_fbref_df[mids_min_minutes_merged_cs_fbref_df$Pos.x %in% MID_Pos,]

dim(MID_data)
#[1] 2020  185

#calculated AER_prop (prop won)
MID_data$AER_prop <- MID_data$AER / (MID_data$AER + MID_data$AERL)
#could lead to 0/0 so need to remove NaNs
MID_data$AER_prop[is.nan(MID_data$AER_prop)]<- 0

summary_MIDs <- MID_data %>% 
  group_by(Player) %>%
  summarize(n = n(), meanFpts = mean(FPts), meanxFpts = mean(xPts), sdxFpts = sd(xPts), meanxG = mean(xG.x), meanxA = mean(xA.x), meanAER = mean(AER), meanAERProp = mean(AER_prop), meanSoT = mean(SoT.x), meanSh = mean(Sh.x), meanAtt3rd = mean(Att.3rd), meanAttPen = mean(Att.Pen), meanDefPen = mean(Def.Pen))

#require that they played at least 5 games as a MID

summary_MIDs_n5 <- summary_MIDs[summary_MIDs$n >= 5,]

#plot it to take a look
# AttPen v AER
ggbub <- ggplot(summary_MIDs_n5, aes(y =  meanAER, x = meanAttPen)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = mean(summary_MIDs_n5$meanxFpts)) + theme_minimal() + geom_text_repel(data = subset(summary_MIDs_n5,meanAER > 3 | meanAttPen > 4.8  | meanxFpts > 12), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black") +ggtitle("MID mean touches in the attacking penalty box vs mean aerials won") + theme(plot.title = element_text(hjust = 0.5), text = element_text(size = 13)) + labs(x="Mean touches in the attacking penalty box", y= "Mean aerials won", col = "Mean xFpts", size="SD xFpts")

ggsave(filename="../xFpts_figures/MID_AttPen_AER_sd_08022020.png", plot=ggbub)


# Sh v AER
ggbub <- ggplot(summary_MIDs_n5, aes(y =  meanAER, x = meanSh)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = mean(summary_MIDs_n5$meanxFpts)) + theme_minimal() + geom_text_repel(data = subset(summary_MIDs_n5,meanAER > 3 | meanSh > 2.5  | meanxFpts > 13), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black") +ggtitle("MID mean shots vs mean aerials won") + theme(plot.title = element_text(hjust = 0.5), text = element_text(size = 12)) + labs(x="Mean shots", y= "Mean aerials won", col = "Mean xFpts", size="SD xFpts")

ggsave(filename="../xFpts_figures/MID_Sh_AER_sd_08022020.png", plot=ggbub)


# SoT v AER
ggbub <- ggplot(summary_MIDs_n5, aes(y =  meanAER, x = meanSoT)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = mean(summary_MIDs_n5$meanxFpts)) + theme_minimal() + geom_text_repel(data = subset(summary_MIDs_n5,meanAER > 3 | meanSoT > 0.9  | meanxFpts > 13), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black") +ggtitle("MID mean shots on target vs mean aerials won") + theme(plot.title = element_text(hjust = 0.5), text = element_text(size = 12)) + labs(x="Mean shots on target", y= "Mean aerials won", col = "Mean xFpts", size="SD xFpts")

ggsave(filename="../xFpts_figures/MID_SoT_AER_sd_08022020.png", plot=ggbub)

# xG v AER
ggbub <- ggplot(summary_MIDs_n5, aes(y =  meanAER, x = meanxG)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = mean(summary_MIDs_n5$meanxFpts)) + theme_minimal() + geom_text_repel(data = subset(summary_MIDs_n5,meanAER > 3 | meanxG > 0.3  | meanxFpts > 13), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black") +ggtitle("MID mean xG vs mean aerials won") + theme(plot.title = element_text(hjust = 0.5), text = element_text(size = 12)) + labs(x="Mean xG", y= "Mean aerials won", col = "Mean xFpts", size="SD xFpts")

ggsave(filename="../xFpts_figures/MID_xG_AER_sd_08022020.png", plot=ggbub)


# xA v AER
ggbub <- ggplot(summary_MIDs_n5, aes(y =  meanAER, x = meanxA)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = mean(summary_MIDs_n5$meanxFpts)) + theme_minimal() + geom_text_repel(data = subset(summary_MIDs_n5,meanAER > 3 | meanxA > 0.25  | meanxFpts > 13), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black") +ggtitle("MID mean xA vs mean aerials won") + theme(plot.title = element_text(hjust = 0.5), text = element_text(size = 12)) + labs(x="Mean xA", y= "Mean aerials won", col = "Mean xFpts", size="SD xFpts")

ggsave(filename="../xFpts_figures/MID_xA_AER_sd_08022020.png", plot=ggbub)

# xFpts v AER
ggbub <- ggplot(summary_MIDs_n5, aes(y =  meanAER, x = meanxFpts)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = mean(summary_MIDs_n5$meanxFpts)) + theme_minimal() + geom_text_repel(data = subset(summary_MIDs_n5,meanAER > 3  | meanxFpts > 13), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black") +ggtitle("MID mean xFpts vs mean aerials won") + theme(plot.title = element_text(hjust = 0.5), text = element_text(size = 12)) + labs(x="Mean xFpts", y= "Mean aerials won", col = "Mean xFpts", size="SD xFpts")

ggsave(filename="../xFpts_figures/MID_xFpts_AER_sd_08022020.png", plot=ggbub)

# AERProp v AER
ggbub <- ggplot(summary_MIDs_n5, aes(y =  meanAER, x = meanAERProp)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = mean(summary_MIDs_n5$meanxFpts)) + theme_minimal() + geom_text_repel(data = subset(summary_MIDs_n5,meanAER > 3 | meanAERProp > 0.7 | meanxFpts > 12), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black") +ggtitle("MID mean proportion of aerials won vs mean aerials won") + theme(plot.title = element_text(hjust = 0.5), text = element_text(size = 15)) + labs(x="Mean proportion of aerials won", y= "Mean aerials won", col = "Mean xFpts", size="SD xFpts")

ggsave(filename="../xFpts_figures/MID_AERProp_AER_sd_08022020.png", plot=ggbub)

```

#Full season FWDs AER plots
```{r}
FWD_Pos <- c("FW","LW","RW")

FWD_data <- fwds_min_minutes_merged_cs_fbref_df[fwds_min_minutes_merged_cs_fbref_df$Pos.x %in% FWD_Pos,]

dim(FWD_data)
#[1] 998  185

#calculated AER_prop (prop won)
FWD_data$AER_prop <- FWD_data$AER / (FWD_data$AER + FWD_data$AERL)
#could lead to 0/0 so need to remove NaNs
FWD_data$AER_prop[is.nan(FWD_data$AER_prop)]<- 0

summary_FWDs <- FWD_data %>% 
  group_by(Player) %>%
  summarize(n = n(), meanFpts = mean(FPts), meanxFpts = mean(xPts), sdxFpts = sd(xPts), meanxG = mean(xG.x), meanxA = mean(xA.x), meanAER = mean(AER), meanAERProp = mean(AER_prop), meanSoT = mean(SoT.x), meanSh = mean(Sh.x), meanAtt3rd = mean(Att.3rd), meanAttPen = mean(Att.Pen), meanDefPen = mean(Def.Pen))

#require that they played at least 5 games as a FWD

summary_FWDs_n5 <- summary_FWDs[summary_FWDs$n >= 5,]

#plot it to take a look
# AttPen v AER
ggbub <- ggplot(summary_FWDs_n5, aes(y =  meanAER, x = meanAttPen)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = mean(summary_FWDs_n5$meanxFpts)) + theme_minimal() + geom_text_repel(data = subset(summary_FWDs_n5,meanAER > 5 | meanAttPen > 7  | meanxFpts > 15), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black") +ggtitle("FWD mean touches in the attacking penalty box vs mean aerials won") + theme(plot.title = element_text(hjust = 0.5), text = element_text(size = 13)) + labs(x="Mean touches in the attacking penalty box", y= "Mean aerials won", col = "Mean xFpts", size="SD xFpts")

ggsave(filename="../xFpts_figures/FWD_AttPen_AER_sd_08022020.png", plot=ggbub)


# Sh v AER
ggbub <- ggplot(summary_FWDs_n5, aes(y =  meanAER, x = meanSh)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = mean(summary_FWDs_n5$meanxFpts)) + theme_minimal() + geom_text_repel(data = subset(summary_FWDs_n5,meanAER > 5 | meanSh > 2.9  | meanxFpts > 13), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black") +ggtitle("FWD mean shots vs mean aerials won") + theme(plot.title = element_text(hjust = 0.5), text = element_text(size = 12)) + labs(x="Mean shots", y= "Mean aerials won", col = "Mean xFpts", size="SD xFpts")

ggsave(filename="../xFpts_figures/FWD_Sh_AER_sd_08022020.png", plot=ggbub)


# SoT v AER
ggbub <- ggplot(summary_FWDs_n5, aes(y =  meanAER, x = meanSoT)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = mean(summary_FWDs_n5$meanxFpts)) + theme_minimal() + geom_text_repel(data = subset(summary_FWDs_n5,meanAER > 5 | meanSoT > 1.25  | meanxFpts > 13), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black") +ggtitle("FWD mean shots on target vs mean aerials won") + theme(plot.title = element_text(hjust = 0.5), text = element_text(size = 12)) + labs(x="Mean shots on target", y= "Mean aerials won", col = "Mean xFpts", size="SD xFpts")

ggsave(filename="../xFpts_figures/FWD_SoT_AER_sd_08022020.png", plot=ggbub)

# xG v AER
ggbub <- ggplot(summary_FWDs_n5, aes(y =  meanAER, x = meanxG)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = mean(summary_FWDs_n5$meanxFpts)) + theme_minimal() + geom_text_repel(data = subset(summary_FWDs_n5,meanAER > 5 | meanxG > 0.5 | meanxFpts > 13), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black") +ggtitle("FWD mean xG vs mean aerials won") + theme(plot.title = element_text(hjust = 0.5), text = element_text(size = 12)) + labs(x="Mean xG", y= "Mean aerials won", col = "Mean xFpts", size="SD xFpts")

ggsave(filename="../xFpts_figures/FWD_xG_AER_sd_08022020.png", plot=ggbub)


# xA v AER
ggbub <- ggplot(summary_FWDs_n5, aes(y =  meanAER, x = meanxA)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = mean(summary_FWDs_n5$meanxFpts)) + theme_minimal() + geom_text_repel(data = subset(summary_FWDs_n5,meanAER > 5 | meanxA > 0.2  | meanxFpts > 13), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black") +ggtitle("FWD mean xA vs mean aerials won") + theme(plot.title = element_text(hjust = 0.5), text = element_text(size = 12)) + labs(x="Mean xA", y= "Mean aerials won", col = "Mean xFpts", size="SD xFpts")

ggsave(filename="../xFpts_figures/FWD_xA_AER_sd_08022020.png", plot=ggbub)

# xFpts v AER
ggbub <- ggplot(summary_FWDs_n5, aes(y =  meanAER, x = meanxFpts)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = mean(summary_FWDs_n5$meanxFpts)) + theme_minimal() + geom_text_repel(data = subset(summary_FWDs_n5,meanAER > 5  | meanxFpts > 13), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black") +ggtitle("FWD mean xFpts vs mean aerials won") + theme(plot.title = element_text(hjust = 0.5), text = element_text(size = 12)) + labs(x="Mean xFpts", y= "Mean aerials won", col = "Mean xFpts", size="SD xFpts")

ggsave(filename="../xFpts_figures/FWD_xFpts_AER_sd_08022020.png", plot=ggbub)

# AERProp v AER
ggbub <- ggplot(summary_FWDs_n5, aes(y =  meanAER, x = meanAERProp)) + geom_point(aes(colour = meanxFpts, size = sdxFpts)) + scale_color_gradient2(low="blue", mid ="yellow", high="red", midpoint = mean(summary_FWDs_n5$meanxFpts)) + theme_minimal() + geom_text_repel(data = subset(summary_FWDs_n5,meanAER > 5 | meanAERProp > 0.5 | meanxFpts > 15), aes(label = Player)) + geom_smooth(method = "lm", se = FALSE, colour = "black") +ggtitle("FWD mean proportion of aerials won vs mean aerials won") + theme(plot.title = element_text(hjust = 0.5), text = element_text(size = 13)) + labs(x="Mean proportion of aerials won", y= "Mean aerials won", col = "Mean xFpts", size="SD xFpts")

ggsave(filename="../xFpts_figures/FWD_AERProp_AER_sd_08022020.png", plot=ggbub)

```
